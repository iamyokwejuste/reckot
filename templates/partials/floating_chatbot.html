{% load i18n static %}

{% if user.is_authenticated and user.ai_features_enabled %}
<div id="floating-chatbot" data-controller="chatbot">
    <button data-action="click->chatbot#toggle"
            data-chatbot-trigger
            data-walkthrough="chat-button"
            style="position: fixed !important; bottom: 1.5rem !important; right: 1.5rem !important;"
            class="z-[60] h-14 w-14 sm:h-16 sm:w-16 rounded-full shadow-2xl hover:scale-110 transition-all duration-300 flex items-center justify-center group bg-background border-2 border-border"
            aria-label="{% trans 'Reckot Assistant - Powered by Gemini' %}">
        <i data-lucide="bot" class="h-6 w-6 sm:h-7 sm:w-7 text-foreground"></i>
        <span class="absolute -top-1 -right-1 flex h-4 w-4 sm:h-5 sm:w-5">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
            <span class="relative inline-flex rounded-full h-4 w-4 sm:h-5 sm:w-5 bg-primary border-2 border-background"></span>
        </span>
    </button>

    <div id="floating-chatbot-container"
         data-chatbot-target="container"
         class="hidden fixed top-[60px] left-0 right-0 bottom-0 z-[70] bg-card flex flex-col
                sm:inset-auto sm:bottom-6 sm:right-6 sm:w-[33vw] sm:rounded-2xl sm:border sm:border-border sm:shadow-2xl"
         style="overflow: hidden !important;">

        <div data-walkthrough="chat-header" class="flex items-center justify-between py-2.5 px-3 sm:px-4 border-b border-border bg-primary sm:rounded-t-2xl flex-shrink-0">
            <div class="flex items-center gap-2 sm:gap-3">
                <div class="h-9 w-9 sm:h-10 sm:w-10 rounded-full backdrop-blur flex items-center justify-center bg-primary-foreground/20 flex-shrink-0">
                    <i data-lucide="bot" class="h-5 w-5 text-primary-foreground"></i>
                </div>
                <div class="flex flex-col -space-y-0.5">
                    <h3 class="font-semibold text-primary-foreground text-sm sm:text-base">{% trans "Reckot Assistant" %}</h3>
                    <p class="text-[10px] sm:text-xs text-primary-foreground/80">{% trans "Powered by Gemini" %}</p>
                </div>
            </div>
            <div class="flex items-center gap-1.5 sm:gap-2">
                <button data-action="click->chatbot#clearChat"
                        class="h-9 w-9 sm:h-8 sm:w-8 rounded-lg hover:bg-primary-foreground/20 active:bg-primary-foreground/30 transition-colors flex items-center justify-center"
                        title="{% trans 'Clear chat' %}">
                    <i data-lucide="trash-2" class="h-4 w-4 sm:h-4 sm:w-4 text-primary-foreground"></i>
                </button>
                <button data-action="click->chatbot#close"
                        class="h-9 w-9 sm:h-8 sm:w-8 rounded-lg hover:bg-primary-foreground/20 active:bg-primary-foreground/30 transition-colors flex items-center justify-center"
                        aria-label="{% trans 'Close' %}">
                    <i data-lucide="x" class="h-5 w-5 text-primary-foreground"></i>
                </button>
            </div>
        </div>

        <div data-chatbot-target="messages" class="flex-1 min-h-0 p-4 space-y-3 bg-muted/20" style="overflow-y: auto !important; max-height: 100% !important;">
        </div>

        <div class="p-3 sm:p-4 border-t border-border bg-background flex-shrink-0">
            <div class="flex items-center gap-2">
                <input type="text"
                       data-chatbot-target="input"
                       data-walkthrough="chat-input"
                       placeholder="{% trans 'Type your message...' %}"
                       class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 text-sm rounded-xl border border-border bg-card focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                       maxlength="500"
                       autocomplete="off"
                       data-action="keydown->chatbot#handleEnter keydown.escape->chatbot#close input->chatbot#updateSendButton">
                <button type="button"
                        data-chatbot-target="voiceButton"
                        data-walkthrough="voice-input"
                        data-action="click->chatbot#toggleVoiceInput"
                        class="shrink-0 w-10 h-10 rounded-xl flex items-center justify-center transition-all hover:scale-105 active:scale-95 bg-muted hover:bg-muted/80 text-foreground"
                        title="{% trans 'Voice input' %}">
                    <i data-lucide="mic" class="w-5 h-5"></i>
                </button>
                <button type="button"
                        data-chatbot-target="sendButton"
                        data-action="click->chatbot#sendMessage"
                        class="shrink-0 w-10 h-10 rounded-xl bg-primary text-primary-foreground flex items-center justify-center transition-all hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 shadow-md">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
            <p class="text-[10px] text-muted-foreground mt-2 text-center opacity-60">
                {% trans "Powered by Google Gemini" %}
            </p>
        </div>
    </div>
</div>
{% endif %}
