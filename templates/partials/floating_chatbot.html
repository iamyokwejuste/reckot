{% load i18n static %}

<div id="floating-chatbot" x-data="chatbot()">
    <button @click="toggle()"
            style="position: fixed !important; bottom: 1.5rem !important; right: 1.5rem !important;"
            class="z-[60] h-14 w-14 sm:h-16 sm:w-16 rounded-full shadow-2xl hover:scale-110 transition-all duration-300 flex items-center justify-center group bg-background border-2 border-border"
            x-show="!isOpen"
            aria-label="{% trans 'Reckot Assistant - Powered by Gemini' %}">
        <i data-lucide="bot" class="h-6 w-6 sm:h-7 sm:w-7 text-foreground"></i>
        <span class="absolute -top-1 -right-1 flex h-4 w-4 sm:h-5 sm:w-5">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
            <span class="relative inline-flex rounded-full h-4 w-4 sm:h-5 sm:w-5 bg-primary border-2 border-background"></span>
        </span>
    </button>

    <div x-show="isOpen"
         class="fixed inset-0 z-[70] bg-card flex flex-col
                sm:inset-auto sm:bottom-6 sm:right-6 sm:w-[33vw] sm:rounded-2xl sm:border sm:border-border sm:shadow-2xl"
         style="overflow: hidden !important; height: 100% !important;">

         <style>
            @media (min-width: 640px) {
                #floating-chatbot > div[x-show] {
                    height: 60vh !important;
                    max-height: 60vh !important;
                }
            }
         </style>

        <div class="flex items-center justify-between p-4 border-b border-border bg-gradient-to-br from-primary to-primary/90 rounded-t-2xl flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-full backdrop-blur flex items-center justify-center bg-primary/20">
                    <i data-lucide="bot" class="h-5 w-5 text-white"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-white">{% trans "Reckot Assistant" %}</h3>
                    <p class="text-xs text-white/80">{% trans "Powered by Gemini" %}</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button @click="clearChat()"
                        class="h-8 w-8 rounded-lg hover:bg-white/20 transition-colors flex items-center justify-center"
                        title="{% trans 'Clear chat' %}">
                    <i data-lucide="trash-2" class="h-4 w-4 text-white"></i>
                </button>
                <button @click="close()"
                        class="h-8 w-8 rounded-lg hover:bg-white/20 transition-colors flex items-center justify-center"
                        aria-label="{% trans 'Close' %}">
                    <i data-lucide="x" class="h-5 w-5 text-white"></i>
                </button>
            </div>
        </div>

        <div x-ref="messages" class="flex-1 min-h-0 p-4 space-y-3 bg-muted/20" style="overflow-y: auto !important; max-height: 100% !important;">
            <template x-for="msg in messages" :key="msg.id">
                <div :class="msg.role === 'USER' ? 'flex justify-end' : 'flex justify-start'">
                    <div :class="msg.role === 'USER'
                        ? 'bg-gradient-to-br from-primary to-primary/90 text-white rounded-2xl rounded-br-md px-4 py-2.5 max-w-[85%] shadow-md'
                        : 'bg-card border border-border rounded-2xl rounded-bl-md px-4 py-2.5 max-w-[85%] shadow-sm'">
                        <div class="text-sm break-words" x-html="formatMessage(msg.content)"></div>
                    </div>
                </div>
            </template>

            <template x-if="isLoading">
                <div class="flex justify-start">
                    <div class="bg-card border border-border rounded-2xl rounded-bl-md px-4 py-3 shadow-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 bg-primary rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                </div>
            </template>

            <template x-if="messages.length === 1">
                <div class="space-y-2">
                    <p class="text-xs text-muted-foreground text-center">{% trans "Quick actions:" %}</p>
                    <div class="flex flex-wrap gap-2">
                        <button @click="sendMessage('How do I create an event?')"
                                class="text-xs px-3 py-1.5 rounded-full bg-background border hover:bg-accent transition-colors">
                            {% trans "Create event" %}
                        </button>
                        <button @click="sendMessage('I have a payment issue')"
                                class="text-xs px-3 py-1.5 rounded-full bg-background border hover:bg-accent transition-colors">
                            {% trans "Payment help" %}
                        </button>
                        <button @click="sendMessage('How do I check in attendees?')"
                                class="text-xs px-3 py-1.5 rounded-full bg-background border hover:bg-accent transition-colors">
                            {% trans "Check-in" %}
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <div class="p-4 border-t border-border bg-card rounded-sm flex-shrink-0">
            <div class="flex gap-2">
                <input type="text"
                       x-model="inputMessage"
                       placeholder="{% trans 'Type your message...' %}"
                       class="input flex-1 text-sm"
                       :disabled="isLoading"
                       maxlength="500"
                       @keydown.enter="sendMessage()"
                       @keydown.escape="close()">
                <button type="button"
                        @click="sendMessage()"
                        class="btn btn-default px-2.5 py-2 shrink-0 rounded-lg"
                        :disabled="isLoading || !inputMessage.trim()">
                    <i data-lucide="send" class="h-3.5 w-3.5"></i>
                </button>
            </div>
            <p class="text-[10px] text-muted-foreground mt-2 text-center">
                {% trans "Powered by Google Gemini" %}
            </p>
        </div>
    </div>
</div>
