{% load static %}

<script src="https://unpkg.com/htmx.org@1.9.12/dist/htmx.min.js"></script>
<script defer src="https://unpkg.com/@alpinejs/collapse@3.14.8/dist/cdn.min.js"></script>
<script defer src="https://unpkg.com/@alpinejs/intersect@3.14.8/dist/cdn.min.js"></script>
<script defer src="{% static 'js/alpine-components.js' %}"></script>
<script defer src="https://unpkg.com/alpinejs@3.14.8/dist/cdn.min.js"></script>
<script defer src="{% static 'js/chatbot.js' %}"></script>
<script defer src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>

{% if use_motion %}
<script src="https://unpkg.com/motion@10.18.0/dist/motion.min.js"></script>
{% endif %}

{% if is_dashboard %}
<script defer src="{% static 'js/offline.js' %}"></script>
<script defer src="{% static 'js/components.js' %}"></script>
{% endif %}

<script>
(function() {
    'use strict';

    const ReckotApp = {
        alpineComponents: {},

        init() {
            this.setupAlpineRegistry();
            this.setupEventListeners();
        },

        setupAlpineRegistry() {
            window.registerAlpineComponent = (name, componentFactory) => {
                if (this.alpineComponents[name]) {
                    return;
                }

                this.alpineComponents[name] = componentFactory;

                if (typeof Alpine !== 'undefined') {
                    try {
                        Alpine.data(name, componentFactory);
                    } catch (error) {
                        console.error(`Failed to register Alpine component: ${name}`, error);
                    }
                } else {
                    setTimeout(() => this.registerPendingComponents(), 50);
                }
            };
        },

        registerPendingComponents() {
            if (typeof Alpine === 'undefined') {
                setTimeout(() => this.registerPendingComponents(), 50);
                return;
            }

            Object.entries(this.alpineComponents).forEach(([name, factory]) => {
                try {
                    Alpine.data(name, factory);
                } catch (error) {
                    console.error(`Failed to register Alpine component: ${name}`, error);
                }
            });
        },

        setupEventListeners() {
            document.addEventListener('DOMContentLoaded', () => this.onDOMReady());
            document.addEventListener('htmx:beforeRequest', () => this.onHTMXBeforeRequest());
            document.addEventListener('htmx:afterSwap', (evt) => this.onHTMXSwap(evt));
            document.addEventListener('htmx:afterSettle', (evt) => this.onHTMXAfterSettle(evt));
        },

        onHTMXBeforeRequest() {
            const loader = document.getElementById('page-loader');
            if (loader && loader.style.display === 'none') {
                loader.style.display = 'flex';
                loader.style.opacity = '1';
            }
        },

        onDOMReady() {
            this.initializeLucide();
            this.notifyReady();
        },

        notifyReady() {
            if (typeof Alpine !== 'undefined' && Alpine.version) {
                document.dispatchEvent(new CustomEvent('app:ready'));
            } else {
                setTimeout(() => this.notifyReady(), 50);
            }
        },

        onHTMXSwap(evt) {
            const target = evt.detail.target;

            this.executeInlineScripts(target);

            requestAnimationFrame(() => {
                this.initializeAlpine(target);
                this.initializeLucide();
            });
        },

        onHTMXAfterSettle(evt) {
            requestAnimationFrame(() => {
                this.initializeLucide();
                this.hideLoader();
            });
        },

        hideLoader() {
            const loader = document.getElementById('page-loader');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 300);
            }
        },

        executeInlineScripts(container) {
            const scripts = container.querySelectorAll('script');
            scripts.forEach(oldScript => {
                if (oldScript.src) return;

                const newScript = document.createElement('script');
                newScript.textContent = oldScript.textContent;

                Array.from(oldScript.attributes).forEach(attr => {
                    newScript.setAttribute(attr.name, attr.value);
                });

                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        },

        initializeAlpine(container) {
            if (typeof Alpine === 'undefined') return;

            const elements = container.querySelectorAll('[x-data]');
            elements.forEach(el => {
                if (!el._x_dataStack) {
                    try {
                        Alpine.initTree(el);
                    } catch (error) {
                        console.error('Alpine initialization error:', error);
                    }
                }
            });
        },

        initializeLucide() {
            if (typeof lucide !== 'undefined') {
                try {
                    lucide.createIcons();
                } catch (error) {
                    console.error('Lucide initialization error:', error);
                }
            }
        }
    };

    ReckotApp.init();

    document.addEventListener('showToast', (e) => {
        const { type, message } = e.detail;
        showToast(type, message);
    });

    window.showToast = function(type, message) {
        const container = document.getElementById('toast-container') || createToastContainer();
        const toast = document.createElement('div');
        toast.className = 'pointer-events-auto rounded-lg border shadow-lg p-4 flex items-start gap-3 transition-all duration-300 transform translate-x-4 opacity-0';

        const colors = {
            success: 'bg-emerald-500/10 border-emerald-500/20 text-emerald-700 dark:text-emerald-400',
            warning: 'bg-amber-500/10 border-amber-500/20 text-amber-700 dark:text-amber-400',
            error: 'bg-red-500/10 border-red-500/20 text-red-700 dark:text-red-400',
            info: 'bg-card border-border'
        };

        const icons = {
            success: 'check-circle',
            warning: 'alert-triangle',
            error: 'x-circle',
            info: 'info'
        };

        toast.classList.add(...(colors[type] || colors.info).split(' '));
        toast.innerHTML = `
            <i data-lucide="${icons[type] || icons.info}" class="h-5 w-5 shrink-0 mt-0.5"></i>
            <p class="text-sm flex-1">${message}</p>
            <button onclick="this.parentElement.remove()" class="shrink-0 -mr-1 -mt-1 p-1 rounded hover:bg-black/5 dark:hover:bg-white/10">
                <i data-lucide="x" class="h-4 w-4"></i>
            </button>
        `;

        container.appendChild(toast);
        if (typeof lucide !== 'undefined') lucide.createIcons();

        requestAnimationFrame(() => {
            toast.classList.remove('translate-x-4', 'opacity-0');
        });

        setTimeout(() => {
            toast.classList.add('translate-x-4', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    };

    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'fixed bottom-4 right-4 z-[100] flex flex-col gap-2 max-w-sm w-full pointer-events-none';
        document.body.appendChild(container);
        return container;
    }
})();
</script>
