<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
(function() {
    function initDatepickers(container = document) {
        container.querySelectorAll('[data-datepicker]:not([data-datepicker-initialized])').forEach(function(el) {
            if (el._flatpickrInitialized) {
                return;
            }
            el._flatpickrInitialized = true;
            el.setAttribute('data-datepicker-initialized', 'true');

            if (el._flatpickr) {
                try {
                    el._flatpickr.destroy();
                } catch(e) {}
            }

            const enableTime = el.dataset.enableTime === 'true';
            const time24hr = el.dataset.time24hr === 'true';
            const minDate = el.dataset.minDate || null;
            const maxDate = el.dataset.maxDate || null;
            const existingValue = el.value || null;

            const config = {
                dateFormat: enableTime ? "Y-m-d H:i" : "Y-m-d",
                altInput: true,
                altFormat: enableTime ? "F j, Y \\a\\t h:i K" : "F j, Y",
                altInputClass: "input w-full pl-12 cursor-pointer",
                enableTime: enableTime,
                time_24hr: time24hr,
                minuteIncrement: enableTime ? 15 : 1,
                disableMobile: false,
                wrap: false,
                allowInput: false,
                clickOpens: true,
            };

            if (existingValue) {
                config.defaultDate = existingValue;
            }

            if (minDate) {
                if (minDate === 'today') {
                    config.minDate = 'today';
                } else {
                    config.minDate = new Date(minDate);
                }
            }

            if (maxDate) {
                config.maxDate = new Date(maxDate);
            }

            try {
                flatpickr(el, config);
            } catch(e) {
                el._flatpickrInitialized = false;
                el.removeAttribute('data-datepicker-initialized');
            }
        });

        requestAnimationFrame(() => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => initDatepickers());
    } else {
        initDatepickers();
    }

    document.addEventListener('htmx:afterSwap', (event) => {
        initDatepickers(event.detail.target);
    });

    if (typeof MutationObserver !== 'undefined') {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                        if (node.hasAttribute && node.hasAttribute('data-datepicker')) {
                            initDatepickers(node.parentElement);
                        } else if (node.querySelectorAll) {
                            initDatepickers(node);
                        }
                    }
                });
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    window.initDatepickers = initDatepickers;
})();
</script>
