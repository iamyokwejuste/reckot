{% extends "base.html" %}
{% load slippers %}
{% load i18n %}

{% block title %}{% trans "Select Payment Method" %} - Reckot{% endblock %}

{% block content %}
<div class="container py-8">
    {% #breadcrumb %}
        {% #breadcrumb_item href="/" %}{% trans "Home" %}{% /breadcrumb_item %}
        {% #breadcrumb_separator %}{% /breadcrumb_separator %}
        {% #breadcrumb_item href="/events/" %}{% trans "Events" %}{% /breadcrumb_item %}
        {% #breadcrumb_separator %}{% /breadcrumb_separator %}
        {% #breadcrumb_item %}{% trans "Payment" %}{% /breadcrumb_item %}
    {% /breadcrumb %}

    <div class="mx-auto mt-8 max-w-6xl" data-animate="scale-in">
        {% #card class="shadow-xl" %}
            <div class="text-center mb-6">
                <div class="inline-flex h-14 w-14 items-center justify-center rounded-2xl bg-gradient-animated mb-4">
                    <i data-lucide="credit-card" class="h-7 w-7 text-white"></i>
                </div>
                <h1 class="text-2xl font-bold">{% trans "Complete Payment" %}</h1>
                <p class="text-sm text-muted-foreground mt-1">
                    {% trans "Select your preferred payment method" %}
                </p>
            </div>

            <div id="payment-panel">
                <form
                    hx-post="{% url 'payments:start' booking_ref=booking.reference %}"
                    hx-target="#payment-panel"
                    hx-swap="innerHTML"
                    class="grid grid-cols-1 lg:grid-cols-2 gap-6"
                    data-controller="toggle"
                    data-toggle-initial-value="CAMPAY"
                >
                    {% csrf_token %}

                    <div class="space-y-6">
                    <div class="space-y-3">
                        <p class="text-sm font-medium">{% trans "Payment Method" %}</p>
                        <div class="grid gap-3">
                            <label class="flex cursor-pointer items-center space-x-3 rounded-xl border-2 border-input p-4 hover:bg-accent hover:border-primary/30 transition-all has-[:checked]:border-primary has-[:checked]:bg-primary/5">
                                <input
                                    type="radio"
                                    name="method"
                                    value="CAMPAY"
                                    data-payment-method="mobile_money"
                                    class="h-4 w-4 border-2 border-input text-primary focus:ring-primary"
                                    required
                                    checked
                                    data-action="change->toggle#select"
                                />
                                <div class="flex items-center gap-3 flex-1">
                                    <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-500/10">
                                        <i data-lucide="smartphone" class="h-5 w-5 text-emerald-600"></i>
                                    </div>
                                    <div>
                                        <span class="font-medium block">{% trans "Mobile Money (MTN / Orange)" %}</span>
                                        <span class="text-xs text-muted-foreground">{% trans "Powered by Campay" %}</span>
                                    </div>
                                </div>
                                <span class="text-xs bg-emerald-500/10 text-emerald-600 px-2 py-1 rounded-full">{% trans "Recommended" %}</span>
                            </label>
                            <label class="flex cursor-pointer items-center space-x-3 rounded-xl border-2 border-input p-4 hover:bg-accent hover:border-primary/30 transition-all has-[:checked]:border-primary has-[:checked]:bg-primary/5">
                                <input
                                    type="radio"
                                    name="method"
                                    value="FLUTTERWAVE"
                                    data-payment-method="mobile_money"
                                    class="h-4 w-4 border-2 border-input text-primary focus:ring-primary"
                                    data-action="change->toggle#select"
                                />
                                <div class="flex items-center gap-3 flex-1">
                                    <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-500/10">
                                        <i data-lucide="smartphone" class="h-5 w-5 text-blue-600"></i>
                                    </div>
                                    <div>
                                        <span class="font-medium block">{% trans "Mobile Money (Flutterwave)" %}</span>
                                        <span class="text-xs text-muted-foreground">{% trans "Ghana, Uganda" %}</span>
                                    </div>
                                </div>
                            </label>
                            <label class="flex cursor-pointer items-center space-x-3 rounded-xl border-2 border-input p-4 hover:bg-accent hover:border-primary/30 transition-all has-[:checked]:border-primary has-[:checked]:bg-primary/5">
                                <input
                                    type="radio"
                                    name="method"
                                    value="FLUTTERWAVE"
                                    data-payment-method="card"
                                    class="h-4 w-4 border-2 border-input text-primary focus:ring-primary"
                                    data-action="change->toggle#select"
                                />
                                <div class="flex items-center gap-3 flex-1">
                                    <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-purple-500/10">
                                        <i data-lucide="credit-card" class="h-5 w-5 text-purple-600"></i>
                                    </div>
                                    <div>
                                        <span class="font-medium block">{% trans "Debit/Credit Card" %}</span>
                                        <span class="text-xs text-muted-foreground">{% trans "Visa, Mastercard" %}</span>
                                    </div>
                                </div>
                            </label>
                            <label class="flex cursor-pointer items-center space-x-3 rounded-xl border-2 border-input p-4 hover:bg-accent hover:border-primary/30 transition-all has-[:checked]:border-primary has-[:checked]:bg-primary/5">
                                <input
                                    type="radio"
                                    name="method"
                                    value="OFFLINE"
                                    data-payment-method=""
                                    class="h-4 w-4 border-2 border-input text-primary focus:ring-primary"
                                    data-action="change->toggle#select"
                                />
                                <div class="flex items-center gap-3">
                                    <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-muted">
                                        <i data-lucide="banknote" class="h-5 w-5 text-muted-foreground"></i>
                                    </div>
                                    <div>
                                        <span class="font-medium block">{% trans "Pay at Event" %}</span>
                                        <span class="text-xs text-muted-foreground">{% trans "Cash or bank transfer" %}</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <input type="hidden" name="payment_method" id="payment_method" value="mobile_money">

                    <div class="space-y-2">
                        <label for="phone" class="block text-sm font-medium">{% trans "Phone Number" %}</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground text-sm">+237</span>
                            <input type="tel" name="phone" id="phone"
                                   placeholder="6XX XXX XXX" required
                                   class="input w-full pl-14 pr-20">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2">
                                <span class="carrier-badge hidden text-xs font-medium px-2 py-1 rounded-full" data-carrier="MTN"></span>
                            </div>
                        </div>
                        <p class="text-xs text-muted-foreground">{% trans "Enter without country code (e.g., 6XX XXX XXX)" %}</p>
                    </div>
                    </div>

                    <div class="space-y-6">
                    <div class="rounded-xl bg-muted p-4 space-y-3 lg:sticky lg:top-24">
                        <div class="text-xs text-info-foreground mb-2" data-toggle-target="campayNote">
                            {% trans "Note: The agent name that will appear for withdrawal is" %} <strong>TAKWID GROUP</strong>.
                        </div>
                        <div class="text-sm text-muted-foreground mb-2">{% trans "Order Summary" %}</div>
                        {% for ticket in booking.tickets.all %}
                        <div class="flex items-center justify-between text-sm">
                            <span>{{ ticket.ticket_type.name }}</span>
                            <span>{{ ticket.ticket_type.price }} {{ currency }}</span>
                        </div>
                        {% endfor %}
                        <div class="border-t border-border pt-3 space-y-2">
                            <div class="flex items-center justify-between text-sm">
                                <span>{% trans "Subtotal" %}</span>
                                <span>{{ subtotal }} {{ currency }}</span>
                            </div>
                            <div class="flex items-center justify-between text-sm text-muted-foreground">
                                <span class="flex items-center gap-1">
                                    {% trans "Transaction Fee" %}
                                    <i data-lucide="info" class="h-3 w-3" title="{% trans 'Mobile money withdrawal fee' %}"></i>
                                </span>
                                <span>{{ withdrawal_fee }} {{ currency }}</span>
                            </div>
                            <div class="border-t border-border pt-2 flex items-center justify-between">
                                <span class="font-medium">{% trans "Total to Pay" %}</span>
                                <span class="text-xl font-bold">{{ total_with_fee }} {{ currency }}</span>
                            </div>
                        </div>

                    {% #button type="submit" variant="default" class="w-full mt-4" %}
                        <i data-lucide="credit-card" class="mr-2 h-4 w-4"></i>
                        {% trans "Pay Now" %}
                    {% /button %}
                    </div>
                    </div>
                </form>
            </div>
        {% /card %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.getElementById('phone');
    const carrierBadge = document.querySelector('.carrier-badge');
    const methodRadios = document.querySelectorAll('input[name="method"]');
    const paymentMethodInput = document.getElementById('payment_method');

    methodRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const paymentMethod = this.getAttribute('data-payment-method');
            if (paymentMethod) {
                paymentMethodInput.value = paymentMethod;
            }
        });
    });

    if (phoneInput && carrierBadge) {
        phoneInput.addEventListener('input', function() {
            let phone = this.value.replace(/\D/g, '');
            if (phone.startsWith('237')) phone = phone.substring(3);

            if (phone.length < 2) {
                carrierBadge.classList.add('hidden');
                return;
            }

            const mtnPrefixes = ['67', '650', '651', '652', '653', '654', '680', '681', '682', '683'];
            const orangePrefixes = ['640', '655', '656', '657', '658', '659', '686', '687', '688', '689', '69'];

            let carrier = '';
            for (const p of mtnPrefixes) {
                if (phone.startsWith(p)) { carrier = 'MTN'; break; }
            }
            if (!carrier) {
                for (const p of orangePrefixes) {
                    if (phone.startsWith(p)) { carrier = 'ORANGE'; break; }
                }
            }

            if (carrier) {
                carrierBadge.textContent = carrier;
                carrierBadge.className = 'carrier-badge text-xs font-medium px-2 py-1 rounded-full ';
                carrierBadge.className += carrier === 'MTN' ? 'bg-yellow-500/20 text-yellow-600' : 'bg-orange-500/20 text-orange-600';
                carrierBadge.classList.remove('hidden');
            } else {
                carrierBadge.classList.add('hidden');
            }
        });
    }
});
</script>
{% endblock %}
