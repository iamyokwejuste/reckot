{% extends "base.html" %}
{% load slippers %}
{% load i18n %}

{% block title %}{% trans "I Will Be There" %} - {{ event.title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">{% trans "I Will Be There!" %}</h1>
            <p class="text-muted-foreground">{% blocktrans with title=event.title %}Create your personalized flyer for {{ title }}{% endblocktrans %}</p>
        </div>

        <div class="card p-6">
            <noscript>
                <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded mb-4">
                    <p class="text-sm">{% trans "JavaScript is required to generate flyers. Please enable JavaScript in your browser." %}</p>
                </div>
            </noscript>
            <form id="flyer-form" method="post" enctype="multipart/form-data" class="space-y-6">
                {% csrf_token %}

                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Your Photo" %}</label>
                    <div class="border-2 border-dashed border-border rounded-lg p-6 text-center"
                         x-data="{ preview: null, dragging: false }"
                         @dragover.prevent="dragging = true"
                         @dragleave.prevent="dragging = false"
                         @drop.prevent="dragging = false; const file = $event.dataTransfer.files[0]; if (file) { $refs.photoInput.files = $event.dataTransfer.files; preview = URL.createObjectURL(file); }"
                         :class="{ 'border-primary bg-primary/5': dragging }">
                        <input type="file" name="photo" accept="image/*" required
                               class="hidden" x-ref="photoInput"
                               @change="preview = URL.createObjectURL($event.target.files[0])">
                        <div x-show="!preview" class="space-y-2">
                            <i data-lucide="upload" class="w-10 h-10 mx-auto text-muted-foreground"></i>
                            <p class="text-sm text-muted-foreground">{% trans "Drag & drop or click to upload" %}</p>
                            {% #button type="button" variant="outline" size="sm" attrs='@click="$refs.photoInput.click()"' %}
                                {% trans "Choose Photo" %}
                            {% /button %}
                        </div>
                        <div x-show="preview" class="space-y-2">
                            <img :src="preview" class="w-32 h-32 mx-auto object-cover rounded-full">
                            {% #button type="button" variant="outline" size="sm" attrs='@click="$refs.photoInput.click()"' %}
                                {% trans "Change Photo" %}
                            {% /button %}
                        </div>
                    </div>
                </div>

                {% for field in text_fields %}
                <div>
                    <label class="block text-sm font-medium mb-2">
                        {{ field.label }}
                        {% if field.is_required %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    <input type="text" name="field_{{ field.id }}"
                           placeholder="{{ field.placeholder }}"
                           class="input w-full"
                           {% if field.is_required %}required{% endif %}>
                </div>
                {% endfor %}

                <div class="pt-4">
                    {% #button type="submit" variant="default" id="generate-btn" class="w-full" %}
                        <i data-lucide="image" class="w-4 h-4 mr-2"></i>
                        {% trans "Generate My Flyer" %}
                    {% /button %}
                </div>
            </form>

            <div id="result" class="hidden mt-6">
                <div class="border border-border rounded-lg overflow-hidden">
                    <img id="flyer-result" class="w-full" alt="{% trans "Your flyer" %}">
                </div>
                <div class="flex gap-3 mt-4">
                    <a id="download-btn" download="{{ event.slug }}-flyer.jpg" class="flex-1">
                        {% #button variant="default" class="w-full" %}
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                            {% trans "Download" %}
                        {% /button %}
                    </a>
                    {% #button type="button" variant="outline" class="flex-1" attrs='onclick="shareFlyer()"' %}
                        <i data-lucide="share-2" class="w-4 h-4 mr-2"></i>
                        {% trans "Share" %}
                    {% /button %}
                </div>
            </div>
        </div>

        <div class="text-center mt-6">
            <a href="{% url 'events:public_detail' org_slug=event.organization.slug event_slug=event.slug %}" class="text-sm text-muted-foreground hover:text-foreground">
                <i data-lucide="arrow-left" class="w-4 h-4 inline"></i>
                {% trans "Back to event" %}
            </a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('flyer-form');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            await generateFlyer(new FormData(this));
        });
    }
});

async function generateFlyer(formData) {
    const btn = document.getElementById('generate-btn');
    const btnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>Generating...';
    if (window.lucide) lucide.createIcons();

    try {
        const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (response.ok) {
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('image')) {
                const blob = await response.blob();

                // Verify blob is valid
                if (blob.size === 0) {
                    throw new Error('Empty image received');
                }

                const url = URL.createObjectURL(blob);
                const imgElement = document.getElementById('flyer-result');
                const downloadBtn = document.getElementById('download-btn');

                // Set up the image with error handling
                imgElement.onerror = function() {
                    URL.revokeObjectURL(url);
                    alert('Failed to load generated image. Please try again.');
                };

                imgElement.src = url;
                downloadBtn.href = url;
                document.getElementById('result').classList.remove('hidden');
                document.querySelector('form').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                const text = await response.text();
                alert(text || 'Error: Invalid response type. Expected an image.');
            }
        } else {
            const text = await response.text();
            alert(text || 'Error generating flyer. Please try again.');
        }
    } catch (error) {
        console.error('Flyer generation error:', error);
        alert('Error generating flyer: ' + (error.message || 'Please try again.'));
    }

    btn.disabled = false;
    btn.innerHTML = btnText;
    if (window.lucide) lucide.createIcons();
}

async function shareFlyer() {
    const img = document.getElementById('flyer-result');
    if (navigator.share) {
        try {
            const response = await fetch(img.src);
            const blob = await response.blob();
            const file = new File([blob], '{{ event.slug }}-flyer.jpg', { type: 'image/jpeg' });
            await navigator.share({
                title: 'I Will Be There - {{ event.title }}',
                text: "I'm attending {{ event.title }}!",
                files: [file]
            });
        } catch (err) {
            copyEventLink();
        }
    } else {
        copyEventLink();
    }
}

function copyEventLink() {
    const url = '{{ request.build_absolute_uri }}';
    navigator.clipboard.writeText(url);
    alert('Link copied to clipboard!');
}
</script>
{% endblock %}
