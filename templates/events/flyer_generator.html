{% extends "base.html" %}
{% load slippers %}
{% load i18n %}

{% block title %}{% trans "I Will Be There" %} - {{ event.title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">{% trans "I Will Be There" %}</h1>
            <p class="text-muted-foreground">{% blocktrans with title=event.title %}Create your personalized flyer for {{ title }}{% endblocktrans %}</p>
        </div>

        <div class="card p-6" data-controller="toggle">
            <noscript>
                <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded mb-4">
                    <p class="text-sm">{% trans "JavaScript is required to generate flyers. Please enable JavaScript in your browser." %}</p>
                </div>
            </noscript>

            <div data-toggle-target="step1" class="space-y-6">
                <div class="bg-gradient-to-br from-primary/5 to-primary/10 border border-primary/20 p-6 rounded-xl shadow-sm">
                    <div class="flex items-start gap-3 mb-4">
                        <div class="p-2 bg-primary/10 rounded-lg">
                            <i data-lucide="shield-check" class="w-5 h-5 text-primary"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg mb-1">{% trans "Ticket Verification Required" %}</h3>
                            <p class="text-sm text-muted-foreground">{% trans "Enter your email, phone number, or ticket code to verify you have a ticket:" %}</p>
                        </div>
                    </div>

                    <div id="verification-form">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">{% trans "Email / Phone / Ticket Code" %} <span class="text-destructive">*</span></label>
                                <input type="text" name="ticket_verification" data-toggle-target="ticketInput" class="input w-full bg-background"
                                       placeholder="your@email.com or +237XXXXXXXXX or TICKET-XXXX-XXXX"
                                       data-action="keydown.enter->toggle#toggle"
                                       required>
                            </div>

                            <div data-toggle-target="verificationError" class="hidden p-3 bg-destructive/10 border border-destructive/20 rounded-lg text-sm text-destructive"></div>

                            <div>
                                {% #button type="button" variant="default" class="w-full" attrs='data-action="click->toggle#toggle" data-toggle-target="verifyBtn"' %}
                                    <i data-lucide="shield-check" class="w-4 h-4 mr-2"></i>
                                    {% trans "Verify Ticket" %}
                                {% /button %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div data-toggle-target="step2" class="hidden space-y-6">
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 p-4 rounded-xl shadow-sm mb-4">
                    <div class="flex items-center gap-2">
                        <div class="p-1.5 bg-green-100 rounded-full">
                            <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                        </div>
                        <span class="text-sm font-medium text-green-700">{% trans "Ticket verified successfully!" %}</span>
                    </div>
                </div>

                <form id="flyer-form" method="post" enctype="multipart/form-data" class="space-y-6" data-action="submit->toggle#toggle">
                    {% csrf_token %}
                    <input type="hidden" name="ticket_verification" data-toggle-target="verifiedCode">

                    <div>
                        <label class="block text-sm font-medium mb-2">{% trans "Your Photo" %}</label>
                        <div class="border-2 border-dashed border-border rounded-lg p-6 text-center"
                             ondragover="event.preventDefault(); this.classList.add('border-primary', 'bg-primary/5');"
                             ondragleave="this.classList.remove('border-primary', 'bg-primary/5');"
                             ondrop="event.preventDefault(); this.classList.remove('border-primary', 'bg-primary/5'); const files = event.dataTransfer.files; if (files.length > 0) { document.getElementById('photo-input').files = files; previewPhoto(files[0]); }">
                            <input type="file" name="photo" accept="image/*" required id="photo-input"
                                   class="hidden"
                                   onchange="previewPhoto(this.files[0])">
                            <div id="photo-placeholder">
                                <i data-lucide="upload" class="w-10 h-10 mx-auto text-muted-foreground"></i>
                                <p class="text-sm text-muted-foreground">{% trans "Drag & drop or click to upload" %}</p>
                                {% #button type="button" variant="outline" size="sm" attrs='onclick="document.getElementById(\'photo-input\').click()"' %}
                                    {% trans "Choose Photo" %}
                                {% /button %}
                            </div>
                            <div id="photo-preview" class="hidden space-y-2">
                                <img id="photo-image" class="w-32 h-32 mx-auto object-cover rounded-full">
                                {% #button type="button" variant="outline" size="sm" attrs='onclick="document.getElementById(\'photo-input\').click()"' %}
                                    {% trans "Change Photo" %}
                                {% /button %}
                            </div>
                        </div>
                    </div>

                    {% for field in text_fields %}
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            {{ field.label }}
                            {% if field.is_required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        <input type="text" name="field_{{ field.id }}"
                               placeholder="{{ field.placeholder }}"
                               class="input w-full"
                               {% if field.is_required %}required{% endif %}>
                    </div>
                    {% endfor %}

                    <div id="generation-error" class="hidden p-3 bg-red-50 border border-red-200 rounded text-sm text-red-700"></div>

                    <div class="pt-4">
                        {% #button type="submit" variant="default" id="generate-btn" class="w-full" %}
                            <i data-lucide="image" class="w-4 h-4 mr-2"></i>
                            {% trans "Generate My Flyer" %}
                        {% /button %}
                    </div>
                </form>
            </div>

            <div id="result" class="hidden mt-6">
                <div class="border border-border rounded-lg overflow-hidden">
                    <img id="flyer-result" class="w-full" alt="{% trans "Your flyer" %}">
                </div>
                <div class="flex gap-3 mt-4">
                    <a id="download-btn" download="{{ event.slug }}-flyer.jpg" class="flex-1">
                        {% #button variant="default" class="w-full" %}
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                            {% trans "Download" %}
                        {% /button %}
                    </a>
                    {% #button type="button" variant="outline" class="flex-1" attrs='onclick="shareFlyer()"' %}
                        <i data-lucide="share-2" class="w-4 h-4 mr-2"></i>
                        {% trans "Share" %}
                    {% /button %}
                </div>
            </div>
        </div>

        <div class="text-center mt-6">
            <a href="{% url 'events:public_detail' org_slug=event.organization.slug event_slug=event.slug %}" class="text-sm text-muted-foreground hover:text-foreground">
                <i data-lucide="arrow-left" class="w-4 h-4 inline"></i>
                {% trans "Back to event" %}
            </a>
        </div>
    </div>
</div>

{% load static %}
<script src="{% static 'js/flyer-generator-utils.js' %}"></script>
{% endblock %}
