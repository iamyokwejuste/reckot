{% extends "base.html" %}
{% load slippers %}
{% load i18n %}

{% block title %}{% trans "I Will Be There" %} - {{ event.title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">{% trans "I Will Be There!" %}</h1>
            <p class="text-muted-foreground">{% blocktrans with title=event.title %}Create your personalized flyer for {{ title }}{% endblocktrans %}</p>
        </div>

        <div class="card p-6" x-data="{
            step: 1,
            ticketVerified: false,
            verifiedTicketCode: '',
            verifyingTicket: false,
            verificationError: '',
            verifyTicket() {
                const ticketValue = this.$refs.ticketInput.value.trim();
                if (!ticketValue) {
                    this.verificationError = 'Please enter your email, phone number, or ticket code.';
                    return;
                }

                const formData = new FormData();
                formData.append('ticket_verification', ticketValue);

                this.verifyingTicket = true;
                this.verificationError = '';

                const csrftoken = getCookie('csrftoken');

                fetch('{% url 'events:flyer_verify_ticket' org_slug=event.organization.slug event_slug=event.slug %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrftoken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.ticketVerified = true;
                        this.verifiedTicketCode = data.ticket_code;
                        this.step = 2;
                        setTimeout(() => {
                            if (window.lucide) lucide.createIcons();
                        }, 100);
                    } else {
                        this.verificationError = data.error || 'Verification failed. Please try again.';
                    }
                })
                .catch(error => {
                    console.error('Verification error:', error);
                    this.verificationError = 'Error verifying ticket. Please try again.';
                })
                .finally(() => {
                    this.verifyingTicket = false;
                });
            }
        }">
            <noscript>
                <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded mb-4">
                    <p class="text-sm">{% trans "JavaScript is required to generate flyers. Please enable JavaScript in your browser." %}</p>
                </div>
            </noscript>

            <div x-show="step === 1" class="space-y-6">
                <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                    <h3 class="font-semibold mb-2 text-blue-900">{% trans "Ticket Verification Required" %}</h3>
                    <p class="text-sm text-blue-700 mb-4">{% trans "Enter your email, phone number, or ticket code to verify you have a ticket:" %}</p>

                    <div id="verification-form">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-blue-900">{% trans "Email / Phone / Ticket Code" %} <span class="text-red-500">*</span></label>
                                <input type="text" name="ticket_verification" x-ref="ticketInput" class="input w-full"
                                       placeholder="your@email.com or +237XXXXXXXXX or TICKET-XXXX-XXXX"
                                       @keydown.enter="verifyTicket()"
                                       required>
                            </div>

                            <div x-show="verificationError" class="p-3 bg-red-50 border border-red-200 rounded text-sm text-red-700" x-text="verificationError"></div>

                            <div>
                                {% #button type="button" variant="default" class="w-full" attrs='@click="verifyTicket()" x-bind:disabled="verifyingTicket"' %}
                                    <span x-show="!verifyingTicket" class="flex items-center justify-center">
                                        <i data-lucide="shield-check" class="w-4 h-4 mr-2"></i>
                                        {% trans "Verify Ticket" %}
                                    </span>
                                    <span x-show="verifyingTicket" class="flex items-center justify-center">
                                        <i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>
                                        {% trans "Verifying..." %}
                                    </span>
                                {% /button %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="step === 2" class="space-y-6">
                <div class="bg-green-50 border border-green-200 p-3 rounded-lg mb-4">
                    <div class="flex items-center text-green-700">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
                        <span class="text-sm font-medium">{% trans "Ticket verified successfully!" %}</span>
                    </div>
                </div>

                <form id="flyer-form" method="post" enctype="multipart/form-data" class="space-y-6">
                    {% csrf_token %}
                    <input type="hidden" name="ticket_verification" :value="verifiedTicketCode">

                    <div>
                        <label class="block text-sm font-medium mb-2">{% trans "Your Photo" %}</label>
                        <div class="border-2 border-dashed border-border rounded-lg p-6 text-center"
                             x-data="{ preview: null, dragging: false }"
                             @dragover.prevent="dragging = true"
                             @dragleave.prevent="dragging = false"
                             @drop.prevent="dragging = false; const file = $event.dataTransfer.files[0]; if (file) { $refs.photoInput.files = $event.dataTransfer.files; preview = URL.createObjectURL(file); }"
                             :class="{ 'border-primary bg-primary/5': dragging }">
                            <input type="file" name="photo" accept="image/*" required
                                   class="hidden" x-ref="photoInput"
                                   @change="preview = URL.createObjectURL($event.target.files[0])">
                            <div x-show="!preview" class="space-y-2">
                                <i data-lucide="upload" class="w-10 h-10 mx-auto text-muted-foreground"></i>
                                <p class="text-sm text-muted-foreground">{% trans "Drag & drop or click to upload" %}</p>
                                {% #button type="button" variant="outline" size="sm" attrs='@click="$refs.photoInput.click()"' %}
                                    {% trans "Choose Photo" %}
                                {% /button %}
                            </div>
                            <div x-show="preview" class="space-y-2">
                                <img :src="preview" class="w-32 h-32 mx-auto object-cover rounded-full">
                                {% #button type="button" variant="outline" size="sm" attrs='@click="$refs.photoInput.click()"' %}
                                    {% trans "Change Photo" %}
                                {% /button %}
                            </div>
                        </div>
                    </div>

                    {% for field in text_fields %}
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            {{ field.label }}
                            {% if field.is_required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        <input type="text" name="field_{{ field.id }}"
                               placeholder="{{ field.placeholder }}"
                               class="input w-full"
                               {% if field.is_required %}required{% endif %}>
                    </div>
                    {% endfor %}

                    <div id="generation-error" class="hidden p-3 bg-red-50 border border-red-200 rounded text-sm text-red-700"></div>

                    <div class="pt-4">
                        {% #button type="submit" variant="default" id="generate-btn" class="w-full" %}
                            <i data-lucide="image" class="w-4 h-4 mr-2"></i>
                            {% trans "Generate My Flyer" %}
                        {% /button %}
                    </div>
                </form>
            </div>

            <div id="result" class="hidden mt-6">
                <div class="border border-border rounded-lg overflow-hidden">
                    <img id="flyer-result" class="w-full" alt="{% trans "Your flyer" %}">
                </div>
                <div class="flex gap-3 mt-4">
                    <a id="download-btn" download="{{ event.slug }}-flyer.jpg" class="flex-1">
                        {% #button variant="default" class="w-full" %}
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                            {% trans "Download" %}
                        {% /button %}
                    </a>
                    {% #button type="button" variant="outline" class="flex-1" attrs='onclick="shareFlyer()"' %}
                        <i data-lucide="share-2" class="w-4 h-4 mr-2"></i>
                        {% trans "Share" %}
                    {% /button %}
                </div>
            </div>
        </div>

        <div class="text-center mt-6">
            <a href="{% url 'events:public_detail' org_slug=event.organization.slug event_slug=event.slug %}" class="text-sm text-muted-foreground hover:text-foreground">
                <i data-lucide="arrow-left" class="w-4 h-4 inline"></i>
                {% trans "Back to event" %}
            </a>
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('flyer-form');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            await generateFlyer(new FormData(this));
        });
    }
});

function showGenerationError(message) {
    const errorDiv = document.getElementById('generation-error');
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function hideGenerationError() {
    const errorDiv = document.getElementById('generation-error');
    errorDiv.classList.add('hidden');
}

async function generateFlyer(formData) {
    const btn = document.getElementById('generate-btn');
    const btnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>Generating...';
    if (window.lucide) lucide.createIcons();

    hideGenerationError();

    const csrftoken = getCookie('csrftoken');
    const cleanUrl = window.location.origin + window.location.pathname;

    try {
        const response = await fetch(cleanUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            }
        });

        if (response.ok) {
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('image')) {
                const blob = await response.blob();

                if (blob.size === 0) {
                    throw new Error('Empty image received');
                }

                const url = URL.createObjectURL(blob);
                const imgElement = document.getElementById('flyer-result');
                const downloadBtn = document.getElementById('download-btn');

                imgElement.onerror = function() {
                    URL.revokeObjectURL(url);
                    showGenerationError('Failed to load generated image. Please try again.');
                };

                imgElement.src = url;
                downloadBtn.href = url;
                document.getElementById('result').classList.remove('hidden');
                document.querySelector('form').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                const data = await response.json();
                showGenerationError(data.error || 'Error: Invalid response type. Expected an image.');
            }
        } else {
            const data = await response.json();
            showGenerationError(data.error || 'Error generating flyer. Please try again.');
        }
    } catch (error) {
        console.error('Flyer generation error:', error);
        showGenerationError('Error generating flyer: ' + (error.message || 'Please try again.'));
    }

    btn.disabled = false;
    btn.innerHTML = btnText;
    if (window.lucide) lucide.createIcons();
}

async function shareFlyer() {
    const img = document.getElementById('flyer-result');
    if (navigator.share) {
        try {
            const response = await fetch(img.src);
            const blob = await response.blob();
            const file = new File([blob], '{{ event.slug }}-flyer.jpg', { type: 'image/jpeg' });
            await navigator.share({
                files: [file],
                title: '{% trans "My Event Flyer" %}',
                text: '{% blocktrans with title=event.title %}Check out my flyer for {{ title }}!{% endblocktrans %}'
            });
        } catch (error) {
            console.log('Sharing failed:', error);
        }
    } else {
        alert('{% trans "Sharing is not supported on your device. Please use the download button." %}');
    }
}
</script>
{% endblock %}
