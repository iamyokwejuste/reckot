{% extends "base.html" %}
{% load slippers %}
{% load static %}
{% load i18n %}

{% block title %}{{ event.title }} - {{ event.start_at|date:"M j, Y" }} | Reckot{% endblock %}

{% block meta_description %}{{ event.short_description|default:event.description|striptags|truncatewords:30 }} Join us on {{ event.start_at|date:"F j, Y" }} at {{ event.location|default:"Online" }}.{% endblock %}
{% block meta_keywords %}{{ event.title }}, {{ event.organization.name }}, events, {{ event.city|default:"Africa" }}, {{ event.event_type|lower }}, tickets, {{ event.start_at|date:"Y" }}{% endblock %}

{% block og_type %}event{% endblock %}
{% block og_title %}{{ event.title }} - {{ event.start_at|date:"M j, Y" }}{% endblock %}
{% block og_description %}{{ event.short_description|default:event.description|striptags|truncatewords:30 }} Join us on {{ event.start_at|date:"F j, Y" }}.{% endblock %}
{% block og_image %}
<meta property="og:image" content="{% if event.cover_image %}{{ request.scheme }}://{{ request.get_host }}{{ event.cover_image.url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/reckot_preview.png' %}{% endif %}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="{{ event.title }}">
{% endblock %}

{% block twitter_title %}{{ event.title }} - {{ event.start_at|date:"M j" }}{% endblock %}
{% block twitter_description %}{{ event.short_description|default:event.description|striptags|truncatewords:25 }} {{ event.start_at|date:"F j, Y" }}{% endblock %}
{% block twitter_image %}
<meta name="twitter:image" content="{% if event.cover_image %}{{ request.scheme }}://{{ request.get_host }}{{ event.cover_image.url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/reckot_preview.png' %}{% endif %}">
<meta name="twitter:image:alt" content="{{ event.title }}">
{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Event",
    "name": "{{ event.title|escapejs }}",
    "description": "{{ event.description|striptags|truncatewords:50|escapejs }}",
    "startDate": "{{ event.start_at|date:'c' }}",
    "endDate": "{{ event.end_at|date:'c' }}",
    "eventStatus": "https://schema.org/EventScheduled",
    "eventAttendanceMode": "https://schema.org/{% if event.event_type == 'ONLINE' %}OnlineEventAttendanceMode{% elif event.event_type == 'HYBRID' %}MixedEventAttendanceMode{% else %}OfflineEventAttendanceMode{% endif %}",
    {% if event.cover_image %}"image": "{{ request.scheme }}://{{ request.get_host }}{{ event.cover_image.url }}",{% endif %}
    "location": {
        {% if event.event_type == 'ONLINE' %}
        "@type": "VirtualLocation",
        "url": "{{ request.build_absolute_uri }}"
        {% else %}
        "@type": "Place",
        "name": "{{ event.venue_name|default:event.location|escapejs }}",
        "address": {
            "@type": "PostalAddress",
            "streetAddress": "{{ event.location|escapejs }}",
            "addressLocality": "{{ event.city|default:'Douala'|escapejs }}",
            "addressCountry": "{{ event.country|default:'CM' }}"
        }
        {% endif %}
    },
    "organizer": {
        "@type": "Organization",
        "name": "{{ event.organization.name|escapejs }}",
        "url": "{{ request.scheme }}://{{ request.get_host }}"
    },
    {% if ticket_types %}"offers": [{% for tt in ticket_types %}
        {
            "@type": "Offer",
            "name": "{{ tt.name|escapejs }}",
            "price": "{{ tt.price }}",
            "priceCurrency": "{{ event.organization.currency|default:'XAF' }}",
            "availability": "https://schema.org/{% if tt.is_available %}InStock{% else %}SoldOut{% endif %}",
            "url": "{{ request.build_absolute_uri }}",
            "validFrom": "{% if tt.sales_start %}{{ tt.sales_start|date:'c' }}{% else %}{{ event.created_at|date:'c' }}{% endif %}"
        }{% if not forloop.last %},{% endif %}{% endfor %}
    ],{% endif %}
    "url": "{{ request.build_absolute_uri }}"
}
</script>
{% endblock %}

{% block extra_head %}
<script defer src="{% static 'js/event_checkout.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 pb-24">
    <div class="max-w-4xl mx-auto">
        <div class="mb-6">
            <a href="{% url 'events:discover' %}" class="text-sm text-muted-foreground hover:text-foreground flex items-center gap-1">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                {% trans "Back to events" %}
            </a>
        </div>

        {% if event.cover_image %}
        <div class="mb-6 rounded-xl overflow-hidden">
            <img src="{{ event.cover_image.url }}" alt="{{ event.title }}" class="w-full h-64 sm:h-80 object-cover">
        </div>
        {% endif %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div class="card p-6 mb-6">
                    <div class="flex items-center gap-2 text-sm text-muted-foreground mb-4">
                        <span class="px-2 py-1 rounded bg-foreground/5">{{ event.organization.name }}</span>
                    </div>
                    <h1 class="text-3xl font-bold mb-4">{{ event.title }}</h1>

                    <div class="flex flex-wrap gap-4 mb-6 text-sm">
                        <div class="flex items-center gap-2">
                            <i data-lucide="calendar" class="w-5 h-5 text-muted-foreground"></i>
                            <div>
                                <div class="font-medium">{{ event.start_at|date:"l, F j, Y" }}</div>
                                <div class="text-muted-foreground">{{ event.start_at|time:"g:i A" }} - {{ event.end_at|time:"g:i A" }}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-5 h-5 text-muted-foreground"></i>
                            <div>
                                <div class="font-medium">{{ event.location }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="prose prose-sm dark:prose-invert max-w-none text-muted-foreground">{{ event.description|safe }}</div>
                </div>

                <div class="card p-6">
                    <h3 class="font-semibold mb-4">{% trans "Share this event" %}</h3>
                    <div class="flex flex-wrap gap-2">
                        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}" target="_blank" rel="noopener noreferrer">
                            {% #button variant="outline" size="sm" %}
                                <i data-lucide="facebook" class="w-4 h-4"></i>
                            {% /button %}
                        </a>
                        <a href="https://twitter.com/intent/tweet?text={{ event.title|urlencode }}%20-%20{{ event.start_at|date:'F j, Y'|urlencode }}&url={{ request.build_absolute_uri|urlencode }}" target="_blank" rel="noopener noreferrer">
                            {% #button variant="outline" size="sm" %}
                                <i data-lucide="twitter" class="w-4 h-4"></i>
                            {% /button %}
                        </a>
                        <a href="https://wa.me/?text={{ event.title|urlencode }}%20-%20{{ event.start_at|date:'F j, Y'|urlencode }}%20{{ request.build_absolute_uri|urlencode }}" target="_blank" rel="noopener noreferrer">
                            {% #button variant="outline" size="sm" %}
                                <i data-lucide="message-circle" class="w-4 h-4"></i>
                            {% /button %}
                        </a>
                        <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri|urlencode }}" target="_blank" rel="noopener noreferrer">
                            {% #button variant="outline" size="sm" %}
                                <i data-lucide="linkedin" class="w-4 h-4"></i>
                            {% /button %}
                        </a>
                        <button type="button" onclick="navigator.clipboard.writeText('{{ request.build_absolute_uri }}').then(() => alert('Link copied!'))" class="btn btn-outline btn-sm">
                            <i data-lucide="link" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="mt-3 p-3 rounded-lg bg-muted/30 border border-border">
                        <p class="text-xs text-muted-foreground text-center">{{ event.title }} - {{ event.start_at|date:"F j, Y" }}</p>
                    </div>
                    {% if flyer_enabled %}
                    <div class="mt-4 pt-4 border-t border-border">
                        {% if event.end_at >= now %}
                        <a href="{% url 'events:flyer_generator' org_slug=event.organization.slug event_slug=event.slug %}">
                            {% #button variant="default" size="sm" class="w-full" %}
                                <i data-lucide="image-plus" class="w-4 h-4 mr-2"></i>
                                {% trans 'Create "I Will Be There" Flyer' %}
                            {% /button %}
                        </a>
                        <p class="text-xs text-muted-foreground mt-2 text-center">{% trans "Generate a personalized flyer to share" %}</p>
                        {% else %}
                        {% #button variant="outline" size="sm" class="w-full opacity-50 cursor-not-allowed" attrs="disabled" %}
                            <i data-lucide="image-plus" class="w-4 h-4 mr-2"></i>
                            {% trans 'Create "I Will Be There" Flyer' %}
                        {% /button %}
                        <p class="text-xs text-muted-foreground mt-2 text-center">{% trans "You can't be there at a past event" %}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="lg:col-span-1 self-start">
                <div class="card p-6 sticky top-24">
                    <h3 class="font-semibold mb-4">{% trans "Tickets" %}</h3>

                    {% if event.start_at > now and event.end_at > now %}
                    <div class="mb-4 p-3 rounded-lg bg-muted/50 border border-border">
                        <div class="text-xs text-muted-foreground text-center mb-1">{% trans "Event starts" %}</div>
                        <div class="text-center">
                            <div class="text-base font-bold">{{ event.start_at|date:"M d, Y" }}</div>
                            <div class="text-sm text-muted-foreground">{{ event.start_at|time:"g:i A" }}</div>
                        </div>
                    </div>
                    {% elif event.start_at <= now and event.end_at > now %}
                    <div class="mb-4 p-3 rounded-lg bg-success/10 border border-success/20 text-center">
                        <div class="text-sm font-medium text-success">{% trans "Event is ongoing!" %}</div>
                    </div>
                    {% endif %}

                    {% if ticket_types and has_available_tickets %}
                    <form method="post" action="{% url 'payments:checkout' %}" class="space-y-4" hx-boost="false"
                          data-controller="event-checkout"
                          data-event-checkout-csrf-token-value="{{ csrf_token }}"
                          data-event-checkout-event-id-value="{{ event.id }}"
                          data-event-checkout-validate-coupon-url-value="{% url 'events:validate_coupon' %}"
                          data-action="submit->event-checkout#validateDeliveryEmails">
                        {% csrf_token %}
                        <input type="hidden" name="event_id" value="{{ event.id }}">
                        {% if affiliate_code %}
                        <input type="hidden" name="affiliate_code" value="{{ affiliate_code }}">
                        {% endif %}

                        {% if not user.is_authenticated %}
                        <div class="mb-4" data-controller="toggle">
                            <button type="button" data-action="click->toggle#toggle"
                                    class="w-full flex items-center justify-between p-3 rounded-lg bg-muted/50 hover:bg-muted/70 transition-colors">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center">
                                        <i data-lucide="user" class="w-3.5 h-3.5 text-primary"></i>
                                    </div>
                                    <span class="text-sm font-medium">{% trans "Contact Info" %}</span>
                                    <span class="text-xs text-muted-foreground">({% trans "required" %})</span>
                                </div>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-muted-foreground transition-transform duration-200"></i>
                            </button>
                            <div data-toggle-target="content" class="hidden mt-3 space-y-2">
                                <div class="grid gap-2">
                                    <input type="text" name="guest_name" class="input w-full text-sm" required placeholder="{% trans "Full name" %} *">
                                    <input type="email" name="guest_email" class="input w-full text-sm" required placeholder="{% trans "Email address" %} *">
                                    <input type="tel" name="guest_phone" class="input w-full text-sm" placeholder="{% trans "Phone (optional)" %}">
                                </div>
                                <p class="text-[10px] text-muted-foreground">{% trans "Tickets will be sent to this email" %}</p>
                            </div>
                        </div>
                        {% endif %}

                        {% for ticket_type in ticket_types %}
                        <div class="border border-border rounded-lg p-4 {% if not ticket_type.is_available %}opacity-60{% endif %}"
                             data-controller="toggle">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-medium">{{ ticket_type.name }}</div>
                                    {% if ticket_type.description %}
                                    <div class="text-sm text-muted-foreground">{{ ticket_type.description|truncatewords:10 }}</div>
                                    {% endif %}
                                    {% if ticket_type.status_message %}
                                    <div class="text-xs text-warning mt-1">
                                        <i data-lucide="clock" class="w-3 h-3 inline"></i>
                                        {{ ticket_type.status_message }}
                                    </div>
                                    {% elif ticket_type.sales_started %}
                                    <div class="text-xs text-success mt-1">
                                        <i data-lucide="check-circle" class="w-3 h-3 inline"></i>
                                        {% trans "Sales started!" %}
                                    </div>
                                    {% elif ticket_type.sales_end and ticket_type.is_available %}
                                    <div class="text-xs text-warning mt-1">
                                        <i data-lucide="clock" class="w-3 h-3 inline"></i>
                                        {% blocktrans with date=ticket_type.sales_end|date:"M j, Y" %}Ends {{ date }}{% endblocktrans %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="text-lg font-bold">
                                    {% if ticket_type.price == 0 %}
                                    <span class="text-success">{% trans "Free" %}</span>
                                    {% else %}
                                    {{ ticket_type.price }} {{ currency }}
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="flex justify-between text-xs text-muted-foreground mb-1">
                                    <span>{% blocktrans with sold=ticket_type.sold|default:0 %}{{ sold }} sold{% endblocktrans %}</span>
                                    <span>{% blocktrans with left=ticket_type.available_quantity|default:ticket_type.quantity %}{{ left }} left{% endblocktrans %}</span>
                                </div>
                                <div class="w-full bg-muted rounded-full h-1.5 overflow-hidden">
                                    <div class="bg-primary h-full rounded-full transition-all duration-300"
                                         style="width: {% widthratio ticket_type.sold|default:0 ticket_type.quantity 100 %}%"></div>
                                </div>
                            </div>

                            {% if ticket_type.is_available %}
                            <div class="space-y-3" data-controller="toggle">
                                <div class="flex items-center gap-3">
                                    <label class="text-sm font-medium">{% trans "Qty:" %}</label>
                                    <input type="number"
                                           name="ticket_{{ ticket_type.id }}"
                                           data-toggle-target="input"
                                           data-action="input->toggle#toggle"
                                           min="0"
                                           max="{{ ticket_type.max_per_order }}"
                                           value="0"
                                           class="h-10 w-20 rounded-md border border-input bg-background px-3 py-2 text-sm text-center ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                                           placeholder="0">
                                    <span class="text-xs text-muted-foreground hidden" data-toggle-target="label">
                                        <span data-toggle-target="quantity"></span> <span data-toggle-target="text"></span>
                                    </span>
                                    {% if ticket_type.available_quantity < 10 and ticket_type.available_quantity > 0 %}
                                    <span class="text-sm text-destructive">{% blocktrans with qty=ticket_type.available_quantity %}Only {{ qty }} left!{% endblocktrans %}</span>
                                    {% endif %}
                                </div>

                                <div data-toggle-target="content" class="hidden space-y-3 pt-3 border-t border-border">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2 text-sm font-medium">
                                            <i data-lucide="users" class="w-4 h-4"></i>
                                            <span data-toggle-target="attendeeCount">{% trans "Attendees" %}</span>
                                        </div>
                                        <span class="text-xs text-muted-foreground">{% trans "Optional" %}</span>
                                    </div>
                                    <div class="space-y-2 max-h-80 overflow-y-auto pr-1" data-toggle-target="attendeeList">
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}

                        <div class="border-t border-border pt-4 mt-4">
                            <label class="block text-sm font-medium mb-3">{% trans "How would you like to receive the tickets?" %}</label>
                            <p class="text-xs text-muted-foreground mb-3">{% trans "Choose your preferred delivery method for this group purchase" %}</p>

                            <div class="space-y-2">
                                <label class="flex items-center gap-3 p-3 rounded-lg border border-border cursor-pointer hover:bg-muted/50 transition-colors">
                                    <input type="radio" name="delivery_method" value="EMAIL_ALL"
                                           checked
                                           data-action="change->event-checkout#updateDeliveryMethod"
                                           class="w-4 h-4 text-primary border-border focus:ring-2 focus:ring-primary focus:ring-offset-2">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="mail" class="w-4 h-4"></i>
                                            <span class="font-medium text-sm">{% trans "Email me all tickets" %}</span>
                                        </div>
                                        <p class="text-xs text-muted-foreground mt-1">{% trans "All tickets will be sent to your email address" %}</p>
                                    </div>
                                </label>

                                <label class="flex items-center gap-3 p-3 rounded-lg border border-border cursor-pointer hover:bg-muted/50 transition-colors">
                                    <input type="radio" name="delivery_method" value="EMAIL_INDIVIDUALLY"
                                           data-action="change->event-checkout#updateDeliveryMethod"
                                           class="w-4 h-4 text-primary border-border focus:ring-2 focus:ring-primary focus:ring-offset-2">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="mail-plus" class="w-4 h-4"></i>
                                            <span class="font-medium text-sm">{% trans "Email tickets individually" %}</span>
                                        </div>
                                        <p class="text-xs text-muted-foreground mt-1">{% trans "Each ticket will be sent to the respective attendee's email" %}</p>
                                    </div>
                                </label>
                            </div>

                            <div data-event-checkout-target="individualDeliveryInfo" class="hidden mt-3 p-3 rounded-lg bg-muted/30 border border-border">
                                <div class="flex items-start gap-2">
                                    <i data-lucide="info" class="w-4 h-4 text-primary flex-shrink-0 mt-0.5"></i>
                                    <p class="text-xs text-muted-foreground">
                                        {% trans "Each group member must have a unique email address. Please ensure all attendee emails are filled in above." %}
                                    </p>
                                </div>
                            </div>

                            <div class="hidden mt-3 p-3 rounded-lg bg-destructive/10 border border-destructive/20" data-event-checkout-target="deliveryErrorContainer">
                                <div class="flex items-start gap-2">
                                    <i data-lucide="alert-circle" class="w-4 h-4 text-destructive flex-shrink-0 mt-0.5"></i>
                                    <p class="text-xs text-destructive" data-event-checkout-target="deliveryError"></p>
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-border pt-4 mt-4">
                            <label class="block text-sm font-medium mb-2">{% trans "Have a coupon code?" %}</label>
                            <div class="flex gap-2 items-center">
                                <input type="text" name="coupon_code"
                                       data-event-checkout-target="couponInput"
                                       data-action="input->event-checkout#validateCoupon"
                                       placeholder="{% trans "Enter code" %}" class="input flex-1 uppercase font-mono text-sm h-9">
                                {% #button type="button" variant="outline" size="sm" attrs='data-action="click->event-checkout#validateCoupon"' %}
                                    {% trans "Apply" %}
                                {% /button %}
                            </div>
                            <div class="hidden mt-2 text-sm text-success flex items-center gap-1" data-event-checkout-target="couponDiscountContainer">
                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                <span data-event-checkout-target="couponDiscount"></span> applied!
                            </div>
                            <div class="hidden mt-2 text-sm text-destructive flex items-center gap-1" data-event-checkout-target="couponErrorContainer">
                                <i data-lucide="x-circle" class="w-4 h-4"></i>
                                <span data-event-checkout-target="couponError"></span>
                            </div>
                        </div>

                        {% if checkout_questions %}
                        <div class="border-t border-border pt-4 mt-4">
                            <h4 class="text-sm font-medium mb-3">{% trans "Additional Information" %}</h4>
                            {% for question in checkout_questions %}
                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-1">
                                    {{ question.question }}
                                    {% if question.is_required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {% if question.field_type == 'TEXT' %}
                                <input type="text" name="question_{{ question.id }}" class="input w-full" {% if question.is_required %}required{% endif %}>
                                {% elif question.field_type == 'TEXTAREA' %}
                                <textarea name="question_{{ question.id }}" rows="3" class="input w-full" {% if question.is_required %}required{% endif %}></textarea>
                                {% elif question.field_type == 'SELECT' %}
                                <select name="question_{{ question.id }}" class="input w-full" {% if question.is_required %}required{% endif %}>
                                    <option value="">{% trans "Select..." %}</option>
                                    {% for option in question.options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                                {% elif question.field_type == 'EMAIL' %}
                                <input type="email" name="question_{{ question.id }}" class="input w-full" {% if question.is_required %}required{% endif %}>
                                {% elif question.field_type == 'PHONE' %}
                                <input type="tel" name="question_{{ question.id }}" class="input w-full" {% if question.is_required %}required{% endif %}>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% #button type="submit" variant="default" class="w-full" %}
                            {% trans "Get Tickets" %}
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        {% /button %}
                    </form>

                    {% if not has_available_tickets %}
                    <div class="p-4 rounded-lg bg-muted border border-border text-center mt-4">
                        <p class="text-sm text-muted-foreground">
                            {% if event.state == 'CLOSED' %}
                                {% trans "Ticket sales have closed for this event." %}
                            {% elif event.end_at < now %}
                                {% trans "This event has ended." %}
                            {% else %}
                                {% trans "Ticket sales are not available at this time." %}
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}
                    {% else %}
                    <p class="text-muted-foreground text-sm">
                        {% if event.state == 'CLOSED' %}
                            {% trans "Ticket sales have closed for this event." %}
                        {% elif event.end_at < now %}
                            {% trans "This event has ended." %}
                        {% else %}
                            {% trans "No tickets available at this time." %}
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
