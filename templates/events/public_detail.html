{% extends "base.html" %}
{% load slippers %}
{% load static %}

{% block title %}{{ event.title }} - {{ event.start_at|date:"M j, Y" }} | Reckot{% endblock %}

{% block meta_description %}{{ event.short_description|default:event.description|striptags|truncatewords:30 }} Join us on {{ event.start_at|date:"F j, Y" }} at {{ event.location|default:"Online" }}.{% endblock %}
{% block meta_keywords %}{{ event.title }}, {{ event.organization.name }}, events, {{ event.city|default:"Africa" }}, {{ event.event_type|lower }}, tickets, {{ event.start_at|date:"Y" }}{% endblock %}

{% block og_type %}event{% endblock %}
{% block og_title %}{{ event.title }} - {{ event.start_at|date:"M j, Y" }}{% endblock %}
{% block og_description %}{{ event.short_description|default:event.description|striptags|truncatewords:30 }} Join us on {{ event.start_at|date:"F j, Y" }}.{% endblock %}
{% block og_image %}
<meta property="og:image" content="{% if event.cover_image %}{{ request.scheme }}://{{ request.get_host }}{{ event.cover_image.url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/reckot_preview.png' %}{% endif %}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="{{ event.title }}">
{% endblock %}

{% block twitter_title %}{{ event.title }} - {{ event.start_at|date:"M j" }}{% endblock %}
{% block twitter_description %}{{ event.short_description|default:event.description|striptags|truncatewords:25 }} {{ event.start_at|date:"F j, Y" }}{% endblock %}
{% block twitter_image %}
<meta name="twitter:image" content="{% if event.cover_image %}{{ request.scheme }}://{{ request.get_host }}{{ event.cover_image.url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/reckot_preview.png' %}{% endif %}">
<meta name="twitter:image:alt" content="{{ event.title }}">
{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Event",
    "name": "{{ event.title|escapejs }}",
    "description": "{{ event.description|striptags|truncatewords:50|escapejs }}",
    "startDate": "{{ event.start_at|date:'c' }}",
    "endDate": "{{ event.end_at|date:'c' }}",
    "eventStatus": "https://schema.org/EventScheduled",
    "eventAttendanceMode": "https://schema.org/{% if event.event_type == 'ONLINE' %}OnlineEventAttendanceMode{% elif event.event_type == 'HYBRID' %}MixedEventAttendanceMode{% else %}OfflineEventAttendanceMode{% endif %}",
    {% if event.cover_image %}"image": "{{ request.scheme }}://{{ request.get_host }}{{ event.cover_image.url }}",{% endif %}
    "location": {
        {% if event.event_type == 'ONLINE' %}
        "@type": "VirtualLocation",
        "url": "{{ request.build_absolute_uri }}"
        {% else %}
        "@type": "Place",
        "name": "{{ event.venue_name|default:event.location|escapejs }}",
        "address": {
            "@type": "PostalAddress",
            "streetAddress": "{{ event.location|escapejs }}",
            "addressLocality": "{{ event.city|default:'Douala'|escapejs }}",
            "addressCountry": "{{ event.country|default:'CM' }}"
        }
        {% endif %}
    },
    "organizer": {
        "@type": "Organization",
        "name": "{{ event.organization.name|escapejs }}",
        "url": "{{ request.scheme }}://{{ request.get_host }}"
    },
    {% if ticket_types %}"offers": [{% for tt in ticket_types %}
        {
            "@type": "Offer",
            "name": "{{ tt.name|escapejs }}",
            "price": "{{ tt.price }}",
            "priceCurrency": "XAF",
            "availability": "https://schema.org/{% if tt.is_available %}InStock{% else %}SoldOut{% endif %}",
            "url": "{{ request.build_absolute_uri }}",
            "validFrom": "{% if tt.sales_start %}{{ tt.sales_start|date:'c' }}{% else %}{{ event.created_at|date:'c' }}{% endif %}"
        }{% if not forloop.last %},{% endif %}{% endfor %}
    ],{% endif %}
    "url": "{{ request.build_absolute_uri }}"
}
</script>
{% endblock %}

{% block extra_head %}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 pb-24">
    <div class="max-w-4xl mx-auto">
        <div class="mb-6">
            <a href="{% url 'events:discover' %}" class="text-sm text-muted-foreground hover:text-foreground flex items-center gap-1">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                Back to events
            </a>
        </div>

        {% if event.cover_image %}
        <div class="mb-6 rounded-xl overflow-hidden">
            <img src="{{ event.cover_image.url }}" alt="{{ event.title }}" class="w-full h-64 sm:h-80 object-cover">
        </div>
        {% endif %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div class="card p-6 mb-6">
                    <div class="flex items-center gap-2 text-sm text-muted-foreground mb-4">
                        <span class="px-2 py-1 rounded bg-foreground/5">{{ event.organization.name }}</span>
                    </div>
                    <h1 class="text-3xl font-bold mb-4">{{ event.title }}</h1>

                    <div class="flex flex-wrap gap-4 mb-6 text-sm">
                        <div class="flex items-center gap-2">
                            <i data-lucide="calendar" class="w-5 h-5 text-muted-foreground"></i>
                            <div>
                                <div class="font-medium">{{ event.start_at|date:"l, F j, Y" }}</div>
                                <div class="text-muted-foreground">{{ event.start_at|time:"g:i A" }} - {{ event.end_at|time:"g:i A" }}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-5 h-5 text-muted-foreground"></i>
                            <div>
                                <div class="font-medium">{{ event.location }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="prose prose-sm dark:prose-invert max-w-none text-muted-foreground">{{ event.description|safe }}</div>
                </div>

                <div class="card p-6" x-data="{ shareOpen: false }">
                    <h3 class="font-semibold mb-4">Share this event</h3>
                    <div class="flex flex-wrap gap-2">
                        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" @click="$refs.shareTrack.submit()">
                            {% #button variant="outline" size="sm" %}
                                <i data-lucide="facebook" class="w-4 h-4"></i>
                            {% /button %}
                        </a>
                        <a href="https://twitter.com/intent/tweet?text={{ event.title|urlencode }}&url={{ request.build_absolute_uri }}" target="_blank">
                            {% #button variant="outline" size="sm" %}
                                <i data-lucide="twitter" class="w-4 h-4"></i>
                            {% /button %}
                        </a>
                        <a href="https://wa.me/?text={{ event.title|urlencode }}%20{{ request.build_absolute_uri }}" target="_blank">
                            {% #button variant="outline" size="sm" %}
                                <i data-lucide="message-circle" class="w-4 h-4"></i>
                            {% /button %}
                        </a>
                        <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri }}" target="_blank">
                            {% #button variant="outline" size="sm" %}
                                <i data-lucide="linkedin" class="w-4 h-4"></i>
                            {% /button %}
                        </a>
                        {% #button type="button" variant="outline" size="sm" attrs="@click=\"navigator.clipboard.writeText('{{ request.build_absolute_uri }}'); $dispatch('notice', {type: 'success', text: 'Link copied!'})\"" %}
                            <i data-lucide="link" class="w-4 h-4"></i>
                        {% /button %}
                    </div>
                    {% if flyer_enabled %}
                    <div class="mt-4 pt-4 border-t border-border">
                        <a href="{% url 'events:flyer_generator' org_slug=event.organization.slug event_slug=event.slug %}">
                            {% #button variant="default" size="sm" class="w-full" %}
                                <i data-lucide="image-plus" class="w-4 h-4 mr-2"></i>
                                Create "I Will Be There" Flyer
                            {% /button %}
                        </a>
                        <p class="text-xs text-muted-foreground mt-2 text-center">Generate a personalized flyer to share</p>
                    </div>
                    {% endif %}
                </div>

                {% if event.flyer_config.is_enabled %}
                <div class="card p-6 mt-6 bg-gradient-to-r from-primary/10 to-primary/5 border-primary/20">
                    <h3 class="font-semibold mb-2">I Will Be There!</h3>
                    <p class="text-sm text-muted-foreground mb-4">Create your personalized flyer to share</p>
                    <a href="{% url 'events:flyer_generator' org_slug=event.organization.slug event_slug=event.slug %}">
                        {% #button variant="default" size="sm" %}
                            <i data-lucide="image" class="w-4 h-4 mr-2"></i>
                            Create My Flyer
                        {% /button %}
                    </a>
                </div>
                {% endif %}
            </div>

            <div class="lg:col-span-1 self-start">
                <div class="card p-6 sticky top-24"
                     x-data="{
                         eventDate: new Date('{{ event.start_at|date:'Y-m-d' }}T{{ event.start_at|date:'H:i:s' }}'),
                         years: 0,
                         days: 0,
                         hours: 0,
                         minutes: 0,
                         seconds: 0,
                         isPast: false,
                         showYears: false,
                         init() {
                             this.updateCountdown();
                             setInterval(() => this.updateCountdown(), 1000);
                         },
                         updateCountdown() {
                             const now = new Date();
                             const diff = this.eventDate - now;
                             if (diff <= 0) {
                                 this.isPast = true;
                                 this.years = 0;
                                 this.days = 0;
                                 this.hours = 0;
                                 this.minutes = 0;
                                 this.seconds = 0;
                                 this.showYears = false;
                             } else {
                                 this.isPast = false;
                                 const totalDays = Math.floor(diff / (1000 * 60 * 60 * 24));
                                 if (totalDays >= 365) {
                                     this.showYears = true;
                                     this.years = Math.floor(totalDays / 365);
                                     this.days = totalDays % 365;
                                 } else {
                                     this.showYears = false;
                                     this.years = 0;
                                     this.days = totalDays;
                                 }
                                 this.hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                 this.minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                                 this.seconds = Math.floor((diff % (1000 * 60)) / 1000);
                             }
                         }
                     }">
                    <h3 class="font-semibold mb-4">Tickets</h3>

                    <div class="mb-4 p-3 rounded-lg bg-muted/50 border border-border" x-show="!isPast">
                        <div class="text-xs text-muted-foreground text-center mb-1">Event starts in</div>
                        <div class="flex justify-center gap-2 text-center">
                            <template x-if="showYears">
                                <div class="min-w-[32px]">
                                    <div class="text-base font-bold" x-text="years">0</div>
                                    <div class="text-[10px] text-muted-foreground">yrs</div>
                                </div>
                            </template>
                            <div class="min-w-[32px]">
                                <div class="text-base font-bold" x-text="days">0</div>
                                <div class="text-[10px] text-muted-foreground">days</div>
                            </div>
                            <div class="min-w-[32px]">
                                <div class="text-base font-bold" x-text="hours">0</div>
                                <div class="text-[10px] text-muted-foreground">hrs</div>
                            </div>
                            <div class="min-w-[32px]">
                                <div class="text-base font-bold" x-text="minutes">0</div>
                                <div class="text-[10px] text-muted-foreground">min</div>
                            </div>
                            <div class="min-w-[32px]">
                                <div class="text-base font-bold" x-text="seconds">0</div>
                                <div class="text-[10px] text-muted-foreground">sec</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 p-3 rounded-lg bg-primary/10 border border-primary/20 text-center" x-show="isPast" x-cloak>
                        <div class="text-sm font-medium text-primary">Event has started!</div>
                    </div>

                    {% if ticket_types %}
                    <form method="post" action="{% url 'payments:checkout' %}" class="space-y-4" hx-boost="false"
                          x-data="{
                              couponCode: '',
                              couponValid: null,
                              couponError: '',
                              couponDiscount: null,
                              discountType: '',
                              discountValue: 0,
                              async validateCoupon() {
                                  if (!this.couponCode.trim()) {
                                      this.couponValid = null;
                                      this.couponError = '';
                                      this.couponDiscount = null;
                                      return;
                                  }
                                  try {
                                      const response = await fetch('{% url 'events:validate_coupon' %}', {
                                          method: 'POST',
                                          headers: {
                                              'Content-Type': 'application/x-www-form-urlencoded',
                                              'X-CSRFToken': '{{ csrf_token }}'
                                          },
                                          body: `code=${encodeURIComponent(this.couponCode)}&event_id={{ event.id }}`
                                      });
                                      const data = await response.json();
                                      this.couponValid = data.valid;
                                      if (data.valid) {
                                          this.couponError = '';
                                          this.discountType = data.discount_type;
                                          this.discountValue = data.discount_value;
                                          this.couponDiscount = data.discount_type === 'PERCENTAGE'
                                              ? `${data.discount_value}% off`
                                              : `${data.discount_value} XAF off`;
                                      } else {
                                          this.couponError = data.error;
                                          this.couponDiscount = null;
                                      }
                                  } catch (e) {
                                      this.couponError = 'Failed to validate coupon';
                                      this.couponValid = false;
                                  }
                              }
                          }">
                        {% csrf_token %}
                        <input type="hidden" name="event_id" value="{{ event.id }}">
                        {% if affiliate_code %}
                        <input type="hidden" name="affiliate_code" value="{{ affiliate_code }}">
                        {% endif %}

                        {% if not user.is_authenticated %}
                        <div class="mb-4" x-data="{ expanded: false }">
                            <button type="button" @click="expanded = !expanded"
                                    class="w-full flex items-center justify-between p-3 rounded-lg bg-muted/50 hover:bg-muted/70 transition-colors">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center">
                                        <i data-lucide="user" class="w-3.5 h-3.5 text-primary"></i>
                                    </div>
                                    <span class="text-sm font-medium">Contact Info</span>
                                    <span class="text-xs text-muted-foreground" x-show="!expanded">(required)</span>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-muted-foreground transition-transform duration-200" :class="expanded ? 'rotate-180' : ''"><path d="m6 9 6 6 6-6"/></svg>
                            </button>
                            <div x-show="expanded" x-collapse x-cloak class="mt-3 space-y-2">
                                <div class="grid gap-2">
                                    <input type="text" name="guest_name" class="input w-full text-sm" required placeholder="Full name *">
                                    <input type="email" name="guest_email" class="input w-full text-sm" required placeholder="Email address *">
                                    <input type="tel" name="guest_phone" class="input w-full text-sm" placeholder="Phone (optional)">
                                </div>
                                <p class="text-[10px] text-muted-foreground">Tickets will be sent to this email</p>
                            </div>
                        </div>
                        {% endif %}

                        {% for ticket_type in ticket_types %}
                        <div class="border border-border rounded-lg p-4 {% if not ticket_type.is_available %}opacity-60{% endif %}">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-medium">{{ ticket_type.name }}</div>
                                    {% if ticket_type.description %}
                                    <div class="text-sm text-muted-foreground">{{ ticket_type.description|truncatewords:10 }}</div>
                                    {% endif %}
                                    {% if ticket_type.status_message %}
                                    <div class="text-xs text-warning mt-1">
                                        <i data-lucide="clock" class="w-3 h-3 inline"></i>
                                        {{ ticket_type.status_message }}
                                    </div>
                                    {% elif ticket_type.sales_started %}
                                    <div class="text-xs text-success mt-1">
                                        <i data-lucide="check-circle" class="w-3 h-3 inline"></i>
                                        Sales started!
                                    </div>
                                    {% elif ticket_type.sales_end and ticket_type.is_available %}
                                    <div class="text-xs text-warning mt-1">
                                        <i data-lucide="clock" class="w-3 h-3 inline"></i>
                                        Ends {{ ticket_type.sales_end|date:"M j, Y" }}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="text-lg font-bold">
                                    {% if ticket_type.price == 0 %}
                                    <span class="text-success">Free</span>
                                    {% else %}
                                    {{ ticket_type.price }} XAF
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="flex justify-between text-xs text-muted-foreground mb-1">
                                    <span>{{ ticket_type.sold|default:0 }} sold</span>
                                    <span>{{ ticket_type.available_quantity|default:ticket_type.quantity }} left</span>
                                </div>
                                <div class="w-full bg-muted rounded-full h-1.5 overflow-hidden">
                                    <div class="bg-primary h-full rounded-full transition-all duration-300"
                                         style="width: {% widthratio ticket_type.sold|default:0 ticket_type.quantity 100 %}%"></div>
                                </div>
                            </div>

                            {% if ticket_type.is_available %}
                            <div class="flex items-center gap-3">
                                <label class="text-sm text-muted-foreground">Qty:</label>
                                <select name="ticket_{{ ticket_type.id }}" class="input w-24 text-center">
                                    {% for i in "0123456789"|make_list %}
                                    {% if forloop.counter0 <= ticket_type.max_per_order %}
                                    <option value="{{ forloop.counter0 }}">{{ forloop.counter0 }}</option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                                {% if ticket_type.available_quantity < 10 and ticket_type.available_quantity > 0 %}
                                <span class="text-sm text-destructive">Only {{ ticket_type.available_quantity }} left!</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}

                        <div class="border-t border-border pt-4">
                            <label class="block text-sm font-medium mb-2">Have a coupon code?</label>
                            <div class="flex gap-2 items-center">
                                <input type="text" name="coupon_code" x-model="couponCode"
                                       placeholder="Enter code" class="input flex-1 uppercase font-mono text-sm h-9"
                                       @input.debounce.500ms="validateCoupon()">
                                {% #button type="button" variant="outline" size="sm" attrs='@click="validateCoupon()"' %}
                                    Apply
                                {% /button %}
                            </div>
                            <div x-show="couponValid === true" class="mt-2 text-sm text-success flex items-center gap-1" x-cloak>
                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                <span x-text="couponDiscount"></span> applied!
                            </div>
                            <div x-show="couponValid === false" class="mt-2 text-sm text-destructive flex items-center gap-1" x-cloak>
                                <i data-lucide="x-circle" class="w-4 h-4"></i>
                                <span x-text="couponError"></span>
                            </div>
                        </div>

                        {% if checkout_questions %}
                        <div class="border-t border-border pt-4 mt-4">
                            <h4 class="text-sm font-medium mb-3">Additional Information</h4>
                            {% for question in checkout_questions %}
                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-1">
                                    {{ question.question }}
                                    {% if question.is_required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {% if question.field_type == 'TEXT' %}
                                <input type="text" name="question_{{ question.id }}" class="input w-full" {% if question.is_required %}required{% endif %}>
                                {% elif question.field_type == 'TEXTAREA' %}
                                <textarea name="question_{{ question.id }}" rows="3" class="input w-full" {% if question.is_required %}required{% endif %}></textarea>
                                {% elif question.field_type == 'SELECT' %}
                                <select name="question_{{ question.id }}" class="input w-full" {% if question.is_required %}required{% endif %}>
                                    <option value="">Select...</option>
                                    {% for option in question.options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                                {% elif question.field_type == 'EMAIL' %}
                                <input type="email" name="question_{{ question.id }}" class="input w-full" {% if question.is_required %}required{% endif %}>
                                {% elif question.field_type == 'PHONE' %}
                                <input type="tel" name="question_{{ question.id }}" class="input w-full" {% if question.is_required %}required{% endif %}>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% #button type="submit" variant="default" class="w-full" %}
                            Get Tickets
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        {% /button %}
                    </form>
                    {% else %}
                    <p class="text-muted-foreground text-sm">No tickets available at this time.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
