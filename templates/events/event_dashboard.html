{% extends 'layouts/dashboard.html' %}
{% load slippers %}
{% load i18n %}

{% block title %}{{ event.title }} - {% trans "Dashboard" %} - Reckot{% endblock %}

{% block breadcrumbs %}
{% #breadcrumb class="mb-4" %}
    {% #breadcrumb_item href="/" %}{% trans "Home" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item href="/events/" %}{% trans "Events" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item %}{{ event.title|truncatewords:3 }}{% /breadcrumb_item %}
{% /breadcrumb %}
{% endblock %}

{% block header_title %}
<div>
    <h1 class="text-lg font-semibold line-clamp-1">{{ event.title }}</h1>
    <p class="text-sm text-muted-foreground">{{ event.organization.name }}</p>
</div>
{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-2">
    {% if event.state == 'PUBLISHED' %}
    <span class="inline-flex items-center rounded-full border border-success/20 bg-success/10 text-success px-2.5 py-0.5 text-xs font-semibold">{% trans "Live" %}</span>
    {% elif event.state == 'DRAFT' %}
    <span class="inline-flex items-center rounded-full border border-border bg-muted text-muted-foreground px-2.5 py-0.5 text-xs font-semibold">{% trans "Draft" %}</span>
    {% else %}
    <span class="inline-flex items-center rounded-full border border-warning/20 bg-warning/10 text-warning px-2.5 py-0.5 text-xs font-semibold">{{ event.state }}</span>
    {% endif %}

    {% if event.state == 'PUBLISHED' %}
    <a href="{{ public_url }}" target="_blank">
        {% #button variant="outline" size="sm" %}
            <i data-lucide="external-link" class="w-4 h-4"></i>
            {% trans "View Public" %}
        {% /button %}
    </a>
    {% elif preview_url %}
    <a href="{{ preview_url }}" target="_blank">
        {% #button variant="outline" size="sm" %}
            <i data-lucide="eye" class="w-4 h-4"></i>
            {% trans "Preview" %}
        {% /button %}
    </a>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    {% if event.state != 'PUBLISHED' %}
    <div class="rounded-lg border border-amber-500/30 bg-amber-500/10 p-4">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
            <div class="flex items-start gap-3">
                <i data-lucide="alert-circle" class="h-5 w-5 text-amber-500 shrink-0 mt-0.5"></i>
                <div>
                    <p class="font-medium text-amber-600">{% trans "Your event is not published yet" %}</p>
                    <p class="text-sm text-muted-foreground">{% trans "Publish your event to start selling tickets and allow attendees to view it." %}</p>
                </div>
            </div>
            <form method="post" action="{% url 'events:toggle_publish' event.organization.slug event.slug %}">
                {% csrf_token %}
                {% #button type="submit" variant="default" size="sm" %}
                    <i data-lucide="rocket" class="w-4 h-4 mr-1"></i>
                    {% trans "Publish Now" %}
                {% /button %}
            </form>
        </div>
    </div>
    {% endif %}

    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <div class="stat-card">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-lg bg-blue-500/10 flex items-center justify-center">
                    <i data-lucide="ticket" class="h-5 w-5 text-blue-500"></i>
                </div>
                <div>
                    <p class="text-2xl font-bold">{{ stats.tickets_sold }}</p>
                    <p class="text-xs text-muted-foreground">{% trans "Tickets Sold" %}</p>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                    <i data-lucide="wallet" class="h-5 w-5 text-emerald-500"></i>
                </div>
                <div>
                    <p class="text-2xl font-bold">{{ stats.revenue|floatformat:0 }} XAF</p>
                    <p class="text-xs text-muted-foreground">{% trans "Revenue" %}</p>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-lg bg-purple-500/10 flex items-center justify-center">
                    <i data-lucide="users" class="h-5 w-5 text-purple-500"></i>
                </div>
                <div>
                    <p class="text-2xl font-bold">{{ stats.checked_in }}</p>
                    <p class="text-xs text-muted-foreground">{% trans "Checked In" %}</p>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-lg bg-amber-500/10 flex items-center justify-center">
                    <i data-lucide="percent" class="h-5 w-5 text-amber-500"></i>
                </div>
                <div>
                    <p class="text-2xl font-bold">{{ stats.checkin_rate|floatformat:0 }}%</p>
                    <p class="text-xs text-muted-foreground">{% trans "Check-in Rate" %}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid gap-6 lg:grid-cols-3">
        <div class="lg:col-span-2 space-y-6">
            <div class="card p-6">
                <h2 class="text-lg font-semibold mb-4">{% trans "Quick Actions" %}</h2>
                <div class="grid gap-3 sm:grid-cols-2">
                    <a href="{{ edit_event_url }}" hx-boost="false" class="flex items-center gap-3 p-3 rounded-lg border border-border hover:bg-muted transition-colors">
                        <div class="h-10 w-10 rounded-lg bg-muted flex items-center justify-center">
                            <i data-lucide="pencil" class="h-5 w-5"></i>
                        </div>
                        <div>
                            <p class="font-medium">{% trans "Edit Event" %}</p>
                            <p class="text-xs text-muted-foreground">{% trans "Update event details" %}</p>
                        </div>
                    </a>
                    <a href="{{ manage_tickets_url }}" hx-boost="false" class="flex items-center gap-3 p-3 rounded-lg border border-border hover:bg-muted transition-colors">
                        <div class="h-10 w-10 rounded-lg bg-muted flex items-center justify-center">
                            <i data-lucide="ticket" class="h-5 w-5"></i>
                        </div>
                        <div>
                            <p class="font-medium">{% trans "Manage Tickets" %}</p>
                            <p class="text-xs text-muted-foreground">{% trans "Add or edit ticket types" %}</p>
                        </div>
                    </a>
                    <a href="{{ checkin_url }}" hx-boost="false" class="flex items-center gap-3 p-3 rounded-lg border border-border hover:bg-muted transition-colors">
                        <div class="h-10 w-10 rounded-lg bg-muted flex items-center justify-center">
                            <i data-lucide="scan" class="h-5 w-5"></i>
                        </div>
                        <div>
                            <p class="font-medium">{% trans "Check-in" %}</p>
                            <p class="text-xs text-muted-foreground">{% trans "Scan tickets at the door" %}</p>
                        </div>
                    </a>
                    <a href="{{ export_url }}" hx-boost="false" class="flex items-center gap-3 p-3 rounded-lg border border-border hover:bg-muted transition-colors">
                        <div class="h-10 w-10 rounded-lg bg-muted flex items-center justify-center">
                            <i data-lucide="download" class="h-5 w-5"></i>
                        </div>
                        <div>
                            <p class="font-medium">{% trans "Export Data" %}</p>
                            <p class="text-xs text-muted-foreground">{% trans "Download reports (PDF, CSV)" %}</p>
                        </div>
                    </a>
                    <a href="{{ analytics_url }}" hx-boost="false" class="flex items-center gap-3 p-3 rounded-lg border border-border hover:bg-muted transition-colors">
                        <div class="h-10 w-10 rounded-lg bg-muted flex items-center justify-center">
                            <i data-lucide="bar-chart-3" class="h-5 w-5"></i>
                        </div>
                        <div>
                            <p class="font-medium">{% trans "Analytics" %}</p>
                            <p class="text-xs text-muted-foreground">{% trans "View detailed reports" %}</p>
                        </div>
                    </a>
                    <a href="{{ flyer_config_url }}" hx-boost="false" class="flex items-center gap-3 p-3 rounded-lg border border-border hover:bg-muted transition-colors">
                        <div class="h-10 w-10 rounded-lg bg-muted flex items-center justify-center">
                            <i data-lucide="image" class="h-5 w-5"></i>
                        </div>
                        <div>
                            <p class="font-medium">{% trans "I Will Be There" %}</p>
                            <p class="text-xs text-muted-foreground">{% trans "Flyer generator for attendees" %}</p>
                        </div>
                    </a>
                </div>
            </div>

            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">{% trans "Event Details" %}</h2>
                    <a href="{{ edit_event_url }}">
                        {% #button variant="outline" size="sm" %}
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                            {% trans "Edit" %}
                        {% /button %}
                    </a>
                </div>
                <dl class="space-y-3 text-sm">
                    <div class="flex justify-between py-2 border-b border-border">
                        <dt class="text-muted-foreground">{% trans "Date" %}</dt>
                        <dd class="font-medium">{{ event.start_at|date:"F j, Y" }} {% trans "at" %} {{ event.start_at|time:"g:i A" }}</dd>
                    </div>
                    <div class="flex justify-between py-2 border-b border-border">
                        <dt class="text-muted-foreground">{% trans "Location" %}</dt>
                        <dd class="font-medium">{{ event.venue_name|default:event.location }}</dd>
                    </div>
                    <div class="flex justify-between py-2 border-b border-border">
                        <dt class="text-muted-foreground">{% trans "Type" %}</dt>
                        <dd class="font-medium">{{ event.get_event_type_display }}</dd>
                    </div>
                    <div class="flex justify-between py-2 border-b border-border">
                        <dt class="text-muted-foreground">{% trans "Capacity" %}</dt>
                        <dd class="font-medium">{% if event.capacity %}{{ event.capacity }}{% else %}{% trans "Unlimited" %}{% endif %}</dd>
                    </div>
                    <div class="flex justify-between py-2">
                        <dt class="text-muted-foreground">{% trans "Visibility" %}</dt>
                        <dd class="font-medium">{% if event.is_public %}{% trans "Public" %}{% else %}{% trans "Private" %}{% endif %}</dd>
                    </div>
                </dl>
            </div>
        </div>

        <div class="space-y-6">
            <div class="card p-6">
                <h2 class="text-lg font-semibold mb-4">{% trans "Event Status" %}</h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-sm font-medium text-foreground">{% trans "Published" %}</span>
                            <p class="text-xs text-muted-foreground">{% trans "Make event live for ticket sales" %}</p>
                        </div>
                        <form method="post" action="{% url 'events:toggle_publish' event.organization.slug event.slug %}">
                            {% csrf_token %}
                            {% if event.state == 'PUBLISHED' %}
                            {% #button type="submit" variant="outline" size="sm" %}
                                <i data-lucide="eye-off" class="w-4 h-4 mr-1"></i>
                                {% trans "Unpublish" %}
                            {% /button %}
                            {% else %}
                            {% #button type="submit" variant="default" size="sm" %}
                                <i data-lucide="rocket" class="w-4 h-4 mr-1"></i>
                                {% trans "Publish" %}
                            {% /button %}
                            {% endif %}
                        </form>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-sm font-medium text-foreground">{% trans "Public" %}</span>
                            <p class="text-xs text-muted-foreground">{% trans "Show in discover & search" %}</p>
                        </div>
                        <form method="post" action="{% url 'events:toggle_public' event.organization.slug event.slug %}">
                            {% csrf_token %}
                            {% if event.is_public %}
                            {% #button type="submit" variant="outline" size="sm" %}
                                <i data-lucide="lock" class="w-4 h-4 mr-1"></i>
                                {% trans "Make Private" %}
                            {% /button %}
                            {% else %}
                            {% #button type="submit" variant="default" size="sm" %}
                                <i data-lucide="globe" class="w-4 h-4 mr-1"></i>
                                {% trans "Make Public" %}
                            {% /button %}
                            {% endif %}
                        </form>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-sm font-medium text-foreground">{% trans "Featured" %}</span>
                            <p class="text-xs text-muted-foreground">{% trans "Highlighted on homepage" %}</p>
                        </div>
                        {% if event.is_featured %}
                        <span class="inline-flex items-center gap-1 text-sm text-success">
                            <i data-lucide="check-circle" class="w-4 h-4"></i>
                            {% trans "Active" %}
                        </span>
                        {% else %}
                        <span class="text-sm text-muted-foreground">{% trans "Not featured" %}</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if event.state != 'PUBLISHED' %}
            <div class="card p-6" x-data="{ copied: false }">
                <h2 class="text-lg font-semibold mb-2">{% trans "Share Preview" %}</h2>
                <p class="text-sm text-muted-foreground mb-4">{% trans "Share a preview link with others before publishing. They can view the event but cannot purchase tickets." %}</p>

                {% if preview_url %}
                <div class="flex gap-2 mb-3">
                    <input type="text" value="{{ request.scheme }}://{{ request.get_host }}{{ preview_url }}" readonly
                           class="input flex-1 text-xs bg-muted" id="preview-link">
                    <button type="button" @click="navigator.clipboard.writeText(document.getElementById('preview-link').value); copied = true; setTimeout(() => copied = false, 2000)"
                            class="btn btn-outline btn-sm">
                        <i x-show="!copied" data-lucide="copy" class="w-4 h-4"></i>
                        <i x-show="copied" data-lucide="check" class="w-4 h-4 text-success" x-cloak></i>
                    </button>
                </div>
                <form method="post" action="{% url 'events:generate_preview' event.organization.slug event.slug %}">
                    {% csrf_token %}
                    {% #button type="submit" variant="outline" size="sm" class="w-full" %}
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        {% trans "Regenerate Link" %}
                    {% /button %}
                </form>
                {% else %}
                <form method="post" action="{% url 'events:generate_preview' event.organization.slug event.slug %}">
                    {% csrf_token %}
                    {% #button type="submit" variant="default" size="sm" class="w-full" %}
                        <i data-lucide="link" class="w-4 h-4"></i>
                        {% trans "Generate Preview Link" %}
                    {% /button %}
                </form>
                {% endif %}
            </div>
            {% endif %}

            {% if event.state == 'PUBLISHED' and event.is_public and not event.is_featured %}
            <div class="card p-6" x-data="{ showTerms: false }">
                <h2 class="text-lg font-semibold mb-2">{% trans "Get Featured" %}</h2>
                <p class="text-sm text-muted-foreground mb-4">{% trans "Apply to have your event featured on the Reckot homepage for maximum visibility." %}</p>

                {% if event.feature_requested_at and not event.feature_rejection_reason %}
                <div role="alert" class="relative w-full rounded-lg border border-warning/50 text-warning bg-warning/10 p-4">
                    <i data-lucide="clock" class="h-4 w-4 absolute left-4 top-4"></i>
                    <div class="pl-7">
                        <div class="text-sm font-medium">{% trans "Feature request pending review" %}</div>
                        <p class="text-xs mt-1 opacity-80">{% trans "Our team will review your event and get back to you within 24-48 hours." %}</p>
                    </div>
                </div>
                {% elif event.feature_rejection_reason %}
                <div role="alert" class="relative w-full rounded-lg border border-destructive/50 text-destructive bg-destructive/10 p-4">
                    <h5 class="mb-1 font-medium leading-none tracking-tight">{% trans "Request declined" %}</h5>
                    <div class="text-sm mt-1">{{ event.feature_rejection_reason }}</div>
                </div>
                {% #button type="button" variant="default" size="sm" class="w-full mt-3" attrs='@click="showTerms = true"' %}
                    <i data-lucide="star" class="w-4 h-4"></i>
                    {% trans "Re-apply for Feature" %}
                {% /button %}
                {% else %}
                {% #button type="button" variant="default" size="sm" class="w-full" attrs='@click="showTerms = true"' %}
                    <i data-lucide="star" class="w-4 h-4"></i>
                    {% trans "Apply for Feature" %}
                {% /button %}
                {% endif %}

                {% #modal trigger="showTerms" title="Featured Event - Terms & Conditions" size="lg" %}
                    <div class="space-y-4 text-sm max-h-[50vh] overflow-y-auto">
                        <div>
                            <h4 class="font-semibold mb-2">1. Feature Placement</h4>
                            <p class="text-muted-foreground">
                                Featured events are displayed prominently on the Reckot homepage and in the "Featured Events" section of the discover page. Placement is at our discretion based on event quality, relevance, and timing.
                            </p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">2. Eligibility Requirements</h4>
                            <p class="text-muted-foreground">To be eligible for featuring, your event must:</p>
                            <ul class="list-disc list-inside text-muted-foreground mt-2 space-y-1">
                                <li>Be published and publicly visible</li>
                                <li>Have a complete event description and cover image</li>
                                <li>Be scheduled at least 7 days in the future</li>
                                <li>Comply with our community guidelines and terms of service</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">3. Review Process</h4>
                            <p class="text-muted-foreground">
                                All feature requests are reviewed by our team within <strong>24-48 hours</strong>. We may approve, reject, or request modifications to your event before featuring.
                            </p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">4. Feature Duration</h4>
                            <p class="text-muted-foreground">
                                Featured status typically lasts until your event date or up to <strong>30 days</strong>, whichever comes first. We reserve the right to remove featured status at any time.
                            </p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">5. No Guarantee</h4>
                            <p class="text-muted-foreground">
                                Submitting a feature request does not guarantee approval. Our team evaluates each request based on content quality, relevance to our audience, and available feature slots.
                            </p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">6. Content Standards</h4>
                            <p class="text-muted-foreground">
                                By applying, you confirm that your event content is accurate, not misleading, and does not violate any laws or third-party rights.
                            </p>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        {% #button variant="outline" class="flex-1" attrs='@click="showTerms = false"' %}
                            {% trans "Cancel" %}
                        {% /button %}
                        <form method="post" action="{% url 'events:apply_feature' event.organization.slug event.slug %}" class="flex-1">
                            {% csrf_token %}
                            {% #button type="submit" variant="default" class="w-full" %}
                                <i data-lucide="check" class="w-4 h-4 mr-1"></i>
                                {% trans "I Accept & Apply" %}
                            {% /button %}
                        </form>
                    </div>
                {% /modal %}
            </div>
            {% endif %}

            {% if event.is_featured %}
            <div class="card p-6 border-amber-500/50 bg-amber-500/5">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="star" class="w-5 h-5 text-amber-500"></i>
                    <h2 class="text-lg font-semibold">{% trans "Featured Event" %}</h2>
                </div>
                <p class="text-sm text-muted-foreground">{% trans "Your event is currently featured on the homepage!" %}</p>
                {% if event.feature_expires_at %}
                <p class="text-xs text-muted-foreground mt-2">{% trans "Expires" %}: {{ event.feature_expires_at|date:"M j, Y" }}</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
