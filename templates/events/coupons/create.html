{% extends "layouts/dashboard.html" %}
{% load slippers %}
{% load i18n %}

{% block title %}{% trans "Create Coupon" %} - Reckot{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script>
window.couponPageData = {
    organizations: [{% for org in organizations %}
        {id:'{{ org.id }}',name:"{{ org.name|escapejs }}"}{% if not forloop.last %},{% endif %}
    {% endfor %}],
    events: [{% for event in events %}
        {id:'{{ event.id }}',title:"{{ event.title|escapejs }}",org:"{{ event.organization.name|escapejs }}",endAt:'{{ event.end_at|date:"Y-m-d H:i" }}'}{% if not forloop.last %},{% endif %}
    {% endfor %}]
};
</script>
{% endblock %}

{% block breadcrumbs %}
{% #breadcrumb class="mb-4" %}
    {% #breadcrumb_item href="/" %}{% trans "Home" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item href="/events/coupons/" %}{% trans "Coupons" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item %}{% trans "Create" %}{% /breadcrumb_item %}
{% /breadcrumb %}
{% endblock %}

{% block header_title %}
<div class="min-w-0">
    <h1 class="text-lg font-semibold truncate">{% trans "Create Coupon" %}</h1>
    <p class="text-sm text-muted-foreground hidden md:block">{% trans "Create a new discount code" %}</p>
</div>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto" hx-boost="false">
    <form method="post" class="space-y-6" data-controller="coupon-form">
        {% csrf_token %}

        {% if error %}
        <div class="rounded-lg bg-red-500/10 border border-red-500/20 p-4 text-sm text-red-500">
            {{ error }}
        </div>
        {% endif %}

        <div class="card p-6 space-y-4">
            <h2 class="text-lg font-semibold">{% trans "Basic Information" %}</h2>

            <div>
                <label for="organization" class="block text-sm font-medium mb-2">{% trans "Organization" %}</label>
                <div class="custom-select-wrapper" data-controller="dropdown">
                    <input type="hidden" id="organization" name="organization" data-dropdown-target="value" required>
                    <button type="button" data-action="click->dropdown#toggle" data-dropdown-target="trigger"
                            class="custom-select-trigger">
                        <span class="custom-select-value custom-select-placeholder" data-dropdown-target="label">{% trans "Select organization" %}</span>
                        <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4"></i>
                    </button>
                    <div data-dropdown-target="menu" class="custom-select-dropdown hidden">
                        <div class="custom-select-options" data-dropdown-target="options">
                            {% for org in organizations %}
                            <button type="button" data-action="click->dropdown#select"
                                    data-dropdown-value="{{ org.id }}"
                                    data-dropdown-label="{{ org.name }}"
                                    class="custom-select-option">
                                <span>{{ org.name }}</span>
                                <svg class="custom-select-check w-4 h-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label for="event" class="block text-sm font-medium mb-2">{% trans "Event (optional)" %}</label>
                <div class="custom-select-wrapper" data-controller="dropdown">
                    <input type="hidden" id="event" name="event" data-dropdown-target="value">
                    <button type="button" data-action="click->dropdown#toggle" data-dropdown-target="trigger"
                            class="custom-select-trigger">
                        <span class="custom-select-value custom-select-placeholder" data-dropdown-target="label">{% trans "All events in organization" %}</span>
                        <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4"></i>
                    </button>
                    <div data-dropdown-target="menu" class="custom-select-dropdown hidden">
                        <div class="custom-select-search">
                            <svg class="custom-select-search-icon w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            <input type="text" data-dropdown-target="search" data-action="input->dropdown#filter" placeholder="{% trans 'Search events...' %}" class="custom-select-search-input">
                        </div>
                        <div class="custom-select-options" data-dropdown-target="options">
                            <button type="button" data-action="click->dropdown#select"
                                    data-dropdown-value=""
                                    data-dropdown-label="{% trans 'All events in organization' %}"
                                    class="custom-select-option">
                                <span>{% trans "All events in organization" %}</span>
                                <svg class="custom-select-check w-4 h-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            </button>
                            {% for event in events %}
                            <button type="button" data-action="click->dropdown#select"
                                    data-dropdown-value="{{ event.id }}"
                                    data-dropdown-label="{{ event.title }} ({{ event.organization.name }})"
                                    data-dropdown-searchable="{{ event.title }} {{ event.organization.name }}"
                                    class="custom-select-option">
                                <span>{{ event.title }} ({{ event.organization.name }})</span>
                                <svg class="custom-select-check w-4 h-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <p class="text-xs text-muted-foreground mt-1">{% trans "Leave empty to apply to all events in the organization" %}</p>
            </div>

            <div>
                <label for="code" class="block text-sm font-medium mb-2">{% trans "Coupon Code" %}</label>
                <input type="text" name="code" id="code" placeholder="{% trans "SAVE20 (leave empty to auto-generate)" %}" class="input font-mono uppercase">
                <p class="text-xs text-muted-foreground mt-1">{% trans "Letters and numbers only, will be auto-generated if empty" %}</p>
            </div>

            <div>
                <label for="description" class="block text-sm font-medium mb-2">{% trans "Description (optional)" %}</label>
                <input type="text" name="description" id="description" placeholder="{% trans "Early bird discount" %}" class="input">
            </div>
        </div>

        <div class="card p-6 space-y-4">
            <h2 class="text-lg font-semibold">{% trans "Discount Settings" %}</h2>

            <div class="grid gap-4 sm:grid-cols-2">
                <div>
                    <label for="discount_type" class="block text-sm font-medium mb-2">{% trans "Discount Type" %}</label>
                    <div class="custom-select-wrapper" data-controller="dropdown">
                        <input type="hidden" id="discount_type" name="discount_type" data-dropdown-target="value" value="PERCENTAGE" required>
                        <button type="button" data-action="click->dropdown#toggle" data-dropdown-target="trigger"
                                class="custom-select-trigger">
                            <span class="custom-select-value" data-dropdown-target="label">{% trans "Percentage" %}</span>
                            <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4"></i>
                        </button>
                        <div data-dropdown-target="menu" class="custom-select-dropdown hidden">
                            <div class="custom-select-options">
                                <button type="button" data-action="click->dropdown#select"
                                        data-dropdown-value="PERCENTAGE"
                                        data-dropdown-label="{% trans 'Percentage' %}"
                                        class="custom-select-option custom-select-option-selected">
                                    <span>{% trans "Percentage" %}</span>
                                    <svg class="custom-select-check w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                </button>
                                <button type="button" data-action="click->dropdown#select"
                                        data-dropdown-value="FIXED"
                                        data-dropdown-label="{% trans 'Fixed Amount' %}"
                                        class="custom-select-option">
                                    <span>{% trans "Fixed Amount" %}</span>
                                    <svg class="custom-select-check w-4 h-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="discount_value" class="block text-sm font-medium mb-2">{% trans "Discount Value" %}</label>
                    <input type="number" name="discount_value" id="discount_value" required min="0" step="0.01" placeholder="10" class="input">
                </div>
            </div>

            <div>
                <label for="max_uses" class="block text-sm font-medium mb-2">{% trans "Maximum Uses" %}</label>
                <input type="number" name="max_uses" id="max_uses" min="0" value="1" placeholder="1" class="input">
                <p class="text-xs text-muted-foreground mt-1">{% trans "Set to 0 for unlimited uses" %}</p>
            </div>
        </div>

        <div class="card p-6 space-y-4">
            <h2 class="text-lg font-semibold">{% trans "Assignment" %}</h2>

            <div>
                <label for="assignment_type" class="block text-sm font-medium mb-2">{% trans "Who can use this coupon?" %}</label>
                <div class="custom-select-wrapper" data-controller="dropdown">
                    <input type="hidden" id="assignment_type" name="assignment_type" data-dropdown-target="value" value="PUBLIC" required>
                    <button type="button" data-action="click->dropdown#toggle" data-dropdown-target="trigger"
                            class="custom-select-trigger">
                        <span class="custom-select-value" data-dropdown-target="label">{% trans "Anyone (Public)" %}</span>
                        <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4"></i>
                    </button>
                    <div data-dropdown-target="menu" class="custom-select-dropdown hidden">
                        <div class="custom-select-options">
                            <button type="button" data-action="click->dropdown#select"
                                    data-dropdown-value="PUBLIC"
                                    data-dropdown-label="{% trans 'Anyone (Public)' %}"
                                    data-coupon-form-target="assignmentType"
                                    data-action="click->dropdown#select click->coupon-form#updateAssignment"
                                    class="custom-select-option custom-select-option-selected">
                                <span>{% trans "Anyone (Public)" %}</span>
                                <svg class="custom-select-check w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            </button>
                            <button type="button" data-action="click->dropdown#select click->coupon-form#updateAssignment"
                                    data-dropdown-value="INDIVIDUAL"
                                    data-dropdown-label="{% trans 'Specific person' %}"
                                    data-coupon-form-target="assignmentType"
                                    class="custom-select-option">
                                <span>{% trans "Specific person" %}</span>
                                <svg class="custom-select-check w-4 h-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            </button>
                            <button type="button" data-action="click->dropdown#select click->coupon-form#updateAssignment"
                                    data-dropdown-value="GROUP"
                                    data-dropdown-label="{% trans 'Group of people' %}"
                                    data-coupon-form-target="assignmentType"
                                    class="custom-select-option">
                                <span>{% trans "Group of people" %}</span>
                                <svg class="custom-select-check w-4 h-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div data-coupon-form-target="individualEmail" class="hidden">
                <label for="assigned_email" class="block text-sm font-medium mb-2">{% trans "Assigned Email" %}</label>
                <input type="email" name="assigned_email" id="assigned_email" placeholder="user@example.com" class="input">
                <p class="text-xs text-muted-foreground mt-1">{% trans "Only this email address can use the coupon" %}</p>
            </div>

            <div data-coupon-form-target="groupEmails" class="hidden">
                <label for="assigned_emails" class="block text-sm font-medium mb-2">{% trans "Assigned Emails" %}</label>
                <textarea name="assigned_emails" id="assigned_emails" rows="3" placeholder="user1@example.com, user2@example.com, user3@example.com" class="input"></textarea>
                <p class="text-xs text-muted-foreground mt-1">{% trans "Comma-separated list of email addresses" %}</p>
            </div>
        </div>

        <div class="card p-6 space-y-4">
            <h2 class="text-lg font-semibold">{% trans "Validity Period" %}</h2>
            <p class="text-sm text-muted-foreground -mt-2">{% trans "Both fields are optional. Defaults to starting today with no end date." %}</p>

            <div class="grid gap-4 sm:grid-cols-2">
                {% #datepicker name="valid_from" id="valid_from" label="Valid From" placeholder="Starts today by default" enable_time=True %}{% /datepicker %}

                <div>
                    {% #datepicker name="valid_until" id="valid_until" label="Valid Until" placeholder="No end date" enable_time=True %}{% /datepicker %}
                    <p class="text-xs text-muted-foreground mt-1" data-coupon-form-target="eventWarning" class="hidden">{% trans "Cannot be after the event end date" %}</p>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-4">
            {% #button type="submit" variant="default" %}
                {% trans "Create Coupon" %}
                <i data-lucide="check" class="w-4 h-4"></i>
            {% /button %}
            <a href="{% url 'events:coupons' %}">{% #button variant="outline" %}{% trans "Cancel" %}{% /button %}</a>
        </div>
    </form>
</div>

<script>
// Stimulus controller for coupon form
import { Controller } from "@hotwired/stimulus"

class CouponFormController extends Controller {
    static targets = ["assignmentType", "individualEmail", "groupEmails", "eventWarning"]

    connect() {
        this.updateAssignment()
    }

    updateAssignment() {
        const assignmentInput = document.getElementById('assignment_type')
        const assignmentType = assignmentInput ? assignmentInput.value : 'PUBLIC'

        // Hide all conditional fields
        if (this.hasIndividualEmailTarget) {
            this.individualEmailTarget.classList.add('hidden')
        }
        if (this.hasGroupEmailsTarget) {
            this.groupEmailsTarget.classList.add('hidden')
        }

        // Show relevant field
        if (assignmentType === 'INDIVIDUAL' && this.hasIndividualEmailTarget) {
            this.individualEmailTarget.classList.remove('hidden')
        } else if (assignmentType === 'GROUP' && this.hasGroupEmailsTarget) {
            this.groupEmailsTarget.classList.remove('hidden')
        }
    }
}

// Register the controller if Stimulus is available
if (window.Stimulus) {
    window.Stimulus.register("coupon-form", CouponFormController)
}
</script>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const validFromEl = document.getElementById('valid_from');
    const validUntilEl = document.getElementById('valid_until');

    if (validFromEl && validUntilEl) {
        flatpickr(validFromEl, {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            altInput: true,
            altFormat: "F j, Y at h:i K",
            time_24hr: false,
            minuteIncrement: 15
        });

        flatpickr(validUntilEl, {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            altInput: true,
            altFormat: "F j, Y at h:i K",
            time_24hr: false,
            minuteIncrement: 15
        });
    }
});
</script>
{% endblock %}
