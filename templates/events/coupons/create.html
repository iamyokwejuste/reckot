{% extends "layouts/dashboard.html" %}
{% load slippers %}
{% load i18n %}

{% block title %}{% trans "Create Coupon" %} - Reckot{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block breadcrumbs %}
{% #breadcrumb class="mb-4" %}
    {% #breadcrumb_item href="/" %}{% trans "Home" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item href="/events/coupons/" %}{% trans "Coupons" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item %}{% trans "Create" %}{% /breadcrumb_item %}
{% /breadcrumb %}
{% endblock %}

{% block header_title %}
<div class="min-w-0">
    <h1 class="text-lg font-semibold truncate">{% trans "Create Coupon" %}</h1>
    <p class="text-sm text-muted-foreground hidden md:block">{% trans "Create a new discount code" %}</p>
</div>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <form method="post" class="space-y-6" x-data="{
        assignmentType: 'PUBLIC',
        assignmentLabel: 'Anyone (Public)',
        discountType: 'PERCENTAGE',
        discountLabel: 'Percentage',
        selectedOrg: '',
        selectedOrgLabel: '',
        selectedEvent: '',
        selectedEventLabel: '',
        eventDates: {
            {% for event in events %}
            '{{ event.id }}': '{{ event.end_at|date:'Y-m-d H:i' }}',
            {% endfor %}
        },
        getMaxDate() {
            if (this.selectedEvent && this.eventDates[this.selectedEvent]) {
                return this.eventDates[this.selectedEvent];
            }
            return null;
        }
    }">
        {% csrf_token %}

        {% if error %}
        <div class="rounded-lg bg-red-500/10 border border-red-500/20 p-4 text-sm text-red-500">
            {{ error }}
        </div>
        {% endif %}

        <div class="card p-6 space-y-4">
            <h2 class="text-lg font-semibold">{% trans "Basic Information" %}</h2>

            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Organization" %}</label>
                <div class="custom-select-wrapper" x-data="{ open: false }">
                    <input type="hidden" name="organization" :value="selectedOrg" required>
                    <button type="button" @click="open = !open" @click.outside="open = false"
                            class="custom-select-trigger" :class="{ 'custom-select-trigger-active': open }">
                        <span class="custom-select-value" :class="{ 'custom-select-placeholder': !selectedOrgLabel }" x-text="selectedOrgLabel || '{% trans "Select organization" %}'"></span>
                        <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4" :class="{ 'rotate-180': open }"></i>
                    </button>
                    <div x-show="open" x-transition @click.outside="open = false" class="custom-select-dropdown" x-cloak>
                        <div class="custom-select-options">
                            {% for org in organizations %}
                            <button type="button" @click="selectedOrg = '{{ org.id }}'; selectedOrgLabel = '{{ org.name|escapejs }}'; open = false"
                                    class="custom-select-option" :class="{ 'custom-select-option-selected': selectedOrg === '{{ org.id }}' }">
                                <span>{{ org.name }}</span>
                                <i x-show="selectedOrg === '{{ org.id }}'" data-lucide="check" class="custom-select-check w-4 h-4"></i>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Event (optional)" %}</label>
                <div class="custom-select-wrapper" x-data="{ open: false }">
                    <input type="hidden" name="event" :value="selectedEvent">
                    <button type="button" @click="open = !open" @click.outside="open = false"
                            class="custom-select-trigger" :class="{ 'custom-select-trigger-active': open }">
                        <span class="custom-select-value" :class="{ 'custom-select-placeholder': !selectedEventLabel }" x-text="selectedEventLabel || '{% trans "All events in organization" %}'"></span>
                        <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4" :class="{ 'rotate-180': open }"></i>
                    </button>
                    <div x-show="open" x-transition @click.outside="open = false" class="custom-select-dropdown" x-cloak>
                        <div class="custom-select-options">
                            <button type="button" @click="selectedEvent = ''; selectedEventLabel = ''; open = false; updateValidUntilMax()"
                                    class="custom-select-option" :class="{ 'custom-select-option-selected': selectedEvent === '' }">
                                <span>{% trans "All events in organization" %}</span>
                                <i x-show="selectedEvent === ''" data-lucide="check" class="custom-select-check w-4 h-4"></i>
                            </button>
                            {% for event in events %}
                            <button type="button" @click="selectedEvent = '{{ event.id }}'; selectedEventLabel = '{{ event.title|escapejs }} ({{ event.organization.name|escapejs }})'; open = false; updateValidUntilMax()"
                                    class="custom-select-option" :class="{ 'custom-select-option-selected': selectedEvent === '{{ event.id }}' }">
                                <span>{{ event.title }} ({{ event.organization.name }})</span>
                                <i x-show="selectedEvent === '{{ event.id }}'" data-lucide="check" class="custom-select-check w-4 h-4"></i>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <p class="text-xs text-muted-foreground mt-1">{% trans "Leave empty to apply to all events in the organization" %}</p>
            </div>

            <div>
                <label for="code" class="block text-sm font-medium mb-2">{% trans "Coupon Code" %}</label>
                <input type="text" name="code" id="code" placeholder="{% trans "SAVE20 (leave empty to auto-generate)" %}" class="input font-mono uppercase">
                <p class="text-xs text-muted-foreground mt-1">{% trans "Letters and numbers only, will be auto-generated if empty" %}</p>
            </div>

            <div>
                <label for="description" class="block text-sm font-medium mb-2">{% trans "Description (optional)" %}</label>
                <input type="text" name="description" id="description" placeholder="{% trans "Early bird discount" %}" class="input">
            </div>
        </div>

        <div class="card p-6 space-y-4">
            <h2 class="text-lg font-semibold">{% trans "Discount Settings" %}</h2>

            <div class="grid gap-4 sm:grid-cols-2">
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Discount Type" %}</label>
                    <div class="custom-select-wrapper" x-data="{ open: false }">
                        <input type="hidden" name="discount_type" :value="discountType" required>
                        <button type="button" @click="open = !open" @click.outside="open = false"
                                class="custom-select-trigger" :class="{ 'custom-select-trigger-active': open }">
                            <span class="custom-select-value" x-text="discountLabel"></span>
                            <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4" :class="{ 'rotate-180': open }"></i>
                        </button>
                        <div x-show="open" x-transition @click.outside="open = false" class="custom-select-dropdown" x-cloak>
                            <div class="custom-select-options">
                                <button type="button" @click="discountType = 'PERCENTAGE'; discountLabel = '{% trans "Percentage" %}'; open = false"
                                        class="custom-select-option" :class="{ 'custom-select-option-selected': discountType === 'PERCENTAGE' }">
                                    <span>{% trans "Percentage" %}</span>
                                    <i x-show="discountType === 'PERCENTAGE'" data-lucide="check" class="custom-select-check w-4 h-4"></i>
                                </button>
                                <button type="button" @click="discountType = 'FIXED'; discountLabel = '{% trans "Fixed Amount" %}'; open = false"
                                        class="custom-select-option" :class="{ 'custom-select-option-selected': discountType === 'FIXED' }">
                                    <span>{% trans "Fixed Amount" %}</span>
                                    <i x-show="discountType === 'FIXED'" data-lucide="check" class="custom-select-check w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="discount_value" class="block text-sm font-medium mb-2">{% trans "Discount Value" %}</label>
                    <input type="number" name="discount_value" id="discount_value" required min="0" step="0.01" placeholder="10" class="input">
                </div>
            </div>

            <div>
                <label for="max_uses" class="block text-sm font-medium mb-2">{% trans "Maximum Uses" %}</label>
                <input type="number" name="max_uses" id="max_uses" min="0" value="1" placeholder="1" class="input">
                <p class="text-xs text-muted-foreground mt-1">{% trans "Set to 0 for unlimited uses" %}</p>
            </div>
        </div>

        <div class="card p-6 space-y-4">
            <h2 class="text-lg font-semibold">{% trans "Assignment" %}</h2>

            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Who can use this coupon?" %}</label>
                <div class="custom-select-wrapper" x-data="{ open: false }">
                    <input type="hidden" name="assignment_type" :value="assignmentType" required>
                    <button type="button" @click="open = !open" @click.outside="open = false"
                            class="custom-select-trigger" :class="{ 'custom-select-trigger-active': open }">
                        <span class="custom-select-value" x-text="assignmentLabel"></span>
                        <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4" :class="{ 'rotate-180': open }"></i>
                    </button>
                    <div x-show="open" x-transition @click.outside="open = false" class="custom-select-dropdown" x-cloak>
                        <div class="custom-select-options">
                            <button type="button" @click="assignmentType = 'PUBLIC'; assignmentLabel = '{% trans "Anyone (Public)" %}'; open = false"
                                    class="custom-select-option" :class="{ 'custom-select-option-selected': assignmentType === 'PUBLIC' }">
                                <span>{% trans "Anyone (Public)" %}</span>
                                <i x-show="assignmentType === 'PUBLIC'" data-lucide="check" class="custom-select-check w-4 h-4"></i>
                            </button>
                            <button type="button" @click="assignmentType = 'INDIVIDUAL'; assignmentLabel = '{% trans "Specific person" %}'; open = false"
                                    class="custom-select-option" :class="{ 'custom-select-option-selected': assignmentType === 'INDIVIDUAL' }">
                                <span>{% trans "Specific person" %}</span>
                                <i x-show="assignmentType === 'INDIVIDUAL'" data-lucide="check" class="custom-select-check w-4 h-4"></i>
                            </button>
                            <button type="button" @click="assignmentType = 'GROUP'; assignmentLabel = '{% trans "Group of people" %}'; open = false"
                                    class="custom-select-option" :class="{ 'custom-select-option-selected': assignmentType === 'GROUP' }">
                                <span>{% trans "Group of people" %}</span>
                                <i x-show="assignmentType === 'GROUP'" data-lucide="check" class="custom-select-check w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="assignmentType === 'INDIVIDUAL'" x-cloak>
                <label for="assigned_email" class="block text-sm font-medium mb-2">{% trans "Assigned Email" %}</label>
                <input type="email" name="assigned_email" id="assigned_email" placeholder="user@example.com" class="input">
                <p class="text-xs text-muted-foreground mt-1">{% trans "Only this email address can use the coupon" %}</p>
            </div>

            <div x-show="assignmentType === 'GROUP'" x-cloak>
                <label for="assigned_emails" class="block text-sm font-medium mb-2">{% trans "Assigned Emails" %}</label>
                <textarea name="assigned_emails" id="assigned_emails" rows="3" placeholder="user1@example.com, user2@example.com, user3@example.com" class="input"></textarea>
                <p class="text-xs text-muted-foreground mt-1">{% trans "Comma-separated list of email addresses" %}</p>
            </div>
        </div>

        <div class="card p-6 space-y-4">
            <h2 class="text-lg font-semibold">{% trans "Validity Period" %}</h2>
            <p class="text-sm text-muted-foreground -mt-2">{% trans "Both fields are optional. Defaults to starting today with no end date." %}</p>

            <div class="grid gap-4 sm:grid-cols-2">
                {% #datepicker name="valid_from" id="valid_from" label="Valid From" placeholder="Starts today by default" enable_time=True %}{% /datepicker %}

                <div>
                    {% #datepicker name="valid_until" id="valid_until" label="Valid Until" placeholder="No end date" enable_time=True %}{% /datepicker %}
                    <p class="text-xs text-muted-foreground mt-1" x-show="selectedEvent" x-cloak>{% trans "Cannot be after the event end date" %}</p>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-4">
            {% #button type="submit" variant="default" %}
                {% trans "Create Coupon" %}
                <i data-lucide="check" class="w-4 h-4"></i>
            {% /button %}
            <a href="{% url 'events:coupons' %}">{% #button variant="outline" %}{% trans "Cancel" %}{% /button %}</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
{% include "partials/datepicker_init.html" %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const eventDates = {
        {% for event in events %}
        '{{ event.id }}': '{{ event.end_at|date:"Y-m-d H:i" }}',
        {% endfor %}
    };

    const validFromEl = document.getElementById('valid_from');
    const validUntilEl = document.getElementById('valid_until');

    setTimeout(function() {
        const validFromPicker = validFromEl._flatpickr;
        const validUntilPicker = validUntilEl._flatpickr;

        if (validFromPicker && validUntilPicker) {
            validFromPicker.config.onChange.push(function(selectedDates) {
                if (selectedDates[0]) {
                    validUntilPicker.set('minDate', selectedDates[0]);
                }
            });

            const eventSelect = document.querySelector('[name="event"]').closest('.custom-select-wrapper').querySelector('input[type="hidden"]');
            window.updateValidUntilMax = function() {
                const selectedEventId = eventSelect.value;
                if (selectedEventId && eventDates[selectedEventId]) {
                    const eventEndDate = new Date(eventDates[selectedEventId]);
                    validUntilPicker.set('maxDate', eventEndDate);
                } else {
                    validUntilPicker.set('maxDate', null);
                }
            };
        }
    }, 100);

    const form = document.querySelector('form');
    if (form && window.FormPersistence) {
        const formId = 'coupon_create';
        FormPersistence.restore(formId, form);
        const persistence = FormPersistence.autoSave(formId, form);
        form.addEventListener('submit', function() {
            FormPersistence.clear(formId);
            persistence.stop();
        });
    }
});
</script>
{% endblock %}
