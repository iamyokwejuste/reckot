{% extends "layouts/dashboard.html" %}
{% load slippers %}
{% load i18n %}

{% block title %}{% trans "Create Coupon" %} - Reckot{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script>
window.couponPageData = {
    organizations: [{% for org in organizations %}
        {id:'{{ org.id }}',name:"{{ org.name|escapejs }}"}{% if not forloop.last %},{% endif %}
    {% endfor %}],
    events: [{% for event in events %}
        {id:'{{ event.id }}',title:"{{ event.title|escapejs }}",org:"{{ event.organization.name|escapejs }}",endAt:'{{ event.end_at|date:"Y-m-d H:i" }}'}{% if not forloop.last %},{% endif %}
    {% endfor %}]
};
</script>
{% endblock %}

{% block breadcrumbs %}
{% #breadcrumb class="mb-4" %}
    {% #breadcrumb_item href="/" %}{% trans "Home" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item href="/events/coupons/" %}{% trans "Coupons" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item %}{% trans "Create" %}{% /breadcrumb_item %}
{% /breadcrumb %}
{% endblock %}

{% block header_title %}
<div class="min-w-0">
    <h1 class="text-lg font-semibold truncate">{% trans "Create Coupon" %}</h1>
    <p class="text-sm text-muted-foreground hidden md:block">{% trans "Create a new discount code" %}</p>
</div>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto" hx-boost="false">
    <form method="post" class="space-y-6" x-data="{
        assignmentType: 'PUBLIC',
        assignmentLabel: 'Anyone (Public)',
        discountType: 'PERCENTAGE',
        discountLabel: 'Percentage',
        selectedOrg: '',
        selectedOrgLabel: '',
        selectedEvent: '',
        selectedEventLabel: ''
    }">
        {% csrf_token %}

        {% if error %}
        <div class="rounded-lg bg-red-500/10 border border-red-500/20 p-4 text-sm text-red-500">
            {{ error }}
        </div>
        {% endif %}

        <div class="card p-6 space-y-4">
            <h2 class="text-lg font-semibold">{% trans "Basic Information" %}</h2>

            <div>
                <label for="organization" class="block text-sm font-medium mb-2">{% trans "Organization" %}</label>
                <div class="custom-select-wrapper" x-data="{ open: false }">
                    <input type="hidden" id="organization" name="organization" :value="selectedOrg" required>
                    <button type="button" @click="open = !open" @click.outside="open = false"
                            class="custom-select-trigger" :class="{ 'custom-select-trigger-active': open }">
                        <span class="custom-select-value" :class="{ 'custom-select-placeholder': !selectedOrgLabel }" x-text="selectedOrgLabel || '{% trans "Select organization" %}'"></span>
                        <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4" :class="{ 'rotate-180': open }"></i>
                    </button>
                    <div x-show="open" x-transition @click.outside="open = false" class="custom-select-dropdown" x-cloak>
                        <div class="custom-select-options">
                            <template x-for="org in window.couponPageData.organizations" :key="org.id">
                                <button type="button" @click="selectedOrg = org.id; selectedOrgLabel = org.name; open = false"
                                        class="custom-select-option" :class="{ 'custom-select-option-selected': selectedOrg === org.id }">
                                    <span x-text="org.name"></span>
                                    <svg x-show="selectedOrg === org.id" class="custom-select-check w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label for="event" class="block text-sm font-medium mb-2">{% trans "Event (optional)" %}</label>
                <div class="custom-select-wrapper" x-data="{ open: false, search: '' }">
                    <input type="hidden" id="event" name="event" :value="selectedEvent">
                    <button type="button" @click="open = !open; if(open) $nextTick(() => $refs.searchInput?.focus())"
                            class="custom-select-trigger" :class="{ 'custom-select-trigger-active': open }">
                        <span class="custom-select-value" :class="{ 'custom-select-placeholder': !selectedEventLabel }" x-text="selectedEventLabel || '{% trans "All events in organization" %}'"></span>
                        <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4" :class="{ 'rotate-180': open }"></i>
                    </button>
                    <div x-show="open" x-transition @click.outside="open = false; search = ''" class="custom-select-dropdown" x-cloak>
                        <div class="custom-select-search">
                            <svg class="custom-select-search-icon w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            <input type="text" x-model="search" x-ref="searchInput" placeholder="{% trans 'Search events...' %}" class="custom-select-search-input" @click.stop>
                        </div>
                        <div class="custom-select-options">
                            <button type="button" @click="selectedEvent = ''; selectedEventLabel = ''; open = false; search = ''"
                                    x-show="!search || '{% trans "All events in organization" %}'.toLowerCase().includes(search.toLowerCase())"
                                    class="custom-select-option" :class="{ 'custom-select-option-selected': selectedEvent === '' }">
                                <span>{% trans "All events in organization" %}</span>
                                <svg x-show="selectedEvent === ''" class="custom-select-check w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            </button>
                            <template x-for="event in window.couponPageData.events.filter(e => !search || e.title.toLowerCase().includes(search.toLowerCase()) || e.org.toLowerCase().includes(search.toLowerCase())).slice(0, 50)" :key="event.id">
                                <button type="button" @click="selectedEvent = event.id; selectedEventLabel = event.title + ' (' + event.org + ')'; open = false; search = ''"
                                        class="custom-select-option" :class="{ 'custom-select-option-selected': selectedEvent === event.id }">
                                    <span x-text="event.title + ' (' + event.org + ')'"></span>
                                    <svg x-show="selectedEvent === event.id" class="custom-select-check w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
                <p class="text-xs text-muted-foreground mt-1">{% trans "Leave empty to apply to all events in the organization" %}</p>
            </div>

            <div>
                <label for="code" class="block text-sm font-medium mb-2">{% trans "Coupon Code" %}</label>
                <input type="text" name="code" id="code" placeholder="{% trans "SAVE20 (leave empty to auto-generate)" %}" class="input font-mono uppercase">
                <p class="text-xs text-muted-foreground mt-1">{% trans "Letters and numbers only, will be auto-generated if empty" %}</p>
            </div>

            <div>
                <label for="description" class="block text-sm font-medium mb-2">{% trans "Description (optional)" %}</label>
                <input type="text" name="description" id="description" placeholder="{% trans "Early bird discount" %}" class="input">
            </div>
        </div>

        <div class="card p-6 space-y-4">
            <h2 class="text-lg font-semibold">{% trans "Discount Settings" %}</h2>

            <div class="grid gap-4 sm:grid-cols-2">
                <div>
                    <label for="discount_type" class="block text-sm font-medium mb-2">{% trans "Discount Type" %}</label>
                    <div class="custom-select-wrapper" x-data="{ open: false }">
                        <input type="hidden" id="discount_type" name="discount_type" :value="discountType" required>
                        <button type="button" @click="open = !open" @click.outside="open = false"
                                class="custom-select-trigger" :class="{ 'custom-select-trigger-active': open }">
                            <span class="custom-select-value" x-text="discountLabel"></span>
                            <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4" :class="{ 'rotate-180': open }"></i>
                        </button>
                        <div x-show="open" x-transition @click.outside="open = false" class="custom-select-dropdown" x-cloak>
                            <div class="custom-select-options">
                                <button type="button" @click="discountType = 'PERCENTAGE'; discountLabel = '{% trans "Percentage" %}'; open = false"
                                        class="custom-select-option" :class="{ 'custom-select-option-selected': discountType === 'PERCENTAGE' }">
                                    <span>{% trans "Percentage" %}</span>
                                    <svg x-show="discountType === 'PERCENTAGE'" class="custom-select-check w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                </button>
                                <button type="button" @click="discountType = 'FIXED'; discountLabel = '{% trans "Fixed Amount" %}'; open = false"
                                        class="custom-select-option" :class="{ 'custom-select-option-selected': discountType === 'FIXED' }">
                                    <span>{% trans "Fixed Amount" %}</span>
                                    <svg x-show="discountType === 'FIXED'" class="custom-select-check w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="discount_value" class="block text-sm font-medium mb-2">{% trans "Discount Value" %}</label>
                    <input type="number" name="discount_value" id="discount_value" required min="0" step="0.01" placeholder="10" class="input">
                </div>
            </div>

            <div>
                <label for="max_uses" class="block text-sm font-medium mb-2">{% trans "Maximum Uses" %}</label>
                <input type="number" name="max_uses" id="max_uses" min="0" value="1" placeholder="1" class="input">
                <p class="text-xs text-muted-foreground mt-1">{% trans "Set to 0 for unlimited uses" %}</p>
            </div>
        </div>

        <div class="card p-6 space-y-4">
            <h2 class="text-lg font-semibold">{% trans "Assignment" %}</h2>

            <div>
                <label for="assignment_type" class="block text-sm font-medium mb-2">{% trans "Who can use this coupon?" %}</label>
                <div class="custom-select-wrapper" x-data="{ open: false }">
                    <input type="hidden" id="assignment_type" name="assignment_type" :value="assignmentType" required>
                    <button type="button" @click="open = !open" @click.outside="open = false"
                            class="custom-select-trigger" :class="{ 'custom-select-trigger-active': open }">
                        <span class="custom-select-value" x-text="assignmentLabel"></span>
                        <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4" :class="{ 'rotate-180': open }"></i>
                    </button>
                    <div x-show="open" x-transition @click.outside="open = false" class="custom-select-dropdown" x-cloak>
                        <div class="custom-select-options">
                            <button type="button" @click="assignmentType = 'PUBLIC'; assignmentLabel = '{% trans "Anyone (Public)" %}'; open = false"
                                    class="custom-select-option" :class="{ 'custom-select-option-selected': assignmentType === 'PUBLIC' }">
                                <span>{% trans "Anyone (Public)" %}</span>
                                <svg x-show="assignmentType === 'PUBLIC'" class="custom-select-check w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            </button>
                            <button type="button" @click="assignmentType = 'INDIVIDUAL'; assignmentLabel = '{% trans "Specific person" %}'; open = false"
                                    class="custom-select-option" :class="{ 'custom-select-option-selected': assignmentType === 'INDIVIDUAL' }">
                                <span>{% trans "Specific person" %}</span>
                                <svg x-show="assignmentType === 'INDIVIDUAL'" class="custom-select-check w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            </button>
                            <button type="button" @click="assignmentType = 'GROUP'; assignmentLabel = '{% trans "Group of people" %}'; open = false"
                                    class="custom-select-option" :class="{ 'custom-select-option-selected': assignmentType === 'GROUP' }">
                                <span>{% trans "Group of people" %}</span>
                                <svg x-show="assignmentType === 'GROUP'" class="custom-select-check w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="assignmentType === 'INDIVIDUAL'" x-cloak>
                <label for="assigned_email" class="block text-sm font-medium mb-2">{% trans "Assigned Email" %}</label>
                <input type="email" name="assigned_email" id="assigned_email" placeholder="user@example.com" class="input">
                <p class="text-xs text-muted-foreground mt-1">{% trans "Only this email address can use the coupon" %}</p>
            </div>

            <div x-show="assignmentType === 'GROUP'" x-cloak>
                <label for="assigned_emails" class="block text-sm font-medium mb-2">{% trans "Assigned Emails" %}</label>
                <textarea name="assigned_emails" id="assigned_emails" rows="3" placeholder="user1@example.com, user2@example.com, user3@example.com" class="input"></textarea>
                <p class="text-xs text-muted-foreground mt-1">{% trans "Comma-separated list of email addresses" %}</p>
            </div>
        </div>

        <div class="card p-6 space-y-4">
            <h2 class="text-lg font-semibold">{% trans "Validity Period" %}</h2>
            <p class="text-sm text-muted-foreground -mt-2">{% trans "Both fields are optional. Defaults to starting today with no end date." %}</p>

            <div class="grid gap-4 sm:grid-cols-2">
                {% #datepicker name="valid_from" id="valid_from" label="Valid From" placeholder="Starts today by default" enable_time=True %}{% /datepicker %}

                <div>
                    {% #datepicker name="valid_until" id="valid_until" label="Valid Until" placeholder="No end date" enable_time=True %}{% /datepicker %}
                    <p class="text-xs text-muted-foreground mt-1" x-show="selectedEvent" x-cloak>{% trans "Cannot be after the event end date" %}</p>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-4">
            {% #button type="submit" variant="default" %}
                {% trans "Create Coupon" %}
                <i data-lucide="check" class="w-4 h-4"></i>
            {% /button %}
            <a href="{% url 'events:coupons' %}">{% #button variant="outline" %}{% trans "Cancel" %}{% /button %}</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const validFromEl = document.getElementById('valid_from');
    const validUntilEl = document.getElementById('valid_until');

    if (validFromEl && validUntilEl) {
        flatpickr(validFromEl, {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            altInput: true,
            altFormat: "F j, Y at h:i K",
            time_24hr: false,
            minuteIncrement: 15
        });

        flatpickr(validUntilEl, {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            altInput: true,
            altFormat: "F j, Y at h:i K",
            time_24hr: false,
            minuteIncrement: 15
        });
    }
});
</script>
{% endblock %}
