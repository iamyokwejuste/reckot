{% extends "layouts/dashboard.html" %}
{% load slippers %}
{% load i18n %}

{% block title %}{% trans "Flyer Configuration" %} - {{ event.title }}{% endblock %}

{% block breadcrumbs %}
{% url 'events:dashboard' org_slug=event.organization.slug event_slug=event.slug as event_dashboard_url %}
{% #breadcrumb class="mb-4" %}
    {% #breadcrumb_item href="/" %}{% trans "Home" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item href="/events/" %}{% trans "Events" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item href=event_dashboard_url %}{{ event.title|truncatewords:3 }}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item %}{% trans "I Will Be There" %}{% /breadcrumb_item %}
{% /breadcrumb %}
{% endblock %}

{% block content %}
<div class="space-y-6" data-controller="toggle" data-toggle-step-value="1">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold">{% trans "I Will Be There - Flyer Setup" %}</h1>
            <p class="text-muted-foreground">{% trans "Configure personalized flyers for attendees" %}</p>
        </div>
        {% if config and config.is_enabled and config.template_image %}
        <a href="{% url 'events:flyer_generator' org_slug=event.organization.slug event_slug=event.slug %}" target="_blank">
            {% #button variant="outline" size="sm" %}
                <i data-lucide="external-link" class="w-4 h-4 mr-2"></i>
                {% trans "Preview Generator" %}
            {% /button %}
        </a>
        {% endif %}
    </div>

    {% if not has_feature %}
        {% if not config or config and not config.pay_per_use_accepted %}
    <div class="card p-6 border-amber-500/50 bg-amber-500/5" data-controller="toggle modal">
        <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
                <i data-lucide="sparkles" class="w-8 h-8 text-amber-500"></i>
            </div>
            <div class="flex-1">
                <h3 class="font-semibold mb-1">{% trans "Pay-Per-Use Flyer Generator" %}</h3>
                <p class="text-sm text-muted-foreground mb-3">
                    {% trans 'Enable the "I Will Be There" flyer generator for this event at <strong>25 FCFA per generated flyer</strong>. You will be billed after your event ends based on the total number of flyers generated by attendees.' %}
                </p>
                {% if not is_organizer %}
                <div class="p-3 rounded bg-amber-500/10 border border-amber-500/30 text-sm text-amber-600 mb-3">
                    <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i>
                    {% trans "Only event organizers (Owner, Admin, or Manager) can accept pay-per-use terms" %}
                </div>
                {% endif %}
                <div data-toggle-target="acceptedContent" class="hidden">
                    <div class="flex items-center gap-2 text-green-600">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                        <span class="font-medium">{% trans "Pay-per-use enabled - Configure your flyer below" %}</span>
                    </div>
                </div>
                <div data-toggle-target="buttonContent">
                    <button type="button" {% if is_organizer %}data-action="click->modal#open"{% else %}disabled{% endif %} class="btn btn-default btn-sm">
                        <i data-lucide="file-text" class="w-4 h-4 mr-2"></i>
                        {% trans "View Terms & Enable" %}
                    </button>
                </div>
            </div>
        </div>

        <div data-modal-target="container" class="hidden fixed inset-0 z-50 overflow-y-auto">
            <div class="flex min-h-screen items-center justify-center p-4">
                <div class="fixed inset-0 bg-black/50 transition-opacity" data-action="click->modal#close"></div>
                <div class="relative bg-card rounded-lg shadow-xl max-w-3xl w-full p-6 border border-border">
                    <div class="flex items-start justify-between mb-4">
                        <h3 class="text-lg font-semibold">{% trans "Flyer Generator - Terms of Service" %}</h3>
                        <button type="button" data-action="click->modal#close" class="text-muted-foreground hover:text-foreground">
                            <i data-lucide="x" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <div class="space-y-4 text-sm max-h-[50vh] overflow-y-auto">
                        <div>
                            <h4 class="font-semibold mb-2">{% trans "1. Pay-Per-Use Billing" %}</h4>
                            <p class="text-muted-foreground">
                                {% trans 'By enabling the "I Will Be There" flyer generator, you agree to be billed <strong>25 FCFA (Twenty-Five CFA Francs)</strong> for each flyer generated by attendees of your event.' %}
                            </p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">{% trans "2. Template Image" %}</h4>
                            <p class="text-muted-foreground">
                                {% trans "You are allowed <strong>one (1) template image</strong> per event at no extra cost. Each additional template change costs <strong>1,000 FCFA</strong>." %}
                            </p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">{% trans "3. Billing Timeline" %}</h4>
                            <p class="text-muted-foreground">
                                {% trans "An invoice will be generated within 7 days after your event ends. Payment is due within 14 days of invoice issuance." %}
                            </p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">{% trans "4. Payment Obligation" %}</h4>
                            <p class="text-muted-foreground">
                                {% trans "You, as the event organizer, are fully responsible for the payment of all flyer generation charges. The amount owed is calculated as: <strong>Total Flyers Generated Ã— 25 FCFA</strong>." %}
                            </p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">{% trans "5. Non-Payment Consequences" %}</h4>
                            <p class="text-muted-foreground">
                                {% trans "Failure to pay the invoice within the stipulated timeframe may result in:" %}
                            </p>
                            <ul class="list-disc list-inside text-muted-foreground mt-2 space-y-1">
                                <li>{% trans "Suspension of your account and all associated events" %}</li>
                                <li>{% trans "Late payment fees of 10% per month on outstanding balance" %}</li>
                                <li>{% trans "Collection actions and legal proceedings to recover the debt" %}</li>
                                <li>{% trans "Reporting to credit bureaus where applicable" %}</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">{% trans "6. Acceptance" %}</h4>
                            <p class="text-muted-foreground">
                                {% blocktrans with org_name=event.organization.name %}By clicking "I Accept & Enable", you acknowledge that you have read, understood, and agree to these terms. You confirm that you are authorized to incur charges on behalf of <strong>{{ org_name }}</strong>.{% endblocktrans %}
                            </p>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        {% #button variant="outline" class="flex-1" attrs='data-action="click->modal#close"' %}
                            {% trans "Cancel" %}
                        {% /button %}
                        {% #button variant="default" class="flex-1" attrs='data-action="click->toggle#acceptTerms click->modal#close"' %}
                            <i data-lucide="check" class="w-4 h-4 mr-2"></i>
                            {% trans "I Accept & Enable" %}
                        {% /button %}
                    </div>
                </div>
            </div>
        </div>
    </div>
        {% endif %}
    {% endif %}

    {% if config and config.pay_per_use_accepted and not config.template_image %}
    <div class="card p-6 border-blue-500/50 bg-blue-500/5">
        <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
                <i data-lucide="check-circle" class="w-8 h-8 text-blue-500"></i>
            </div>
            <div class="flex-1">
                <h3 class="font-semibold mb-1 text-blue-900">{% trans "Terms Accepted!" %}</h3>
                <p class="text-sm text-blue-700">
                    {% trans "You've accepted the pay-per-use terms. Now upload your template image below to configure the flyer generator." %}
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="space-y-6"
          {% if not has_feature and not config or not has_feature and config and not config.pay_per_use_accepted %}data-controller="toggle" data-toggle-target="formContainer"{% endif %}>
        {% csrf_token %}

        <div class="card p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="font-semibold">{% trans "Enable Flyer Generator" %}</h3>
                    <p class="text-sm text-muted-foreground">{% trans "Allow attendees to create personalized flyers" %}</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" name="is_enabled" class="sr-only peer"
                           {% if config and config.is_enabled %}checked{% endif %}>
                    <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-offset-2 peer-focus:ring-offset-background peer-focus:ring-emerald-500 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-400 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500 peer-checked:after:bg-white"></div>
                </label>
            </div>

            <div class="space-y-4">
                <div data-controller="logo-upload"
                     data-logo-upload-max-width-value="1080"
                     data-logo-upload-max-height-value="1080">
                    <label class="block text-sm font-medium mb-2">
                        {% trans "Template Image" %}
                        {% if not config or config and not config.template_image %}<span class="text-red-500">*</span> <span class="text-xs text-muted-foreground">({% trans "Required" %})</span>{% endif %}
                    </label>
                    {% if config and config.pay_per_use_accepted and config.template_change_count > 0 %}
                    <div class="mb-2 p-2 rounded bg-amber-500/10 border border-amber-500/30 text-sm text-amber-600">
                        <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i>
                        {% trans "Changing the template will cost <strong>1,000 FCFA</strong>" %}
                    </div>
                    {% endif %}
                    {% if config and config.template_image %}
                    <input type="hidden" name="existing_template" value="1">
                    {% endif %}
                    <div class="border-2 border-dashed border-border rounded-lg p-6 text-center transition-colors">
                        <input type="file" name="template_image" accept="image/*"
                               data-logo-upload-target="input"
                               class="hidden">
                        <div class="{% if config and config.template_image %}hidden{% endif %}">
                            <div class="w-12 h-12 mx-auto rounded-full bg-muted flex items-center justify-center">
                                <i data-lucide="image-plus" class="w-6 h-6 text-muted-foreground"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium">{% trans "Drop your template image here" %}</p>
                                <p class="text-xs text-muted-foreground mt-1">{% trans "or click to browse" %}</p>
                            </div>
                            {% #button type="button" variant="outline" size="sm" attrs='data-action="click->logo-upload#openFileInput"' %}
                                {% trans "Choose File" %}
                            {% /button %}
                            <p class="text-xs text-muted-foreground">{% trans "Recommended: 1080x1080 pixels" %}</p>
                        </div>
                        <div class="{% if not config or not config.template_image %}hidden{% endif %} space-y-3">
                            <img data-logo-upload-target="preview" class="w-24 h-24 mx-auto object-cover rounded-lg border border-border"
                                 {% if config and config.template_image %}src="{{ config.template_image.url }}"{% endif %}>
                            {% #button type="button" variant="outline" size="sm" attrs='data-action="click->logo-upload#openFileInput"' %}
                                {% trans "Change Image" %}
                            {% /button %}
                            <p data-logo-upload-target="info" class="hidden text-xs text-success"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <h3 class="font-semibold mb-4">{% trans "Visual Editor" %}</h3>
            <div class="space-y-2 mb-4">
                <p class="text-sm text-muted-foreground">{% trans "Position elements on your flyer template:" %}</p>
                <ul class="text-sm text-muted-foreground space-y-1 list-disc list-inside">
                    <li>{% trans "Click and drag the photo area to move where attendee photos will appear" %}</li>
                    <li>{% trans "Drag the resize handle (bottom-right corner) to adjust photo size" %}</li>
                    <li>{% trans "Click any element to select and edit its properties on the right" %}</li>
                </ul>
            </div>

            <div class="flex flex-col lg:flex-row gap-6">
                <div class="flex-1">
                    <div class="relative bg-muted rounded-lg overflow-hidden"
                         style="aspect-ratio: 1/1; max-width: 500px;"
                         data-controller="toggle">

                        <div data-toggle-target="templateContainer" class="absolute inset-0 flex flex-col items-center justify-center bg-zinc-900/50 border-2 border-dashed border-zinc-700 rounded-lg">
                            <div class="w-24 h-24 rounded-full bg-zinc-800 flex items-center justify-center mb-4 border-2 border-zinc-600">
                                <i data-lucide="user" class="w-10 h-10 text-zinc-500"></i>
                            </div>
                            <div class="w-48 h-6 bg-zinc-800 rounded mb-3"></div>
                            <div class="w-36 h-4 bg-zinc-800/60 rounded mb-2"></div>
                            <div class="w-28 h-4 bg-zinc-800/40 rounded mb-6"></div>
                            <div class="flex items-center gap-2 text-muted-foreground mt-4">
                                <i data-lucide="image-plus" class="w-5 h-5"></i>
                                <p class="text-sm">{% trans "Upload a template to get started" %}</p>
                            </div>
                        </div>

                        <div data-toggle-target="photoBox" class="hidden absolute border-2 transition-all group overflow-hidden"
                             data-action="mousedown->toggle#toggle click->toggle#toggle">
                            <div class="absolute inset-0 flex flex-col items-center justify-center gap-1 pointer-events-none">
                                <i data-lucide="user" class="w-8 h-8 text-white/60 group-hover:text-white/80 transition-colors"></i>
                                <span class="text-[10px] text-white/50 group-hover:text-white/70 font-medium px-2 py-0.5 bg-black/30 rounded">Attendee Photo</span>
                            </div>
                            <div class="absolute -right-1 -bottom-1 w-4 h-4 bg-primary rounded-full cursor-se-resize border-2 border-white shadow-md hover:scale-110 transition-transform"
                                 data-action="mousedown->toggle#toggle"
                                 title="Drag to resize"></div>
                        </div>
                    </div>

                    <div class="mt-3 flex gap-2">
                        <button type="button" data-action="click->toggle#toggle" class="btn btn-outline btn-sm">
                            <i data-lucide="plus" class="w-4 h-4 mr-1"></i>
                            {% trans "Add Text Field" %}
                        </button>
                    </div>
                </div>

                <div class="lg:w-80 space-y-4">
                    <div data-toggle-target="photoSettings" class="hidden card p-4 border-primary">
                        <h4 class="font-medium mb-3 flex items-center gap-2">
                            <i data-lucide="user" class="w-4 h-4"></i>
                            {% trans "Photo Settings" %}
                        </h4>
                        <div class="space-y-3">
                            <div data-controller="dropdown">
                                <label class="block text-xs font-medium mb-1">{% trans "Shape" %}</label>
                                <div class="custom-select-wrapper">
                                    <button type="button" data-action="click->dropdown#toggle" data-dropdown-target="trigger"
                                            class="custom-select-trigger">
                                        <span class="custom-select-value" data-dropdown-target="value">{% trans "Circle" %}</span>
                                        <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4"></i>
                                    </button>
                                    <div data-dropdown-target="menu" class="custom-select-dropdown hidden">
                                        <div class="custom-select-options">
                                            <button type="button" data-action="click->dropdown#select" data-value="CIRCLE"
                                                    class="custom-select-option custom-select-option-selected">
                                                <span>{% trans "Circle" %}</span>
                                                <i data-lucide="check" class="custom-select-check w-4 h-4"></i>
                                            </button>
                                            <button type="button" data-action="click->dropdown#select" data-value="SQUARE"
                                                    class="custom-select-option">
                                                <span>{% trans "Square" %}</span>
                                            </button>
                                            <button type="button" data-action="click->dropdown#select" data-value="ROUNDED"
                                                    class="custom-select-option">
                                                <span>{% trans "Rounded" %}</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Width" %}</label>
                                    <input type="number" data-toggle-target="photoWidth"
                                           data-action="input->toggle#toggle"
                                           min="10" class="input w-full text-sm">
                                    <span class="text-xs text-muted-foreground">{% trans "Max" %}: <span data-toggle-target="maxWidth"></span>px</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Height" %}</label>
                                    <input type="number" data-toggle-target="photoHeight"
                                           data-action="input->toggle#toggle"
                                           min="10" class="input w-full text-sm">
                                    <span class="text-xs text-muted-foreground">{% trans "Max" %}: <span data-toggle-target="maxHeight"></span>px</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">{% trans "Border Width" %}</label>
                                <input type="range" data-toggle-target="borderWidth" min="0" max="20" class="w-full">
                                <span class="text-xs text-muted-foreground" data-toggle-target="borderWidthLabel">0px</span>
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">{% trans "Border Color" %}</label>
                                <div class="flex gap-2">
                                    <input type="color" data-toggle-target="borderColor" class="w-12 h-8 rounded cursor-pointer">
                                    <input type="text" data-toggle-target="borderColorText" placeholder="#ffffff" class="input text-xs flex-1 h-8 uppercase">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div data-toggle-target="fieldSettings" class="hidden card p-4 border-primary">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium flex items-center gap-2">
                                <i data-lucide="type" class="w-4 h-4"></i>
                                {% trans "Text Field" %}
                            </h4>
                            <button type="button" data-action="click->toggle#toggle" class="text-destructive hover:text-destructive/80">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium mb-1">{% trans "Label" %}</label>
                                <input type="text" data-toggle-target="fieldLabel" placeholder="{% trans "e.g., Your Name" %}" class="input w-full text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">{% trans "Placeholder" %}</label>
                                <input type="text" data-toggle-target="fieldPlaceholder" placeholder="{% trans "e.g., John Doe" %}" class="input w-full text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">{% trans "Font Size" %}</label>
                                <input type="range" data-toggle-target="fontSize" min="12" max="72" class="w-full">
                                <span class="text-xs text-muted-foreground" data-toggle-target="fontSizeLabel">32px</span>
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">{% trans "Font Color" %}</label>
                                <div class="flex gap-2">
                                    <input type="color" data-toggle-target="fontColor" class="w-12 h-8 rounded cursor-pointer">
                                    <input type="text" data-toggle-target="fontColorText" placeholder="#ffffff" class="input text-xs flex-1 h-8 uppercase">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div data-toggle-target="emptySelection" class="card p-4 bg-muted/50">
                        <p class="text-sm text-muted-foreground text-center">
                            <i data-lucide="mouse-pointer" class="w-4 h-4 inline mr-1"></i>
                            {% trans "Click on an element to edit its properties" %}
                        </p>
                    </div>

                    <div class="card p-4" data-controller="toggle">
                        <button type="button" data-action="click->toggle#toggle" class="flex items-center justify-between w-full text-sm font-medium">
                            <span>{% trans "Output Settings" %}</span>
                            <i data-lucide="chevron-down" class="w-4 h-4 transition-transform" data-toggle-target="icon"></i>
                        </button>
                        <div data-toggle-target="content" class="hidden mt-3 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Width (px)" %}</label>
                                    <input type="number" data-flyer-editor-target="outputWidth" class="input w-full text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Height (px)" %}</label>
                                    <input type="number" data-flyer-editor-target="outputHeight" class="input w-full text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <input type="hidden" name="photo_x" data-flyer-editor-target="photoXInput">
        <input type="hidden" name="photo_y" data-flyer-editor-target="photoYInput">
        <input type="hidden" name="photo_width" data-flyer-editor-target="photoWidthInput">
        <input type="hidden" name="photo_height" data-flyer-editor-target="photoHeightInput">
        <input type="hidden" name="photo_shape" data-flyer-editor-target="photoShapeInput">
        <input type="hidden" name="photo_border_width" data-flyer-editor-target="photoBorderWidthInput">
        <input type="hidden" name="photo_border_color" data-flyer-editor-target="photoBorderColorInput">
        <input type="hidden" name="photo_bg_color" data-flyer-editor-target="photoBgColorInput">
        <input type="hidden" name="output_width" data-flyer-editor-target="outputWidthInput">
        <input type="hidden" name="output_height" data-flyer-editor-target="outputHeightInput">
        <input type="hidden" name="fields_json" data-flyer-editor-target="fieldsInput">
        {% if not has_feature and not config or not has_feature and config and not config.pay_per_use_accepted %}
        <input type="hidden" name="accept_pay_per_use" data-toggle-target="acceptInput" value="">
        {% endif %}

        <div class="flex justify-end gap-3">
            <a href="{% url 'events:dashboard' org_slug=event.organization.slug event_slug=event.slug %}">
                {% #button variant="outline" %}{% trans "Cancel" %}{% /button %}
            </a>
            {% #button type="submit" variant="default" attrs='data-controller="toggle" data-toggle-target="submitBtn"' %}
                <i data-lucide="save" class="w-4 h-4 mr-2" data-toggle-target="icon"></i>
                <i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin hidden" data-toggle-target="spinner"></i>
                <span data-toggle-target="label">{% trans "Save Configuration" %}</span>
            {% /button %}
        </div>
    </form>
</div>
{% endblock %}
