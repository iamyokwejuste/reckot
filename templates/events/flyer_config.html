{% extends "layouts/dashboard.html" %}
{% load slippers %}

{% block title %}Flyer Configuration - {{ event.title }}{% endblock %}

{% block content %}
<div class="space-y-6" x-data="flyerEditor()" x-init="init()">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold">I Will Be There - Flyer Setup</h1>
            <p class="text-muted-foreground">Configure personalized flyers for attendees</p>
        </div>
        {% if config and config.is_enabled and has_feature %}
        <a href="{% url 'events:flyer_generator' org_slug=event.organization.slug event_slug=event.slug %}" target="_blank">
            {% #button variant="outline" size="sm" %}
                <i data-lucide="external-link" class="w-4 h-4 mr-2"></i>
                Preview
            {% /button %}
        </a>
        {% endif %}
    </div>

    {% if not has_feature %}
    <div class="card p-6 border-amber-500/50 bg-amber-500/5" x-data="{ showTerms: false, accepted: false }">
        <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
                <i data-lucide="sparkles" class="w-8 h-8 text-amber-500"></i>
            </div>
            <div class="flex-1">
                <h3 class="font-semibold mb-1">Pay-Per-Use Flyer Generator</h3>
                <p class="text-sm text-muted-foreground mb-3">
                    Enable the "I Will Be There" flyer generator for this event at <strong>25 FCFA per generated flyer</strong>.
                    You will be billed after your event ends based on the total number of flyers generated by attendees.
                </p>
                <template x-if="!accepted">
                    <button type="button" @click="showTerms = true" class="btn btn-default btn-sm">
                        <i data-lucide="file-text" class="w-4 h-4 mr-2"></i>
                        View Terms & Enable
                    </button>
                </template>
                <template x-if="accepted">
                    <div class="flex items-center gap-2 text-green-600">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                        <span class="font-medium">Pay-per-use enabled - Configure your flyer below</span>
                    </div>
                </template>
            </div>
        </div>

        <div x-show="showTerms" x-cloak class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" @click.self="showTerms = false">
            <div class="bg-card rounded-lg max-w-lg w-full max-h-[90vh] overflow-hidden shadow-xl" @click.stop>
                <div class="p-6 border-b border-border">
                    <h3 class="text-lg font-semibold">Flyer Generator - Terms of Service</h3>
                </div>
                <div class="p-6 overflow-y-auto max-h-[50vh] space-y-4 text-sm">
                    <div>
                        <h4 class="font-semibold mb-2">1. Pay-Per-Use Billing</h4>
                        <p class="text-muted-foreground">
                            By enabling the "I Will Be There" flyer generator, you agree to be billed <strong>25 FCFA (Twenty-Five CFA Francs)</strong> for each flyer generated by attendees of your event.
                        </p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">2. Billing Timeline</h4>
                        <p class="text-muted-foreground">
                            An invoice will be generated within 7 days after your event ends. Payment is due within 14 days of invoice issuance.
                        </p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">3. Payment Obligation</h4>
                        <p class="text-muted-foreground">
                            You, as the event organizer, are fully responsible for the payment of all flyer generation charges. The amount owed is calculated as: <strong>Total Flyers Generated Ã— 25 FCFA</strong>.
                        </p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">4. Non-Payment Consequences</h4>
                        <p class="text-muted-foreground">
                            Failure to pay the invoice within the stipulated timeframe may result in:
                        </p>
                        <ul class="list-disc list-inside text-muted-foreground mt-2 space-y-1">
                            <li>Suspension of your account and all associated events</li>
                            <li>Late payment fees of 10% per month on outstanding balance</li>
                            <li>Collection actions and legal proceedings to recover the debt</li>
                            <li>Reporting to credit bureaus where applicable</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">5. Acceptance</h4>
                        <p class="text-muted-foreground">
                            By clicking "I Accept & Enable", you acknowledge that you have read, understood, and agree to these terms. You confirm that you are authorized to incur charges on behalf of <strong>{{ event.organization.name }}</strong>.
                        </p>
                    </div>
                </div>
                <div class="p-6 border-t border-border bg-muted/30 flex gap-3">
                    <button type="button" @click="showTerms = false" class="btn btn-outline flex-1">
                        Cancel
                    </button>
                    <button type="button" @click="accepted = true; showTerms = false; $dispatch('terms-accepted')" class="btn btn-default flex-1">
                        <i data-lucide="check" class="w-4 h-4 mr-2"></i>
                        I Accept & Enable
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="space-y-6" @submit="prepareSubmit"
          {% if not has_feature %}x-data="{ enabled: false }" @terms-accepted.window="enabled = true" :style="!enabled && 'opacity: 0.5; pointer-events: none;'"{% endif %}>
        {% csrf_token %}

        <div class="card p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="font-semibold">Enable Flyer Generator</h3>
                    <p class="text-sm text-muted-foreground">Allow attendees to create personalized flyers</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" name="is_enabled" class="sr-only peer"
                           {% if config and config.is_enabled %}checked{% endif %}>
                    <div class="w-11 h-6 bg-muted peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Template Image</label>
                    {% if config and config.template_image %}
                    <input type="hidden" name="existing_template" value="1">
                    {% endif %}
                    <input type="file" name="template_image" accept="image/*" class="input w-full"
                           @change="loadTemplatePreview($event)"
                           {% if not config %}required{% endif %}>
                    <p class="text-xs text-muted-foreground mt-1">Recommended size: 1080x1080 pixels</p>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <h3 class="font-semibold mb-4">Visual Editor</h3>
            <p class="text-sm text-muted-foreground mb-4">Drag elements to position them on your flyer. Click on an element to select and edit it.</p>

            <div class="flex flex-col lg:flex-row gap-6">
                <div class="flex-1">
                    <div class="relative bg-muted rounded-lg overflow-hidden"
                         style="aspect-ratio: 1/1; max-width: 500px;"
                         @mouseup="stopDrag()"
                         @mousemove="onDrag($event)"
                         @mouseleave="stopDrag()">

                        <template x-if="templateUrl">
                            <img :src="templateUrl" class="absolute inset-0 w-full h-full object-contain" alt="Template">
                        </template>
                        <template x-if="!templateUrl">
                            <div class="absolute inset-0 flex items-center justify-center text-muted-foreground">
                                <div class="text-center">
                                    <i data-lucide="image" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                    <p class="text-sm">Upload a template image</p>
                                </div>
                            </div>
                        </template>

                        <div x-show="templateUrl"
                             class="absolute border-2 border-dashed cursor-move transition-colors"
                             :class="selectedElement === 'photo' ? 'border-primary bg-primary/20' : 'border-white/50 bg-white/10 hover:border-white'"
                             :style="`left: ${photoPercent.x}%; top: ${photoPercent.y}%; width: ${photoPercent.w}%; height: ${photoPercent.h}%;`"
                             @mousedown.prevent="startDrag($event, 'photo')"
                             @click="selectElement('photo')">
                            <div class="absolute inset-0 flex items-center justify-center">
                                <i data-lucide="user" class="w-8 h-8 text-white/70"></i>
                            </div>
                            <div class="absolute -right-1 -bottom-1 w-3 h-3 bg-primary rounded-full cursor-se-resize"
                                 @mousedown.prevent.stop="startResize($event, 'photo')"></div>
                        </div>

                        <template x-for="(field, index) in fields" :key="index">
                            <div x-show="templateUrl"
                                 class="absolute px-2 py-1 cursor-move text-center transition-colors rounded"
                                 :class="selectedElement === 'field-' + index ? 'bg-primary/30 ring-2 ring-primary' : 'bg-black/30 hover:bg-black/50'"
                                 :style="`left: ${field.xPercent}%; top: ${field.yPercent}%; font-size: ${Math.max(8, field.font_size * canvasScale)}px; color: ${field.font_color}; max-width: ${field.max_width * canvasScale}px;`"
                                 @mousedown.prevent="startDrag($event, 'field-' + index)"
                                 @click="selectElement('field-' + index)">
                                <span class="whitespace-nowrap" x-text="field.label || 'Text Field'"></span>
                            </div>
                        </template>
                    </div>

                    <div class="mt-3 flex gap-2">
                        <button type="button" @click="addField()" class="btn btn-outline btn-sm">
                            <i data-lucide="plus" class="w-4 h-4 mr-1"></i>
                            Add Text Field
                        </button>
                    </div>
                </div>

                <div class="lg:w-80 space-y-4">
                    <template x-if="selectedElement === 'photo'">
                        <div class="card p-4 border-primary">
                            <h4 class="font-medium mb-3 flex items-center gap-2">
                                <i data-lucide="user" class="w-4 h-4"></i>
                                Photo Settings
                            </h4>
                            <div class="space-y-3">
                                <div x-data="{ shapeOpen: false }">
                                    <label class="block text-xs font-medium mb-1">Shape</label>
                                    <div class="custom-select-wrapper">
                                        <button type="button" @click="shapeOpen = !shapeOpen" @click.outside="shapeOpen = false"
                                                class="custom-select-trigger text-sm" :class="{ 'custom-select-trigger-active': shapeOpen }">
                                            <span class="custom-select-value" x-text="photo.shape === 'CIRCLE' ? 'Circle' : photo.shape === 'SQUARE' ? 'Square' : 'Rounded'"></span>
                                            <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4" :class="{ 'rotate-180': shapeOpen }"></i>
                                        </button>
                                        <div x-show="shapeOpen" x-transition @click.outside="shapeOpen = false" class="custom-select-dropdown" x-cloak>
                                            <div class="custom-select-options">
                                                <button type="button" @click="photo.shape = 'CIRCLE'; shapeOpen = false"
                                                        class="custom-select-option text-sm" :class="{ 'custom-select-option-selected': photo.shape === 'CIRCLE' }">
                                                    <span>Circle</span>
                                                    <i x-show="photo.shape === 'CIRCLE'" data-lucide="check" class="custom-select-check w-4 h-4"></i>
                                                </button>
                                                <button type="button" @click="photo.shape = 'SQUARE'; shapeOpen = false"
                                                        class="custom-select-option text-sm" :class="{ 'custom-select-option-selected': photo.shape === 'SQUARE' }">
                                                    <span>Square</span>
                                                    <i x-show="photo.shape === 'SQUARE'" data-lucide="check" class="custom-select-check w-4 h-4"></i>
                                                </button>
                                                <button type="button" @click="photo.shape = 'ROUNDED'; shapeOpen = false"
                                                        class="custom-select-option text-sm" :class="{ 'custom-select-option-selected': photo.shape === 'ROUNDED' }">
                                                    <span>Rounded</span>
                                                    <i x-show="photo.shape === 'ROUNDED'" data-lucide="check" class="custom-select-check w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Width</label>
                                        <input type="number" x-model.number="photo.width" @input="updatePhotoPercent()" class="input w-full text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Height</label>
                                        <input type="number" x-model.number="photo.height" @input="updatePhotoPercent()" class="input w-full text-sm">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">Border Width</label>
                                    <input type="range" x-model.number="photo.borderWidth" min="0" max="20" class="w-full">
                                    <span class="text-xs text-muted-foreground" x-text="photo.borderWidth + 'px'"></span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">Border Color</label>
                                    <input type="color" x-model="photo.borderColor" class="w-full h-8 rounded cursor-pointer">
                                </div>
                            </div>
                        </div>
                    </template>

                    <template x-if="selectedElement && selectedElement.startsWith('field-')">
                        <div class="card p-4 border-primary">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-medium flex items-center gap-2">
                                    <i data-lucide="type" class="w-4 h-4"></i>
                                    Text Field
                                </h4>
                                <button type="button" @click="removeSelectedField()" class="text-destructive hover:text-destructive/80">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="space-y-3" x-data="{ field: fields[parseInt(selectedElement.split('-')[1])] }">
                                <div>
                                    <label class="block text-xs font-medium mb-1">Label</label>
                                    <input type="text" x-model="field.label" placeholder="e.g., Your Name" class="input w-full text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">Placeholder</label>
                                    <input type="text" x-model="field.placeholder" placeholder="e.g., John Doe" class="input w-full text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">Font Size</label>
                                    <input type="range" x-model.number="field.font_size" min="12" max="72" class="w-full">
                                    <span class="text-xs text-muted-foreground" x-text="field.font_size + 'px'"></span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">Font Color</label>
                                    <input type="color" x-model="field.font_color" class="w-full h-8 rounded cursor-pointer">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">Max Width</label>
                                    <input type="number" x-model.number="field.max_width" class="input w-full text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">Alignment</label>
                                    <div class="flex gap-1">
                                        <button type="button" @click="field.text_align = 'LEFT'"
                                                :class="field.text_align === 'LEFT' ? 'bg-primary text-primary-foreground' : 'bg-muted'"
                                                class="flex-1 py-1 rounded text-sm">Left</button>
                                        <button type="button" @click="field.text_align = 'CENTER'"
                                                :class="field.text_align === 'CENTER' ? 'bg-primary text-primary-foreground' : 'bg-muted'"
                                                class="flex-1 py-1 rounded text-sm">Center</button>
                                        <button type="button" @click="field.text_align = 'RIGHT'"
                                                :class="field.text_align === 'RIGHT' ? 'bg-primary text-primary-foreground' : 'bg-muted'"
                                                class="flex-1 py-1 rounded text-sm">Right</button>
                                    </div>
                                </div>
                                <label class="flex items-center gap-2 text-sm cursor-pointer">
                                    <input type="checkbox" x-model="field.required" class="rounded">
                                    Required field
                                </label>
                            </div>
                        </div>
                    </template>

                    <template x-if="!selectedElement">
                        <div class="card p-4 bg-muted/50">
                            <p class="text-sm text-muted-foreground text-center">
                                <i data-lucide="mouse-pointer" class="w-4 h-4 inline mr-1"></i>
                                Click on an element to edit its properties
                            </p>
                        </div>
                    </template>

                    <div class="card p-4" x-data="{ open: false }">
                        <button type="button" @click="open = !open" class="flex items-center justify-between w-full text-sm font-medium">
                            <span>Output Settings</span>
                            <i data-lucide="chevron-down" class="w-4 h-4 transition-transform" :class="open && 'rotate-180'"></i>
                        </button>
                        <div x-show="open" x-collapse class="mt-3 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium mb-1">Width (px)</label>
                                    <input type="number" x-model.number="output.width" class="input w-full text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">Height (px)</label>
                                    <input type="number" x-model.number="output.height" class="input w-full text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <input type="hidden" name="photo_x" :value="photo.x">
        <input type="hidden" name="photo_y" :value="photo.y">
        <input type="hidden" name="photo_width" :value="photo.width">
        <input type="hidden" name="photo_height" :value="photo.height">
        <input type="hidden" name="photo_shape" :value="photo.shape">
        <input type="hidden" name="photo_border_width" :value="photo.borderWidth">
        <input type="hidden" name="photo_border_color" :value="photo.borderColor">
        <input type="hidden" name="output_width" :value="output.width">
        <input type="hidden" name="output_height" :value="output.height">
        <input type="hidden" name="fields_json" :value="JSON.stringify(fields)">
        {% if not has_feature %}
        <input type="hidden" name="accept_pay_per_use" :value="$root.enabled ? '1' : ''">
        {% endif %}

        <div class="flex justify-end gap-3">
            <a href="{% url 'events:dashboard' org_slug=event.organization.slug event_slug=event.slug %}">
                {% #button variant="outline" %}Cancel{% /button %}
            </a>
            {% #button type="submit" variant="default" %}
                <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                Save Configuration
            {% /button %}
        </div>
    </form>
</div>

<script>
function flyerEditor() {
    return {
        templateUrl: {% if config and config.template_image %}'{{ config.template_image.url }}'{% else %}null{% endif %},
        canvasScale: 0.5,
        selectedElement: null,
        dragging: null,
        resizing: null,
        dragOffset: { x: 0, y: 0 },

        output: {
            width: {{ config.output_width|default:1080 }},
            height: {{ config.output_height|default:1080 }}
        },

        photo: {
            x: {{ config.photo_x|default:50 }},
            y: {{ config.photo_y|default:50 }},
            width: {{ config.photo_width|default:200 }},
            height: {{ config.photo_height|default:200 }},
            shape: '{{ config.photo_shape|default:"CIRCLE" }}',
            borderWidth: {{ config.photo_border_width|default:0 }},
            borderColor: '{{ config.photo_border_color|default:"#ffffff" }}'
        },

        photoPercent: { x: 0, y: 0, w: 0, h: 0 },

        fields: [
            {% if config %}
            {% for field in config.text_fields.all %}
            {
                label: '{{ field.label|escapejs }}',
                placeholder: '{{ field.placeholder|escapejs }}',
                x: {{ field.x }},
                y: {{ field.y }},
                xPercent: {{ field.x }} / {{ config.output_width|default:1080 }} * 100,
                yPercent: {{ field.y }} / {{ config.output_height|default:1080 }} * 100,
                font_size: {{ field.font_size }},
                font_color: '{{ field.font_color }}',
                max_width: {{ field.max_width }},
                text_align: '{{ field.text_align }}',
                required: {{ field.is_required|yesno:"true,false" }}
            },
            {% endfor %}
            {% endif %}
        ],

        init() {
            this.updatePhotoPercent();
            this.updateFieldPercents();
            this.$nextTick(() => { if (window.lucide) lucide.createIcons(); });
        },

        updatePhotoPercent() {
            this.photoPercent = {
                x: (this.photo.x / this.output.width) * 100,
                y: (this.photo.y / this.output.height) * 100,
                w: (this.photo.width / this.output.width) * 100,
                h: (this.photo.height / this.output.height) * 100
            };
        },

        updateFieldPercents() {
            this.fields.forEach(f => {
                f.xPercent = (f.x / this.output.width) * 100;
                f.yPercent = (f.y / this.output.height) * 100;
            });
        },

        loadTemplatePreview(event) {
            const file = event.target.files[0];
            if (file) {
                this.templateUrl = URL.createObjectURL(file);
            }
        },

        selectElement(el) {
            this.selectedElement = el;
            this.$nextTick(() => { if (window.lucide) lucide.createIcons(); });
        },

        startDrag(event, element) {
            this.dragging = element;
            const rect = event.target.getBoundingClientRect();
            this.dragOffset = {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            };
        },

        startResize(event, element) {
            this.resizing = element;
        },

        onDrag(event) {
            if (!this.dragging && !this.resizing) return;

            const canvas = event.currentTarget;
            const rect = canvas.getBoundingClientRect();
            const x = ((event.clientX - rect.left) / rect.width) * 100;
            const y = ((event.clientY - rect.top) / rect.height) * 100;

            if (this.resizing === 'photo') {
                const newW = Math.max(5, x - this.photoPercent.x);
                const newH = Math.max(5, y - this.photoPercent.y);
                this.photo.width = Math.round((newW / 100) * this.output.width);
                this.photo.height = Math.round((newH / 100) * this.output.height);
                this.updatePhotoPercent();
                return;
            }

            if (this.dragging === 'photo') {
                const offsetXPercent = (this.dragOffset.x / rect.width) * 100;
                const offsetYPercent = (this.dragOffset.y / rect.height) * 100;
                this.photoPercent.x = Math.max(0, Math.min(100 - this.photoPercent.w, x - offsetXPercent));
                this.photoPercent.y = Math.max(0, Math.min(100 - this.photoPercent.h, y - offsetYPercent));
                this.photo.x = Math.round((this.photoPercent.x / 100) * this.output.width);
                this.photo.y = Math.round((this.photoPercent.y / 100) * this.output.height);
            } else if (this.dragging && this.dragging.startsWith('field-')) {
                const idx = parseInt(this.dragging.split('-')[1]);
                const field = this.fields[idx];
                const offsetXPercent = (this.dragOffset.x / rect.width) * 100;
                const offsetYPercent = (this.dragOffset.y / rect.height) * 100;
                field.xPercent = Math.max(0, Math.min(95, x - offsetXPercent));
                field.yPercent = Math.max(0, Math.min(95, y - offsetYPercent));
                field.x = Math.round((field.xPercent / 100) * this.output.width);
                field.y = Math.round((field.yPercent / 100) * this.output.height);
            }
        },

        stopDrag() {
            this.dragging = null;
            this.resizing = null;
        },

        addField() {
            this.fields.push({
                label: '',
                placeholder: '',
                x: 540,
                y: 800,
                xPercent: 50,
                yPercent: 74,
                font_size: 32,
                font_color: '#ffffff',
                max_width: 400,
                text_align: 'CENTER',
                required: true
            });
            this.selectedElement = 'field-' + (this.fields.length - 1);
            this.$nextTick(() => { if (window.lucide) lucide.createIcons(); });
        },

        removeSelectedField() {
            if (this.selectedElement && this.selectedElement.startsWith('field-')) {
                const idx = parseInt(this.selectedElement.split('-')[1]);
                this.fields.splice(idx, 1);
                this.selectedElement = null;
            }
        },

        prepareSubmit() {
            return true;
        }
    }
}
</script>
{% endblock %}
