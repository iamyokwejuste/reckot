{% extends "layouts/dashboard.html" %}
{% load slippers %}
{% load i18n %}

{% block title %}{% trans "Flyer Configuration" %} - {{ event.title }}{% endblock %}

{% block breadcrumbs %}
{% url 'events:dashboard' org_slug=event.organization.slug event_slug=event.slug as event_dashboard_url %}
{% #breadcrumb class="mb-4" %}
    {% #breadcrumb_item href="/" %}{% trans "Home" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item href="/events/" %}{% trans "Events" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item href=event_dashboard_url %}{{ event.title|truncatewords:3 }}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item %}{% trans "I Will Be There" %}{% /breadcrumb_item %}
{% /breadcrumb %}
{% endblock %}

{% block content %}
<div class="space-y-6" x-data="flyerEditor()" x-init="init()">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold">{% trans "I Will Be There - Flyer Setup" %}</h1>
            <p class="text-muted-foreground">{% trans "Configure personalized flyers for attendees" %}</p>
        </div>
        {% if config and config.is_enabled and has_feature or config and config.is_enabled and config.pay_per_use_accepted %}
        <a href="{% url 'events:flyer_generator' org_slug=event.organization.slug event_slug=event.slug %}" target="_blank">
            {% #button variant="outline" size="sm" %}
                <i data-lucide="external-link" class="w-4 h-4 mr-2"></i>
                {% trans "Preview" %}
            {% /button %}
        </a>
        {% endif %}
    </div>

    {% if not has_feature and not config.pay_per_use_accepted and not config.template_image %}
    <div class="card p-6 border-amber-500/50 bg-amber-500/5" x-data="{ showTerms: false, accepted: false }">
        <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
                <i data-lucide="sparkles" class="w-8 h-8 text-amber-500"></i>
            </div>
            <div class="flex-1">
                <h3 class="font-semibold mb-1">{% trans "Pay-Per-Use Flyer Generator" %}</h3>
                <p class="text-sm text-muted-foreground mb-3">
                    {% trans "Enable the \"I Will Be There\" flyer generator for this event at <strong>25 FCFA per generated flyer</strong>. You will be billed after your event ends based on the total number of flyers generated by attendees." %}
                </p>
                <template x-if="!accepted">
                    <button type="button" @click="showTerms = true" class="btn btn-default btn-sm">
                        <i data-lucide="file-text" class="w-4 h-4 mr-2"></i>
                        {% trans "View Terms & Enable" %}
                    </button>
                </template>
                <template x-if="accepted">
                    <div class="flex items-center gap-2 text-green-600">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                        <span class="font-medium">{% trans "Pay-per-use enabled - Configure your flyer below" %}</span>
                    </div>
                </template>
            </div>
        </div>

        {% #modal trigger="showTerms" title=_("Flyer Generator - Terms of Service") size="lg" %}
            <div class="space-y-4 text-sm max-h-[50vh] overflow-y-auto">
                <div>
                    <h4 class="font-semibold mb-2">{% trans "1. Pay-Per-Use Billing" %}</h4>
                    <p class="text-muted-foreground">
                        {% trans "By enabling the \"I Will Be There\" flyer generator, you agree to be billed <strong>25 FCFA (Twenty-Five CFA Francs)</strong> for each flyer generated by attendees of your event." %}
                    </p>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">{% trans "2. Template Image" %}</h4>
                    <p class="text-muted-foreground">
                        {% trans "You are allowed <strong>one (1) template image</strong> per event at no extra cost. Each additional template change costs <strong>1,000 FCFA</strong>." %}
                    </p>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">{% trans "3. Billing Timeline" %}</h4>
                    <p class="text-muted-foreground">
                        {% trans "An invoice will be generated within 7 days after your event ends. Payment is due within 14 days of invoice issuance." %}
                    </p>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">{% trans "4. Payment Obligation" %}</h4>
                    <p class="text-muted-foreground">
                        {% trans "You, as the event organizer, are fully responsible for the payment of all flyer generation charges. The amount owed is calculated as: <strong>Total Flyers Generated Ã— 25 FCFA</strong>." %}
                    </p>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">{% trans "5. Non-Payment Consequences" %}</h4>
                    <p class="text-muted-foreground">
                        {% trans "Failure to pay the invoice within the stipulated timeframe may result in:" %}
                    </p>
                    <ul class="list-disc list-inside text-muted-foreground mt-2 space-y-1">
                        <li>{% trans "Suspension of your account and all associated events" %}</li>
                        <li>{% trans "Late payment fees of 10% per month on outstanding balance" %}</li>
                        <li>{% trans "Collection actions and legal proceedings to recover the debt" %}</li>
                        <li>{% trans "Reporting to credit bureaus where applicable" %}</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">{% trans "6. Acceptance" %}</h4>
                    <p class="text-muted-foreground">
                        {% blocktrans with org_name=event.organization.name %}By clicking "I Accept & Enable", you acknowledge that you have read, understood, and agree to these terms. You confirm that you are authorized to incur charges on behalf of <strong>{{ org_name }}</strong>.{% endblocktrans %}
                    </p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                {% #button variant="outline" class="flex-1" attrs='@click="showTerms = false"' %}
                    {% trans "Cancel" %}
                {% /button %}
                {% #button variant="default" class="flex-1" attrs='@click="accepted = true; showTerms = false; $dispatch(\'terms-accepted\')"' %}
                    <i data-lucide="check" class="w-4 h-4 mr-2"></i>
                    {% trans "I Accept & Enable" %}
                {% /button %}
            </div>
        {% /modal %}
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="space-y-6" @submit="prepareSubmit"
          {% if not has_feature and not config.pay_per_use_accepted and not config.template_image %}x-data="{ enabled: false }" @terms-accepted.window="enabled = true" :style="!enabled && 'opacity: 0.5; pointer-events: none;'"{% endif %}>
        {% csrf_token %}

        <div class="card p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="font-semibold">{% trans "Enable Flyer Generator" %}</h3>
                    <p class="text-sm text-muted-foreground">{% trans "Allow attendees to create personalized flyers" %}</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" name="is_enabled" class="sr-only peer"
                           {% if config and config.is_enabled %}checked{% endif %}>
                    <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-offset-2 peer-focus:ring-offset-background peer-focus:ring-emerald-500 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-400 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500 peer-checked:after:bg-white"></div>
                </label>
            </div>

            <div class="space-y-4">
                <div x-data="{ dragging: false, preview: {% if config and config.template_image %}'{{ config.template_image.url }}'{% else %}null{% endif %} }">
                    <label class="block text-sm font-medium mb-2">{% trans "Template Image" %}</label>
                    {% if config and config.pay_per_use_accepted and config.template_change_count > 0 %}
                    <div class="mb-2 p-2 rounded bg-amber-500/10 border border-amber-500/30 text-sm text-amber-600">
                        <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i>
                        {% trans "Changing the template will cost <strong>1,000 FCFA</strong>" %}
                    </div>
                    {% endif %}
                    {% if config and config.template_image %}
                    <input type="hidden" name="existing_template" value="1">
                    {% endif %}
                    <div class="border-2 border-dashed border-border rounded-lg p-6 text-center transition-colors"
                         @dragover.prevent="dragging = true"
                         @dragleave.prevent="dragging = false"
                         @drop.prevent="dragging = false; const file = $event.dataTransfer.files[0]; if (file) { $refs.templateInput.files = $event.dataTransfer.files; preview = URL.createObjectURL(file); loadTemplatePreview({ target: $refs.templateInput }); }"
                         :class="{ 'border-primary bg-primary/5': dragging }">
                        <input type="file" name="template_image" accept="image/*" x-ref="templateInput"
                               class="hidden"
                               @change="preview = URL.createObjectURL($event.target.files[0]); loadTemplatePreview($event)"
                               {% if not config %}required{% endif %}>
                        <div x-show="!preview" class="space-y-3">
                            <div class="w-12 h-12 mx-auto rounded-full bg-muted flex items-center justify-center">
                                <i data-lucide="image-plus" class="w-6 h-6 text-muted-foreground"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium">{% trans "Drop your template image here" %}</p>
                                <p class="text-xs text-muted-foreground mt-1">{% trans "or click to browse" %}</p>
                            </div>
                            {% #button type="button" variant="outline" size="sm" attrs='@click="$refs.templateInput.click()"' %}
                                {% trans "Choose File" %}
                            {% /button %}
                            <p class="text-xs text-muted-foreground">{% trans "Recommended: 1080x1080 pixels" %}</p>
                        </div>
                        <div x-show="preview" class="space-y-3">
                            <img :src="preview" class="w-24 h-24 mx-auto object-cover rounded-lg border border-border">
                            {% #button type="button" variant="outline" size="sm" attrs='@click="$refs.templateInput.click()"' %}
                                {% trans "Change Image" %}
                            {% /button %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <h3 class="font-semibold mb-4">{% trans "Visual Editor" %}</h3>
            <div class="space-y-2 mb-4">
                <p class="text-sm text-muted-foreground">{% trans "Position elements on your flyer template:" %}</p>
                <ul class="text-sm text-muted-foreground space-y-1 list-disc list-inside">
                    <li>{% trans "Click and drag the photo area to move where attendee photos will appear" %}</li>
                    <li>{% trans "Drag the resize handle (bottom-right corner) to adjust photo size" %}</li>
                    <li>{% trans "Click any element to select and edit its properties on the right" %}</li>
                </ul>
            </div>

            <div class="flex flex-col lg:flex-row gap-6">
                <div class="flex-1">
                    <div class="relative bg-muted rounded-lg overflow-hidden"
                         style="aspect-ratio: 1/1; max-width: 500px;"
                         @mouseup="stopDrag()"
                         @mousemove="onDrag($event)"
                         @mouseleave="stopDrag()">

                        <template x-if="templateUrl">
                            <img :src="templateUrl" class="absolute inset-0 w-full h-full object-contain" alt="Template">
                        </template>
                        <template x-if="!templateUrl">
                            <div class="absolute inset-0 flex flex-col items-center justify-center bg-zinc-900/50 border-2 border-dashed border-zinc-700 rounded-lg">
                                <div class="w-24 h-24 rounded-full bg-zinc-800 flex items-center justify-center mb-4 border-2 border-zinc-600">
                                    <i data-lucide="user" class="w-10 h-10 text-zinc-500"></i>
                                </div>
                                <div class="w-48 h-6 bg-zinc-800 rounded mb-3"></div>
                                <div class="w-36 h-4 bg-zinc-800/60 rounded mb-2"></div>
                                <div class="w-28 h-4 bg-zinc-800/40 rounded mb-6"></div>
                                <div class="flex items-center gap-2 text-muted-foreground mt-4">
                                    <i data-lucide="image-plus" class="w-5 h-5"></i>
                                    <p class="text-sm">{% trans "Upload a template to get started" %}</p>
                                </div>
                            </div>
                        </template>

                        <div x-show="templateUrl"
                             class="absolute border-2 transition-all group overflow-hidden"
                             :class="[
                                 selectedElement === 'photo' ? 'border-primary bg-primary/10 shadow-lg' : 'border-dashed border-white/40 bg-white/5 hover:border-primary/50 hover:bg-primary/5',
                                 photo.shape === 'CIRCLE' ? 'rounded-full' : photo.shape === 'ROUNDED' ? 'rounded-xl' : ''
                             ]"
                             :style="`left: ${photoPercent.x}%; top: ${photoPercent.y}%; width: ${photoPercent.w}%; height: ${photoPercent.h}%; cursor: ${dragging === 'photo' ? 'grabbing' : 'grab'};`"
                             @mousedown.prevent="startDrag($event, 'photo')"
                             @click="selectElement('photo')">
                            <div class="absolute inset-0 flex flex-col items-center justify-center gap-1 pointer-events-none">
                                <i data-lucide="user" class="w-8 h-8 text-white/60 group-hover:text-white/80 transition-colors"></i>
                                <span class="text-[10px] text-white/50 group-hover:text-white/70 font-medium px-2 py-0.5 bg-black/30 rounded">Attendee Photo</span>
                            </div>
                            <div class="absolute -right-1 -bottom-1 w-4 h-4 bg-primary rounded-full cursor-se-resize border-2 border-white shadow-md hover:scale-110 transition-transform"
                                 @mousedown.prevent.stop="startResize($event, 'photo')"
                                 title="Drag to resize"></div>
                        </div>

                        <template x-for="(field, index) in fields" :key="index">
                            <div x-show="templateUrl"
                                 class="absolute px-2 py-1 transition-all rounded"
                                 :class="[
                                     selectedElement === 'field-' + index ? 'ring-2 ring-primary shadow-lg' : 'hover:ring-1 hover:ring-white/30',
                                     field.text_align === 'LEFT' ? 'text-left' : field.text_align === 'RIGHT' ? 'text-right' : 'text-center'
                                 ]"
                                 :style="`left: ${field.xPercent}%; top: ${field.yPercent}%; font-size: ${Math.max(8, field.font_size * canvasScale)}px; color: ${field.font_color}; background-color: ${field.bg_color || 'rgba(0,0,0,0.3)'}; max-width: ${field.max_width * canvasScale}px; cursor: ${dragging === 'field-' + index ? 'grabbing' : 'grab'};`"
                                 @mousedown.prevent="startDrag($event, 'field-' + index)"
                                 @click="selectElement('field-' + index)">
                                <span class="whitespace-nowrap" x-text="field.placeholder || field.label || 'Text Field'"></span>
                            </div>
                        </template>
                    </div>

                    <div class="mt-3 flex gap-2">
                        <button type="button" @click="addField()" class="btn btn-outline btn-sm">
                            <i data-lucide="plus" class="w-4 h-4 mr-1"></i>
                            {% trans "Add Text Field" %}
                        </button>
                    </div>
                </div>

                <div class="lg:w-80 space-y-4">
                    <template x-if="selectedElement === 'photo'">
                        <div class="card p-4 border-primary">
                            <h4 class="font-medium mb-3 flex items-center gap-2">
                                <i data-lucide="user" class="w-4 h-4"></i>
                                {% trans "Photo Settings" %}
                            </h4>
                            <div class="space-y-3">
                                <div x-data="{ shapeOpen: false }">
                                    <label class="block text-xs font-medium mb-1">{% trans "Shape" %}</label>
                                    <div class="custom-select-wrapper">
                                        <button type="button" @click="shapeOpen = !shapeOpen" @click.outside="shapeOpen = false"
                                                class="custom-select-trigger text-sm" :class="{ 'custom-select-trigger-active': shapeOpen }">
                                            <span class="custom-select-value" x-text="photo.shape === 'CIRCLE' ? '{% trans "Circle" %}' : photo.shape === 'SQUARE' ? '{% trans "Square" %}' : '{% trans "Rounded" %}'"></span>
                                            <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4" :class="{ 'rotate-180': shapeOpen }"></i>
                                        </button>
                                        <div x-show="shapeOpen" x-transition @click.outside="shapeOpen = false" class="custom-select-dropdown" x-cloak>
                                            <div class="custom-select-options">
                                                <button type="button" @click="photo.shape = 'CIRCLE'; shapeOpen = false"
                                                        class="custom-select-option text-sm" :class="{ 'custom-select-option-selected': photo.shape === 'CIRCLE' }">
                                                    <span>{% trans "Circle" %}</span>
                                                    <i x-show="photo.shape === 'CIRCLE'" data-lucide="check" class="custom-select-check w-4 h-4"></i>
                                                </button>
                                                <button type="button" @click="photo.shape = 'SQUARE'; shapeOpen = false"
                                                        class="custom-select-option text-sm" :class="{ 'custom-select-option-selected': photo.shape === 'SQUARE' }">
                                                    <span>{% trans "Square" %}</span>
                                                    <i x-show="photo.shape === 'SQUARE'" data-lucide="check" class="custom-select-check w-4 h-4"></i>
                                                </button>
                                                <button type="button" @click="photo.shape = 'ROUNDED'; shapeOpen = false"
                                                        class="custom-select-option text-sm" :class="{ 'custom-select-option-selected': photo.shape === 'ROUNDED' }">
                                                    <span>{% trans "Rounded" %}</span>
                                                    <i x-show="photo.shape === 'ROUNDED'" data-lucide="check" class="custom-select-check w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium mb-1">{% trans "Width" %}</label>
                                        <input type="number" x-model.number="photo.width"
                                               @input="constrainPhotoSize(); updatePhotoPercent()"
                                               :max="templateWidth" min="10"
                                               class="input w-full text-sm">
                                        <span class="text-xs text-muted-foreground">{% trans "Max" %}: <span x-text="templateWidth"></span>px</span>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">{% trans "Height" %}</label>
                                        <input type="number" x-model.number="photo.height"
                                               @input="constrainPhotoSize(); updatePhotoPercent()"
                                               :max="templateHeight" min="10"
                                               class="input w-full text-sm">
                                        <span class="text-xs text-muted-foreground">{% trans "Max" %}: <span x-text="templateHeight"></span>px</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Border Width" %}</label>
                                    <input type="range" x-model.number="photo.borderWidth" min="0" max="20" class="w-full">
                                    <span class="text-xs text-muted-foreground" x-text="photo.borderWidth + 'px'"></span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Border Color" %}</label>
                                    <input type="color" x-model="photo.borderColor" class="w-full h-8 rounded cursor-pointer">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Background Color" %}</label>
                                    <div class="flex gap-2">
                                        <input type="color"
                                            :value="photo.bgColor.startsWith('rgba') ? '#' + photo.bgColor.match(/\d+/g).slice(0,3).map(x => parseInt(x).toString(16).padStart(2,'0')).join('') : photo.bgColor"
                                            @input="
                                                const hex = $event.target.value;
                                                const r = parseInt(hex.slice(1,3), 16);
                                                const g = parseInt(hex.slice(3,5), 16);
                                                const b = parseInt(hex.slice(5,7), 16);
                                                const alpha = photo.bgColor.startsWith('rgba') ? parseFloat(photo.bgColor.match(/[\d.]+/g)[3]) : 1;
                                                photo.bgColor = `rgba(${r},${g},${b},${alpha})`
                                            "
                                            class="w-16 h-8 rounded cursor-pointer">
                                        <div class="flex-1">
                                            <input type="range" min="0" max="100"
                                                :value="photo.bgColor.startsWith('rgba') ? parseFloat(photo.bgColor.match(/[\d.]+/g)[3]) * 100 : (photo.bgColor === 'transparent' ? 0 : 100)"
                                                @input="
                                                    const color = photo.bgColor.startsWith('rgba') ? photo.bgColor : photo.bgColor === 'transparent' ? 'rgba(0,0,0,0)' : photo.bgColor;
                                                    const rgb = color.startsWith('rgba') ? color.match(/\d+/g).slice(0,3) : [0,0,0];
                                                    photo.bgColor = `rgba(${rgb[0]},${rgb[1]},${rgb[2]},${$event.target.value/100})`
                                                "
                                                class="w-full">
                                            <div class="text-xs text-muted-foreground">{% trans "Opacity" %}: <span x-text="Math.round((photo.bgColor.startsWith('rgba') ? parseFloat(photo.bgColor.match(/[\d.]+/g)[3]) : (photo.bgColor === 'transparent' ? 0 : 1)) * 100) + '%'"></span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <template x-if="selectedElement && selectedElement.startsWith('field-')">
                        <div class="card p-4 border-primary">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-medium flex items-center gap-2">
                                    <i data-lucide="type" class="w-4 h-4"></i>
                                    {% trans "Text Field" %}
                                </h4>
                                <button type="button" @click="removeSelectedField()" class="text-destructive hover:text-destructive/80">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="space-y-3" x-data="{ field: fields[parseInt(selectedElement.split('-')[1])] }">
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Label" %}</label>
                                    <input type="text" x-model="field.label" placeholder="{% trans "e.g., Your Name" %}" class="input w-full text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Placeholder" %}</label>
                                    <input type="text" x-model="field.placeholder" placeholder="{% trans "e.g., John Doe" %}" class="input w-full text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Font Size" %}</label>
                                    <input type="range" x-model.number="field.font_size" min="12" max="72" class="w-full">
                                    <span class="text-xs text-muted-foreground" x-text="field.font_size + 'px'"></span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Font Color" %}</label>
                                    <input type="color" x-model="field.font_color" class="w-full h-8 rounded cursor-pointer">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Background" %}</label>
                                    <div class="flex gap-2">
                                        <input type="color"
                                            :value="field.bg_color.startsWith('rgba') ? '#' + field.bg_color.match(/\d+/g).slice(0,3).map(x => parseInt(x).toString(16).padStart(2,'0')).join('') : field.bg_color"
                                            @input="
                                                const hex = $event.target.value;
                                                const r = parseInt(hex.slice(1,3), 16);
                                                const g = parseInt(hex.slice(3,5), 16);
                                                const b = parseInt(hex.slice(5,7), 16);
                                                const alpha = field.bg_color.startsWith('rgba') ? parseFloat(field.bg_color.match(/[\d.]+/g)[3]) : 1;
                                                field.bg_color = `rgba(${r},${g},${b},${alpha})`
                                            "
                                            class="w-16 h-8 rounded cursor-pointer">
                                        <div class="flex-1">
                                            <input type="range" min="0" max="100"
                                                :value="field.bg_color.startsWith('rgba') ? parseFloat(field.bg_color.match(/[\d.]+/g)[3]) * 100 : (field.bg_color === 'transparent' ? 0 : 100)"
                                                @input="
                                                    const color = field.bg_color.startsWith('rgba') ? field.bg_color : field.bg_color === 'transparent' ? 'rgba(0,0,0,0)' : field.bg_color;
                                                    const rgb = color.startsWith('rgba') ? color.match(/\d+/g).slice(0,3) : [0,0,0];
                                                    field.bg_color = `rgba(${rgb[0]},${rgb[1]},${rgb[2]},${$event.target.value/100})`
                                                "
                                                class="w-full">
                                            <div class="text-xs text-muted-foreground">{% trans "Opacity" %}: <span x-text="Math.round((field.bg_color.startsWith('rgba') ? parseFloat(field.bg_color.match(/[\d.]+/g)[3]) : (field.bg_color === 'transparent' ? 0 : 1)) * 100) + '%'"></span></div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Max Width" %}</label>
                                    <input type="number" x-model.number="field.max_width" class="input w-full text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Alignment" %}</label>
                                    <div class="flex gap-1">
                                        <button type="button" @click="field.text_align = 'LEFT'"
                                                :class="field.text_align === 'LEFT' ? 'bg-primary text-primary-foreground' : 'bg-muted'"
                                                class="flex-1 py-1 rounded text-sm">{% trans "Left" %}</button>
                                        <button type="button" @click="field.text_align = 'CENTER'"
                                                :class="field.text_align === 'CENTER' ? 'bg-primary text-primary-foreground' : 'bg-muted'"
                                                class="flex-1 py-1 rounded text-sm">{% trans "Center" %}</button>
                                        <button type="button" @click="field.text_align = 'RIGHT'"
                                                :class="field.text_align === 'RIGHT' ? 'bg-primary text-primary-foreground' : 'bg-muted'"
                                                class="flex-1 py-1 rounded text-sm">{% trans "Right" %}</button>
                                    </div>
                                </div>
                                <label class="flex items-center gap-2 text-sm cursor-pointer">
                                    <input type="checkbox" x-model="field.required" class="rounded">
                                    {% trans "Required field" %}
                                </label>
                            </div>
                        </div>
                    </template>

                    <template x-if="!selectedElement">
                        <div class="card p-4 bg-muted/50">
                            <p class="text-sm text-muted-foreground text-center">
                                <i data-lucide="mouse-pointer" class="w-4 h-4 inline mr-1"></i>
                                {% trans "Click on an element to edit its properties" %}
                            </p>
                        </div>
                    </template>

                    <div class="card p-4" x-data="{ open: false }">
                        <button type="button" @click="open = !open" class="flex items-center justify-between w-full text-sm font-medium">
                            <span>{% trans "Output Settings" %}</span>
                            <i data-lucide="chevron-down" class="w-4 h-4 transition-transform" :class="open && 'rotate-180'"></i>
                        </button>
                        <div x-show="open" x-collapse class="mt-3 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Width (px)" %}</label>
                                    <input type="number" x-model.number="output.width" class="input w-full text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">{% trans "Height (px)" %}</label>
                                    <input type="number" x-model.number="output.height" class="input w-full text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <input type="hidden" name="photo_x" :value="photo.x">
        <input type="hidden" name="photo_y" :value="photo.y">
        <input type="hidden" name="photo_width" :value="photo.width">
        <input type="hidden" name="photo_height" :value="photo.height">
        <input type="hidden" name="photo_shape" :value="photo.shape">
        <input type="hidden" name="photo_border_width" :value="photo.borderWidth">
        <input type="hidden" name="photo_border_color" :value="photo.borderColor">
        <input type="hidden" name="photo_bg_color" :value="photo.bgColor">
        <input type="hidden" name="output_width" :value="output.width">
        <input type="hidden" name="output_height" :value="output.height">
        <input type="hidden" name="fields_json" :value="JSON.stringify(fields)">
        {% if not has_feature and not config.pay_per_use_accepted and not config.template_image %}
        <input type="hidden" name="accept_pay_per_use" :value="$root.enabled ? '1' : ''">
        {% endif %}

        <div class="flex justify-end gap-3">
            <a href="{% url 'events:dashboard' org_slug=event.organization.slug event_slug=event.slug %}">
                {% #button variant="outline" %}{% trans "Cancel" %}{% /button %}
            </a>
            {% #button type="submit" variant="default" %}
                <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                {% trans "Save Configuration" %}
            {% /button %}
        </div>
    </form>
</div>

<script>
function flyerEditor() {
    return {
        templateUrl: {% if config and config.template_image %}'{{ config.template_image.url }}'{% else %}null{% endif %},
        templateWidth: {{ config.output_width|default:1080 }},
        templateHeight: {{ config.output_height|default:1080 }},
        canvasScale: 0.5,
        selectedElement: null,
        dragging: null,
        resizing: null,
        dragOffset: { x: 0, y: 0 },

        output: {
            width: {{ config.output_width|default:1080 }},
            height: {{ config.output_height|default:1080 }}
        },

        photo: {
            x: {{ config.photo_x|default:50 }},
            y: {{ config.photo_y|default:50 }},
            width: {{ config.photo_width|default:200 }},
            height: {{ config.photo_height|default:200 }},
            shape: '{{ config.photo_shape|default:"CIRCLE" }}',
            borderWidth: {{ config.photo_border_width|default:0 }},
            borderColor: '{{ config.photo_border_color|default:"#ffffff" }}',
            bgColor: '{{ config.photo_bg_color|default:"transparent" }}'
        },

        photoPercent: { x: 0, y: 0, w: 0, h: 0 },

        fields: [
            {% if config %}
            {% for field in config.text_fields.all %}
            {
                label: '{{ field.label|escapejs }}',
                placeholder: '{{ field.placeholder|escapejs }}',
                x: {{ field.x }},
                y: {{ field.y }},
                xPercent: {{ field.x }} / {{ config.output_width|default:1080 }} * 100,
                yPercent: {{ field.y }} / {{ config.output_height|default:1080 }} * 100,
                font_size: {{ field.font_size }},
                font_color: '{{ field.font_color }}',
                bg_color: '{{ field.bg_color|default:"rgba(0,0,0,0.3)" }}',
                max_width: {{ field.max_width }},
                text_align: '{{ field.text_align }}',
                required: {{ field.is_required|yesno:"true,false" }}
            },
            {% endfor %}
            {% endif %}
        ],

        init() {
            this.constrainPhotoSize();
            this.updatePhotoPercent();
            this.updateFieldPercents();
            this.$nextTick(() => { if (window.lucide) lucide.createIcons(); });
        },

        updatePhotoPercent() {
            this.photoPercent = {
                x: (this.photo.x / this.output.width) * 100,
                y: (this.photo.y / this.output.height) * 100,
                w: (this.photo.width / this.output.width) * 100,
                h: (this.photo.height / this.output.height) * 100
            };
        },

        updateFieldPercents() {
            this.fields.forEach(f => {
                f.xPercent = (f.x / this.output.width) * 100;
                f.yPercent = (f.y / this.output.height) * 100;
            });
        },

        loadTemplatePreview(event) {
            const file = event.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                const img = new Image();
                img.onload = () => {
                    this.templateWidth = img.naturalWidth;
                    this.templateHeight = img.naturalHeight;
                    this.output.width = img.naturalWidth;
                    this.output.height = img.naturalHeight;
                    this.constrainPhotoSize();
                    this.updatePhotoPercent();
                    this.updateFieldPercents();
                };
                img.src = url;
                this.templateUrl = url;
            }
        },

        constrainPhotoSize() {
            if (this.photo.width > this.templateWidth) {
                this.photo.width = this.templateWidth;
            }
            if (this.photo.height > this.templateHeight) {
                this.photo.height = this.templateHeight;
            }
            if (this.photo.x + this.photo.width > this.templateWidth) {
                this.photo.x = this.templateWidth - this.photo.width;
            }
            if (this.photo.y + this.photo.height > this.templateHeight) {
                this.photo.y = this.templateHeight - this.photo.height;
            }
        },

        selectElement(el) {
            this.selectedElement = el;
            this.$nextTick(() => { if (window.lucide) lucide.createIcons(); });
        },

        startDrag(event, element) {
            this.dragging = element;
            const rect = event.target.getBoundingClientRect();
            this.dragOffset = {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            };
        },

        startResize(event, element) {
            this.resizing = element;
        },

        onDrag(event) {
            if (!this.dragging && !this.resizing) return;

            const canvas = event.currentTarget;
            const rect = canvas.getBoundingClientRect();
            const x = ((event.clientX - rect.left) / rect.width) * 100;
            const y = ((event.clientY - rect.top) / rect.height) * 100;

            if (this.resizing === 'photo') {
                const newW = Math.max(5, x - this.photoPercent.x);
                const newH = Math.max(5, y - this.photoPercent.y);
                this.photo.width = Math.min(this.templateWidth, Math.round((newW / 100) * this.output.width));
                this.photo.height = Math.min(this.templateHeight, Math.round((newH / 100) * this.output.height));
                this.constrainPhotoSize();
                this.updatePhotoPercent();
                return;
            }

            if (this.dragging === 'photo') {
                const offsetXPercent = (this.dragOffset.x / rect.width) * 100;
                const offsetYPercent = (this.dragOffset.y / rect.height) * 100;
                this.photoPercent.x = Math.max(0, Math.min(100 - this.photoPercent.w, x - offsetXPercent));
                this.photoPercent.y = Math.max(0, Math.min(100 - this.photoPercent.h, y - offsetYPercent));
                this.photo.x = Math.round((this.photoPercent.x / 100) * this.output.width);
                this.photo.y = Math.round((this.photoPercent.y / 100) * this.output.height);
            } else if (this.dragging && this.dragging.startsWith('field-')) {
                const idx = parseInt(this.dragging.split('-')[1]);
                const field = this.fields[idx];
                const offsetXPercent = (this.dragOffset.x / rect.width) * 100;
                const offsetYPercent = (this.dragOffset.y / rect.height) * 100;
                field.xPercent = Math.max(0, Math.min(95, x - offsetXPercent));
                field.yPercent = Math.max(0, Math.min(95, y - offsetYPercent));
                field.x = Math.round((field.xPercent / 100) * this.output.width);
                field.y = Math.round((field.yPercent / 100) * this.output.height);
            }
        },

        stopDrag() {
            this.dragging = null;
            this.resizing = null;
        },

        addField() {
            this.fields.push({
                label: '',
                placeholder: '',
                x: 540,
                y: 800,
                xPercent: 50,
                yPercent: 74,
                font_size: 32,
                font_color: '#ffffff',
                max_width: 400,
                text_align: 'CENTER',
                bg_color: 'rgba(0,0,0,0.3)',
                required: true
            });
            this.selectedElement = 'field-' + (this.fields.length - 1);
            this.$nextTick(() => { if (window.lucide) lucide.createIcons(); });
        },

        removeSelectedField() {
            if (this.selectedElement && this.selectedElement.startsWith('field-')) {
                const idx = parseInt(this.selectedElement.split('-')[1]);
                this.fields.splice(idx, 1);
                this.selectedElement = null;
            }
        },

        prepareSubmit() {
            return true;
        }
    }
}
</script>
{% endblock %}
