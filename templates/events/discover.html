{% extends "base.html" %}
{% load slippers %}
{% load i18n %}

{% block title %}{% trans "Discover Events Near You" %} | Reckot{% endblock %}
{% block meta_description %}Find and book tickets for amazing events happening in Africa. Conferences, concerts, workshops, and more. Browse upcoming events on Reckot.{% endblock %}
{% block meta_keywords %}discover events, find events, events near me, Africa events, concerts, conferences, workshops, ticket booking{% endblock %}
{% block og_title %}Discover Events Near You | Reckot{% endblock %}
{% block og_description %}Find and book tickets for amazing events happening in Africa. Conferences, concerts, workshops, and more.{% endblock %}
{% block twitter_title %}Discover Events Near You | Reckot{% endblock %}
{% block twitter_description %}Find and book tickets for amazing events happening in Africa. Browse upcoming events on Reckot.{% endblock %}

{% load static %}

{% block extra_head %}
<script id="events-data" type="application/json">{{ events_json|safe }}</script>
<script id="categories-data" type="application/json">{{ categories_json|safe }}</script>
{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-8" x-data="discover()" @input.debounce.300ms="filterEvents()">
    <div class="text-center mb-6 sm:mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold mb-2">{% trans "Discover Events" %}</h1>
        <p class="text-sm sm:text-base text-muted-foreground">{% trans "Find amazing events happening near you" %}</p>
    </div>

    <div class="mb-6 sm:mb-8 space-y-3 sm:space-y-4" x-data="{ filtersOpen: false }">
        <div class="max-w-4xl mx-auto">
            <div class="flex gap-2">
                <div class="flex-1">
                    {% #input type="text" placeholder="Search events..." attrs='x-model="searchQuery"' %}{% /input %}
                </div>
                <button @click="filtersOpen = !filtersOpen"
                        class="btn btn-ghost sm:hidden shrink-0 px-3"
                        :class="filtersOpen ? 'bg-muted' : ''">
                    <i data-lucide="filter" class="w-4 h-4"></i>
                </button>
            </div>

            <div :class="filtersOpen ? 'block' : 'hidden sm:block'" class="mt-3 sm:mt-0 space-y-3">
                <div class="flex flex-col sm:flex-row gap-3 sm:mt-3">
                    <div class="flex-1">
                        {% #input type="text" placeholder="Location..." attrs='x-model="locationQuery"' %}{% /input %}
                    </div>
                    <div class="flex-1">
                        <select x-model="selectedDate" @change="filterEvents()" class="input w-full">
                            <option value="all">{% trans "All Dates" %}</option>
                            <option value="today">{% trans "Today" %}</option>
                            <option value="week">{% trans "This Week" %}</option>
                            <option value="month">{% trans "This Month" %}</option>
                        </select>
                    </div>
                </div>

                <div class="flex flex-wrap gap-2" x-show="categories.length > 0">
                    <button type="button" @click="selectedCategory = ''; filterEvents()" :class="selectedCategory === '' ? 'bg-foreground text-background' : ''" class="btn btn-ghost btn-sm text-xs sm:text-sm">
                        {% trans "All" %}
                    </button>
                    <template x-for="category in categories" :key="category.slug">
                        <button type="button" @click="selectedCategory = category.slug; filterEvents()" :class="selectedCategory === category.slug ? 'bg-foreground text-background' : ''" class="btn btn-ghost btn-sm flex items-center gap-1.5 text-xs sm:text-sm">
                            <i :data-lucide="category.icon || 'tag'" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                            <span x-text="category.name"></span>
                        </button>
                    </template>
                </div>
            </div>
        </div>

        <div class="text-center text-xs sm:text-sm text-muted-foreground">
            <span x-text="filteredEvents.length"></span> {% trans "events found" %}
        </div>
    </div>

    <div x-show="filteredEvents.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <template x-for="event in filteredEvents" :key="event.id">
            <a :href="event.url" class="card hover:shadow-lg transition-shadow no-underline">
                <div x-show="event.cover_image" class="w-full h-48 overflow-hidden rounded-t-xl">
                    <img :src="event.cover_image" :alt="event.title" class="w-full h-full object-cover">
                </div>
                <div class="p-6">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex gap-2 flex-wrap">
                            <div x-show="event.category_name" class="badge badge-default">
                                <span x-text="event.category_name"></span>
                            </div>
                            <div :class="getEventStatus(event).class">
                                <span x-text="getEventStatus(event).label"></span>
                            </div>
                        </div>
                        <span x-show="event.min_price > 0" class="text-sm font-semibold text-foreground">
                            <span x-text="event.min_price"></span> XAF
                        </span>
                        <span x-show="event.is_free" class="text-sm font-semibold text-success">
                            {% trans "Free" %}
                        </span>
                    </div>
                    <h3 class="font-semibold text-lg mb-2 text-foreground" x-text="event.title"></h3>
                    <div class="text-sm text-muted-foreground mb-4 line-clamp-2" x-text="event.short_description"></div>
                    <div class="flex items-center gap-4 text-sm text-muted-foreground">
                        <span class="flex items-center gap-1">
                            <i data-lucide="clock" class="w-4 h-4"></i>
                            <span x-text="event.date_formatted"></span>
                        </span>
                        <span class="flex items-center gap-1">
                            <i data-lucide="map-pin" class="w-4 h-4"></i>
                            <span x-text="event.location_short"></span>
                        </span>
                    </div>
                </div>
            </a>
        </template>
    </div>

    <div x-show="filteredEvents.length === 0" class="text-center py-16">
        <div class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-foreground/5 mb-4">
            <i data-lucide="calendar-x" class="w-8 h-8 text-muted-foreground"></i>
        </div>
        <h3 class="font-semibold text-lg mb-2">{% trans "No events found" %}</h3>
        <p class="text-muted-foreground">{% trans "Try adjusting your search criteria" %}</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('discover', () => ({
        searchQuery: '',
        locationQuery: '',
        selectedCategory: '',
        selectedDate: 'all',
        filteredEvents: [],
        allEvents: [],
        categories: [],

        init() {
            this.allEvents = JSON.parse(document.getElementById('events-data').textContent);
            this.categories = JSON.parse(document.getElementById('categories-data').textContent);
            this.filterEvents();
            this.$nextTick(() => {
                if (window.lucide) {
                    lucide.createIcons();
                }
            });
        },

        getEventStatus(event) {
            const now = new Date();
            const startAt = new Date(event.start_at);
            const endAt = new Date(event.end_at);

            if (now >= startAt && now <= endAt) {
                return { status: 'live', label: 'Live Now', class: 'badge badge-danger animate-pulse' };
            }

            if (now > endAt) {
                return { status: 'passed', label: 'Ended', class: 'badge badge-default' };
            }

            const diff = startAt - now;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const months = Math.floor(days / 30);

            let timeLabel;
            if (months > 0) {
                timeLabel = months === 1 ? 'in 1 month' : `in ${months} months`;
            } else if (days > 0) {
                timeLabel = days === 1 ? 'in 1 day' : `in ${days} days`;
            } else if (hours > 0) {
                timeLabel = hours === 1 ? 'in 1 hour' : `in ${hours} hours`;
            } else {
                timeLabel = minutes === 1 ? 'in 1 minute' : `in ${minutes} minutes`;
            }

            return { status: 'upcoming', label: timeLabel, class: 'badge badge-success' };
        },

        filterEvents() {
            let events = this.allEvents;

            if (this.searchQuery) {
                const query = this.searchQuery.toLowerCase();
                events = events.filter(e =>
                    e.title.toLowerCase().includes(query) ||
                    e.description.toLowerCase().includes(query)
                );
            }

            if (this.locationQuery) {
                const loc = this.locationQuery.toLowerCase();
                events = events.filter(e =>
                    e.location.toLowerCase().includes(loc) ||
                    e.city.toLowerCase().includes(loc)
                );
            }

            if (this.selectedCategory) {
                events = events.filter(e => e.category_slug === this.selectedCategory);
            }

            if (this.selectedDate !== 'all') {
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                events = events.filter(e => {
                    const eventDate = new Date(e.start_at);
                    eventDate.setHours(0, 0, 0, 0);

                    if (this.selectedDate === 'today') {
                        return eventDate.getTime() === now.getTime();
                    } else if (this.selectedDate === 'week') {
                        const startOfWeek = new Date(now);
                        const dayOfWeek = now.getDay();
                        const daysToMonday = (dayOfWeek === 0 ? 6 : dayOfWeek - 1);
                        startOfWeek.setDate(now.getDate() - daysToMonday);
                        startOfWeek.setHours(0, 0, 0, 0);

                        const endOfWeek = new Date(startOfWeek);
                        endOfWeek.setDate(startOfWeek.getDate() + 6);
                        endOfWeek.setHours(23, 59, 59, 999);

                        return eventDate >= startOfWeek && eventDate <= endOfWeek;
                    } else if (this.selectedDate === 'month') {
                        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                        startOfMonth.setHours(0, 0, 0, 0);

                        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                        endOfMonth.setHours(23, 59, 59, 999);

                        return eventDate >= startOfMonth && eventDate <= endOfMonth;
                    }
                    return true;
                });
            }

            this.filteredEvents = events;
        }
    }));
});
</script>
{% endblock %}
