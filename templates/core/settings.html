{% extends "layouts/dashboard.html" %}
{% load slippers %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Settings" %} - Reckot{% endblock %}

{% block header_title %}
<div class="min-w-0">
    <h1 class="text-lg font-semibold truncate">{% trans "Settings" %}</h1>
    <p class="text-sm text-muted-foreground hidden md:block">{% trans "Manage your account settings" %}</p>
</div>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Column: Profile & Account -->
        <div class="space-y-6">
            <div class="card p-6">
                <h2 class="text-lg font-semibold mb-4">{% trans "Profile Information" %}</h2>
                <form method="post" enctype="multipart/form-data" class="space-y-4">
                    {% csrf_token %}
                    <div class="flex items-center gap-6 pb-4 border-b border-border">
                        <div class="flex-shrink-0">
                            {% if user.get_profile_image_url %}
                            <img src="{{ user.get_profile_image_url }}" alt="{{ user.get_full_name|default:user.email }}" class="h-20 w-20 rounded-full object-cover ring-2 ring-border">
                            {% else %}
                            <div class="flex h-20 w-20 items-center justify-center rounded-full bg-foreground text-background text-2xl font-semibold ring-2 ring-border">
                                {{ user.get_initials }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <label for="profile_image" class="block text-sm font-medium mb-2">{% trans "Profile Picture" %}</label>
                            <div class="flex flex-col gap-2">
                                <div class="relative">
                                    <input type="file" name="profile_image" id="profile_image" accept="image/*" class="hidden" onchange="document.getElementById('file-name').textContent = this.files[0]?.name || 'No file chosen'">
                                    <label for="profile_image" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-border bg-card hover:bg-muted transition-colors cursor-pointer text-sm font-medium">
                                        <i data-lucide="upload" class="w-4 h-4"></i>
                                        {% trans "Choose Image" %}
                                    </label>
                                    <span id="file-name" class="text-xs text-muted-foreground ml-3">{% trans "No file chosen" %}</span>
                                </div>
                                <p class="text-xs text-muted-foreground">{% trans "Recommended: Square image, at least 200x200px" %}</p>
                            </div>
                        </div>
                    </div>
                    <div class="grid gap-4 sm:grid-cols-2">
                        <div>
                            <label for="first_name" class="block text-sm font-medium mb-2">{% trans "First name" %}</label>
                            <input type="text" name="first_name" id="first_name" value="{{ user.first_name }}" placeholder="{% trans 'Enter your first name' %}" class="input">
                        </div>
                        <div>
                            <label for="last_name" class="block text-sm font-medium mb-2">{% trans "Last name" %}</label>
                            <input type="text" name="last_name" id="last_name" value="{{ user.last_name }}" placeholder="{% trans 'Enter your last name' %}" class="input">
                        </div>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium mb-2">{% trans "Email address" %}</label>
                        <input type="email" id="email" value="{{ user.email }}" disabled class="input bg-muted cursor-not-allowed">
                        <p class="text-xs text-muted-foreground mt-1">{% trans "Email cannot be changed" %}</p>
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium mb-2">{% trans "Phone number" %}</label>
                        <input type="tel" name="phone" id="phone" value="{{ user.phone_number|default:'' }}" placeholder="6XX XXX XXX" class="input">
                    </div>
                    <div class="pt-2">
                        {% #button type="submit" variant="default" %}
                            {% trans "Save changes" %}
                            <i data-lucide="check" class="w-4 h-4"></i>
                        {% /button %}
                    </div>
                </form>
            </div>

            <div class="card p-6">
                <h2 class="text-lg font-semibold mb-4">{% trans "Account Status" %}</h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between py-3 border-b border-border">
                        <div>
                            <p class="font-medium">{% trans "Email verification" %}</p>
                            <p class="text-sm text-muted-foreground">{{ user.email }}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            {% if user.email_verified %}
                            <span class="badge badge-success">{% trans "Verified" %}</span>
                            {% else %}
                            <span class="badge badge-warning">{% trans "Not verified" %}</span>
                            <a href="{% url 'account_email' %}">
                                {% #button variant="outline" size="sm" %}
                                    <i data-lucide="mail" class="w-3 h-3"></i>
                                    {% trans "Verify" %}
                                {% /button %}
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex items-center justify-between py-3">
                        <div>
                            <p class="font-medium">{% trans "Account created" %}</p>
                            <p class="text-sm text-muted-foreground">{{ user.date_joined|date:"F d, Y" }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <h2 class="text-lg font-semibold mb-4">{% trans "Security" %}</h2>
                <div class="space-y-4">
                    <a href="{% url 'account_change_password' %}" class="flex items-center justify-between py-3 border-b border-border hover:bg-muted/50 -mx-6 px-6 transition-colors">
                        <div>
                            <p class="font-medium">{% trans "Change password" %}</p>
                            <p class="text-sm text-muted-foreground">{% trans "Update your account password" %}</p>
                        </div>
                        <i data-lucide="chevron-right" class="h-5 w-5 text-muted-foreground"></i>
                    </a>
                    <a href="{% url 'account_logout' %}?next={{ request.path }}" class="flex items-center justify-between py-3 hover:bg-red-500/10 -mx-6 px-6 transition-colors text-red-500">
                        <div>
                            <p class="font-medium">{% trans "Sign out" %}</p>
                            <p class="text-sm text-red-400">{% trans "Log out of your account" %}</p>
                        </div>
                        <i data-lucide="log-out" class="h-5 w-5"></i>
                    </a>
                </div>
            </div>

            <div class="card p-6 border-red-500/20" x-data="{ deleteModalOpen: false }">
                <h2 class="text-lg font-semibold mb-4 text-red-500">{% trans "Danger Zone" %}</h2>
                <div class="space-y-4">
                    <div class="rounded-lg bg-red-500/10 border border-red-500/20 p-4">
                        <div class="flex items-start gap-3">
                            <i data-lucide="alert-triangle" class="w-5 h-5 shrink-0 mt-0.5 text-red-500"></i>
                            <div class="flex-1">
                                <p class="font-medium text-red-500 mb-1">{% trans "Delete Account" %}</p>
                                <p class="text-sm text-red-600 dark:text-red-400 mb-3">
                                    {% trans "Permanently delete your account and all associated data. This action cannot be undone." %}
                                </p>
                                <button type="button"
                                        @click="deleteModalOpen = true"
                                        class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-medium">
                                    {% trans "Delete My Account" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Account Modal -->
                <div x-show="deleteModalOpen"
                     x-cloak
                     class="fixed inset-0 z-50 overflow-y-auto"
                     @keydown.escape.window="deleteModalOpen = false">
                    <div class="flex min-h-screen items-center justify-center p-4">
                        <div class="fixed inset-0 bg-black/50 transition-opacity"
                             @click="deleteModalOpen = false"></div>
                        <div class="relative bg-card rounded-lg shadow-xl max-w-md w-full p-6 border border-border">
                            <div class="flex items-start gap-4 mb-4">
                                <div class="h-12 w-12 rounded-full bg-red-500/10 flex items-center justify-center shrink-0">
                                    <i data-lucide="alert-triangle" class="h-6 w-6 text-red-500"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold mb-1">{% trans "Delete Account" %}</h3>
                                    <p class="text-sm text-muted-foreground">
                                        {% trans "Are you absolutely sure? This will permanently delete your account, all your events, tickets, and data. This action cannot be undone." %}
                                    </p>
                                </div>
                            </div>
                            <form method="post" action="{% url 'core:delete_account' %}" class="space-y-4">
                                {% csrf_token %}
                                <div>
                                    <label for="delete_password" class="block text-sm font-medium mb-2">
                                        {% trans "Enter your password to confirm" %}
                                    </label>
                                    <input type="password"
                                           name="password"
                                           id="delete_password"
                                           required
                                           class="input"
                                           placeholder="{% trans 'Your password' %}">
                                </div>
                                <div class="flex gap-3 justify-end">
                                    <button type="button"
                                            @click="deleteModalOpen = false"
                                            class="px-4 py-2 rounded-lg border border-border hover:bg-muted transition-colors">
                                        {% trans "Cancel" %}
                                    </button>
                                    <button type="submit"
                                            class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium">
                                        {% trans "Delete My Account" %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Preferences & Features -->
        <div class="space-y-6">
            <div class="card p-6" x-data="{ langDropdownOpen: false }">
                <h2 class="text-lg font-semibold mb-4">{% trans "Language Preferences" %}</h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between py-3 border-b border-border">
                        <div>
                            <p class="font-medium">{% trans "Display language" %}</p>
                            <p class="text-sm text-muted-foreground">{% trans "Choose your preferred language for the platform" %}</p>
                        </div>
                        <div class="relative">
                            <button @click="langDropdownOpen = !langDropdownOpen"
                                    @click.outside="langDropdownOpen = false"
                                    class="flex items-center gap-2 px-4 py-2 rounded-lg border border-border bg-card hover:bg-muted transition-colors text-sm min-w-[140px] justify-between"
                                    type="button">
                                <span class="flex items-center gap-2">
                                    <i data-lucide="globe" class="h-4 w-4" aria-hidden="true"></i>
                                    {% if LANGUAGE_CODE == 'fr' %}Français{% else %}English{% endif %}
                                </span>
                                <i data-lucide="chevron-down" class="h-4 w-4 text-muted-foreground transition-transform" :class="langDropdownOpen && 'rotate-180'" aria-hidden="true"></i>
                            </button>
                            <div x-show="langDropdownOpen"
                                 x-transition:enter="transition ease-out duration-100"
                                 x-transition:enter-start="opacity-0 scale-95"
                                 x-transition:enter-end="opacity-100 scale-100"
                                 x-transition:leave="transition ease-in duration-75"
                                 x-transition:leave-start="opacity-100 scale-100"
                                 x-transition:leave-end="opacity-0 scale-95"
                                 class="absolute right-0 mt-2 w-48 origin-top-right rounded-lg border border-border bg-card shadow-lg z-50"
                                 x-cloak>
                                <div class="p-1">
                                    <form action="{% url 'set_language' %}" method="post" class="m-0">
                                        {% csrf_token %}
                                        <input type="hidden" name="next" value="{{ request.path }}">
                                        <input type="hidden" name="language" value="en">
                                        <button type="submit"
                                                class="flex items-center gap-3 w-full rounded-md px-3 py-2 text-sm hover:bg-muted transition-colors {% if LANGUAGE_CODE == 'en' %}bg-muted{% endif %}">
                                            <span class="text-base font-medium">EN</span>
                                            <span class="flex-1 text-left">English</span>
                                            {% if LANGUAGE_CODE == 'en' %}
                                            <i data-lucide="check" class="h-4 w-4 text-foreground" aria-hidden="true"></i>
                                            {% endif %}
                                        </button>
                                    </form>
                                    <form action="{% url 'set_language' %}" method="post" class="m-0">
                                        {% csrf_token %}
                                        <input type="hidden" name="next" value="{{ request.path }}">
                                        <input type="hidden" name="language" value="fr">
                                        <button type="submit"
                                                class="flex items-center gap-3 w-full rounded-md px-3 py-2 text-sm hover:bg-muted transition-colors {% if LANGUAGE_CODE == 'fr' %}bg-muted{% endif %}">
                                            <span class="text-base font-medium">FR</span>
                                            <span class="flex-1 text-left">Français</span>
                                            {% if LANGUAGE_CODE == 'fr' %}
                                            <i data-lucide="check" class="h-4 w-4 text-foreground" aria-hidden="true"></i>
                                            {% endif %}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="rounded-lg bg-blue-500/10 border border-blue-500/20 p-4 text-sm text-blue-600 dark:text-blue-400">
                        <div class="flex gap-3">
                            <i data-lucide="info" class="w-5 h-5 shrink-0 mt-0.5"></i>
                            <div>
                                <p class="font-medium mb-1">{% trans "About language settings" %}</p>
                                <p class="text-xs text-blue-500 dark:text-blue-300">{% trans "Changing your language preference will update the interface immediately. Your choice is saved in your browser session." %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-6" x-data="{
                offlineMode: false,
                syncing: false,
                pendingCount: 0,
                async init() {
                    if (window.ReckotOffline) {
                        this.offlineMode = await ReckotOffline.isOfflineModeEnabled();
                        const queue = await ReckotOffline.getSyncQueue();
                        this.pendingCount = queue.length;
                    }
                },
                async toggleOffline() {
                    if (window.ReckotOffline) {
                        await ReckotOffline.setOfflineMode(this.offlineMode);
                        if (this.offlineMode) {
                            window.OfflineIndicator?.init();
                        }
                    }
                },
                async syncNow() {
                    if (!window.ReckotOffline) return;
                    this.syncing = true;
                    const result = await ReckotOffline.syncPendingChanges();
                    this.syncing = false;
                    this.pendingCount = (await ReckotOffline.getSyncQueue()).length;
                }
            }">
                <h2 class="text-lg font-semibold mb-4">{% trans "Offline Mode" %}</h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between py-3 border-b border-border">
                        <div>
                            <p class="font-medium">{% trans "Enable offline mode" %}</p>
                            <p class="text-sm text-muted-foreground">{% trans "Work without internet, sync when reconnected" %}</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" x-model="offlineMode" @change="toggleOffline()" class="sr-only peer">
                            <div class="w-11 h-6 bg-border peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer transition-colors duration-200 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-background after:rounded-full after:h-5 after:w-5 after:transition-all after:shadow-md peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div x-show="offlineMode" x-cloak class="space-y-3">
                        <div class="flex items-center justify-between py-3 border-b border-border">
                            <div>
                                <p class="font-medium">{% trans "Pending changes" %}</p>
                                <p class="text-sm text-muted-foreground" x-text="pendingCount + ' {% trans "item" %}' + (pendingCount !== 1 ? 's' : '') + ' {% trans "waiting to sync" %}'"></p>
                            </div>
                            {% #button type="button" variant="outline" size="sm" attrs='@click="syncNow()" :disabled="syncing || pendingCount === 0" :class="syncing && \'opacity-50 cursor-not-allowed\'"' %}
                                <i x-show="!syncing" data-lucide="refresh-cw" class="w-4 h-4"></i>
                                <i x-show="syncing" x-cloak data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                                <span x-text="syncing ? 'Syncing...' : 'Sync now'"></span>
                            {% /button %}
                        </div>
                        <div class="rounded-lg bg-blue-500/10 border border-blue-500/20 p-4 text-sm text-blue-600 dark:text-blue-400">
                            <div class="flex gap-3">
                                <i data-lucide="info" class="w-5 h-5 shrink-0 mt-0.5"></i>
                                <div>
                                    <p class="font-medium mb-1">{% trans "How offline mode works" %}</p>
                                    <ul class="text-xs space-y-1 text-blue-500 dark:text-blue-300">
                                        <li>{% trans "Forms auto-save to your device as you type" %}</li>
                                        <li>{% trans "Changes are queued when you're offline" %}</li>
                                        <li>{% trans "Data syncs automatically when you reconnect" %}</li>
                                        <li>{% trans "Cached pages remain accessible offline" %}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <h2 class="text-lg font-semibold mb-4">{% trans "Privacy & AI" %}</h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between py-3 border-b border-border">
                        <div>
                            <p class="font-medium">{% trans "AI Features" %}</p>
                            <p class="text-sm text-muted-foreground">{% trans "Enable AI-powered tools and features" %}</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox"
                                   id="ai_features_enabled"
                                   name="ai_features_enabled"
                                   {% if user.ai_features_enabled %}checked{% endif %}
                                   class="sr-only peer"
                                   hx-post="{% url 'core:toggle_ai_features' %}"
                                   hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                   hx-trigger="change">
                            <div class="w-11 h-6 bg-border peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer transition-colors duration-200 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-background after:rounded-full after:h-5 after:w-5 after:transition-all after:shadow-md peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div class="rounded-lg bg-blue-500/10 border border-blue-500/20 p-4 text-sm text-blue-600 dark:text-blue-400">
                        <div class="flex gap-3">
                            <i data-lucide="shield-check" class="w-5 h-5 shrink-0 mt-0.5"></i>
                            <div>
                                <p class="font-medium mb-1">{% trans "About AI features" %}</p>
                                <ul class="text-xs space-y-1 text-blue-500 dark:text-blue-300">
                                    <li>{% trans "Voice-to-Event Creator: Create events by speaking" %}</li>
                                    <li>{% trans "AI Cover Images: Generate professional event images" %}</li>
                                    <li>{% trans "Smart Descriptions: Enhance event descriptions" %}</li>
                                    <li>{% trans "Analytics Insights: Get AI-powered recommendations" %}</li>
                                </ul>
                                <p class="text-xs text-blue-500 dark:text-blue-300 mt-2">
                                    {% trans "Disabling AI features will hide all AI tools across the platform. Your data is never used to train AI models without permission." %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
