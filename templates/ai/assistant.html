{% extends "base.html" %}
{% load slippers %}
{% load i18n %}

{% block title %}{% trans "AI Assistant" %} - Reckot{% endblock %}

{% block content %}
<div class="container py-8" x-data="aiAssistant()">
    {% #breadcrumb %}
        {% #breadcrumb_item href="/" %}{% trans "Home" %}{% /breadcrumb_item %}
        {% #breadcrumb_separator %}{% /breadcrumb_separator %}
        {% #breadcrumb_item %}{% trans "AI Assistant" %}{% /breadcrumb_item %}
    {% /breadcrumb %}

    <div class="mx-auto mt-8 max-w-3xl">
        {% #card class="shadow-xl" %}
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-gradient-animated">
                        <i data-lucide="bot" class="h-6 w-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">{% trans "Reckot AI Assistant" %}</h1>
                        <p class="text-sm text-muted-foreground">{% trans "Powered by Google Gemini" %}</p>
                    </div>
                </div>
                <button @click="clearConversation()" class="text-sm text-muted-foreground hover:text-foreground transition-colors">
                    <i data-lucide="trash-2" class="h-4 w-4"></i>
                </button>
            </div>

            <div id="chat-container" class="h-[400px] overflow-y-auto space-y-4 mb-4 p-4 rounded-xl bg-muted/50">
                <template x-if="messages.length === 0">
                    <div class="text-center py-12">
                        <div class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-primary/10 mb-4">
                            <i data-lucide="message-circle" class="h-8 w-8 text-primary"></i>
                        </div>
                        <h3 class="font-medium mb-2">{% trans "How can I help you today?" %}</h3>
                        <p class="text-sm text-muted-foreground mb-4">{% trans "Ask me about events, tickets, payments, or any issues you're experiencing." %}</p>
                        <div class="flex flex-wrap justify-center gap-2">
                            <button @click="sendMessage('How do I create an event?')" class="text-xs px-3 py-1.5 rounded-full bg-background border hover:bg-accent transition-colors">
                                {% trans "How to create an event?" %}
                            </button>
                            <button @click="sendMessage('I have a payment issue')" class="text-xs px-3 py-1.5 rounded-full bg-background border hover:bg-accent transition-colors">
                                {% trans "Payment issue" %}
                            </button>
                            <button @click="sendMessage('How do I check in attendees?')" class="text-xs px-3 py-1.5 rounded-full bg-background border hover:bg-accent transition-colors">
                                {% trans "Check-in help" %}
                            </button>
                        </div>
                    </div>
                </template>

                <template x-for="(msg, index) in messages" :key="index">
                    <div :class="msg.role === 'USER' ? 'flex justify-end' : 'flex justify-start'">
                        <div :class="msg.role === 'USER'
                            ? 'bg-primary text-primary-foreground rounded-2xl rounded-br-md px-4 py-2 max-w-[80%]'
                            : 'bg-background border rounded-2xl rounded-bl-md px-4 py-2 max-w-[80%]'">
                            <p class="text-sm whitespace-pre-wrap" x-text="msg.content"></p>
                        </div>
                    </div>
                </template>

                <template x-if="isLoading">
                    <div class="flex justify-start">
                        <div class="bg-background border rounded-2xl rounded-bl-md px-4 py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 bg-primary rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <form @submit.prevent="sendMessage()" class="flex gap-2">
                <input
                    type="text"
                    x-model="inputMessage"
                    placeholder="{% trans 'Type your message...' %}"
                    class="input flex-1"
                    :disabled="isLoading"
                >
                {% #button type="submit" variant="default" x-bind:disabled="isLoading || !inputMessage.trim()" %}
                    <i data-lucide="send" class="h-4 w-4"></i>
                {% /button %}
            </form>

            <div class="mt-4 pt-4 border-t flex items-center justify-between text-xs text-muted-foreground">
                <span>{% trans "Can't resolve your issue?" %}</span>
                <a href="{% url 'ai:ticket_create' %}" class="text-primary hover:underline">
                    {% trans "Create support ticket" %}
                </a>
            </div>
        {% /card %}
    </div>
</div>

<script>
function aiAssistant() {
    return {
        messages: {{ messages|safe|default:"[]" }},
        inputMessage: '',
        isLoading: false,

        async sendMessage(preset = null) {
            const message = preset || this.inputMessage.trim();
            if (!message) return;

            this.messages.push({ role: 'USER', content: message });
            this.inputMessage = '';
            this.isLoading = true;
            this.scrollToBottom();

            try {
                const response = await fetch('{% url "ai:chat" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                const data = await response.json();
                this.messages.push({ role: 'ASSISTANT', content: data.message });
            } catch (error) {
                this.messages.push({ role: 'ASSISTANT', content: '{% trans "Sorry, something went wrong. Please try again." %}' });
            }

            this.isLoading = false;
            this.scrollToBottom();
        },

        async clearConversation() {
            if (!confirm('{% trans "Clear conversation history?" %}')) return;
            await fetch('{% url "ai:clear" %}', { method: 'POST' });
            this.messages = [];
        },

        scrollToBottom() {
            this.$nextTick(() => {
                const container = document.getElementById('chat-container');
                container.scrollTop = container.scrollHeight;
            });
        }
    }
}
</script>
{% endblock %}
