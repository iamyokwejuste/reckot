{% extends "base.html" %}
{% load slippers %}
{% load i18n %}

{% block title %}{% trans "AI Assistant" %} - Reckot{% endblock %}

{% block extra_head %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function aiAssistant() {
    return {
        messages: [],
        inputMessage: '',
        isLoading: false,
        sessionId: '',
        messageCounter: 0,
        autoScroll: true,

        async sendMessage(preset = null) {
            const message = preset || this.inputMessage.trim();
            if (!message) return;

            this.messages.push({
                id: ++this.messageCounter,
                role: 'USER',
                content: message,
                timestamp: Date.now()
            });
            this.inputMessage = '';
            this.isLoading = true;

            setTimeout(() => this.scrollToBottom(), 50);

            try {
                const csrftoken = getCookie('csrftoken');
                const response = await fetch('/ai/assistant/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: this.sessionId || null
                    })
                });
                const data = await response.json();

                if (!response.ok) {
                    let errorMessage = data.error || 'Sorry, something went wrong. Please try again.';
                    if (data.disabled) {
                        errorMessage += '\n\nYou can enable AI features in your account settings.';
                    }
                    this.messages.push({
                        id: ++this.messageCounter,
                        role: 'ASSISTANT',
                        content: errorMessage,
                        timestamp: Date.now()
                    });
                } else {
                    this.messages.push({
                        id: ++this.messageCounter,
                        role: 'ASSISTANT',
                        content: data.message,
                        timestamp: Date.now()
                    });

                    if (data.session_id && !this.sessionId) {
                        this.sessionId = data.session_id;
                        window.history.pushState({}, '', `/ai/assistant/${data.session_id}/`);
                    }
                }
            } catch (error) {
                this.messages.push({
                    id: ++this.messageCounter,
                    role: 'ASSISTANT',
                    content: 'Sorry, something went wrong. Please try again.',
                    timestamp: Date.now()
                });
            }

            this.isLoading = false;
            setTimeout(() => this.scrollToBottom(), 50);
        },

        async clearConversation() {
            if (!confirm('Clear conversation history?')) return;
            const csrftoken = getCookie('csrftoken');
            await fetch('/ai/assistant/clear/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    session_id: this.sessionId || null
                })
            });
            this.messages = [];
            this.messageCounter = 0;
            this.sessionId = '';
            window.history.pushState({}, '', '/ai/assistant/');
        },

        scrollToBottom() {
            if (!this.autoScroll) return;

            const container = document.getElementById('chat-container');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        },

        handleScroll(event) {
            const container = event.target;
            const isAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 50;
            this.autoScroll = isAtBottom;
        },

        init() {
            try {
                const messagesData = JSON.parse('{{ chat_messages|escapejs }}' || '[]');

                if (Array.isArray(messagesData)) {
                    this.messages = messagesData.map((msg, idx) => ({
                        ...msg,
                        id: ++this.messageCounter,
                        timestamp: Date.now() - (messagesData.length - idx) * 1000
                    }));
                } else {
                    this.messages = [];
                }

                this.sessionId = '{{ session_id|default:"" }}';
                setTimeout(() => this.scrollToBottom(), 100);
            } catch (error) {
                this.messages = [];
                this.sessionId = '';
                this.messageCounter = 0;
            }
        }
    }
}
</script>
{% endblock %}

{% block content %}
<div class="container py-8" x-data="aiAssistant()" x-init="init()" x-cloak>
    {% #breadcrumb %}
        {% #breadcrumb_item href="/" %}{% trans "Home" %}{% /breadcrumb_item %}
        {% #breadcrumb_separator %}{% /breadcrumb_separator %}
        {% #breadcrumb_item %}{% trans "AI Assistant" %}{% /breadcrumb_item %}
    {% /breadcrumb %}

    <div class="mx-auto mt-8 max-w-3xl">
        {% #card class="shadow-xl" %}
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-gradient-animated">
                        <i data-lucide="bot" class="h-6 w-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">{% trans "Reckot AI Assistant" %}</h1>
                        <p class="text-sm text-muted-foreground">{% trans "Powered by Google Gemini" %} <span class="text-xs" x-text="'(' + messages.length + ' messages)'"></span></p>
                    </div>
                </div>
                <button @click="clearConversation()" class="text-sm text-muted-foreground hover:text-foreground transition-colors">
                    <i data-lucide="trash-2" class="h-4 w-4"></i>
                </button>
            </div>

            <div id="chat-container" @scroll="handleScroll" class="h-[400px] overflow-y-auto space-y-4 mb-4 p-4 rounded-xl bg-muted/50">
                <div x-show="messages.length === 0" class="text-center py-12">
                    <div class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-primary/10 mb-4">
                        <i data-lucide="message-circle" class="h-8 w-8 text-primary"></i>
                    </div>
                    <h3 class="font-medium mb-2">{% trans "How can I help you today?" %}</h3>
                    <p class="text-sm text-muted-foreground mb-4">{% trans "Ask me about events, tickets, payments, or any issues you're experiencing." %}</p>
                    <div class="flex flex-wrap justify-center gap-2">
                        <button @click="sendMessage('How do I create an event?')" class="text-xs px-3 py-1.5 rounded-full bg-background border hover:bg-accent transition-colors">
                            {% trans "How to create an event?" %}
                        </button>
                        <button @click="sendMessage('I have a payment issue')" class="text-xs px-3 py-1.5 rounded-full bg-background border hover:bg-accent transition-colors">
                            {% trans "Payment issue" %}
                        </button>
                        <button @click="sendMessage('How do I check in attendees?')" class="text-xs px-3 py-1.5 rounded-full bg-background border hover:bg-accent transition-colors">
                            {% trans "Check-in help" %}
                        </button>
                    </div>
                </div>

                <!-- Messages list -->
                <div class="space-y-4">
                    <template x-for="msg in messages" :key="msg.id">
                        <div :class="msg.role === 'USER' ? 'flex justify-end' : 'flex justify-start'">
                            <div :class="msg.role === 'USER'
                                ? 'bg-primary text-primary-foreground rounded-2xl rounded-br-md px-4 py-2 max-w-[80%]'
                                : 'bg-background border rounded-2xl rounded-bl-md px-4 py-2 max-w-[80%]'">
                                <p class="text-sm whitespace-pre-wrap" x-text="msg.content"></p>
                            </div>
                        </div>
                    </template>
                </div>

                <template x-if="isLoading">
                    <div class="flex justify-start">
                        <div class="bg-background border rounded-2xl rounded-bl-md px-4 py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 bg-primary rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <form @submit.prevent="sendMessage()" class="space-y-2">
                <div class="flex gap-2">
                    <input
                        type="text"
                        x-model="inputMessage"
                        placeholder="{% trans 'Type your message...' %}"
                        class="input flex-1"
                        :disabled="isLoading"
                        maxlength="500"
                    >
                    {% #button type="submit" variant="default" x-bind:disabled="isLoading || !inputMessage.trim()" %}
                        <i data-lucide="send" class="h-4 w-4"></i>
                    {% /button %}
                </div>
                <p class="text-xs text-muted-foreground" x-show="inputMessage.trim().split(/\s+/).length > 50" x-cloak>
                    <span class="text-destructive font-medium">{% trans "Message too long!" %}</span>
                    <span x-text="inputMessage.trim().split(/\s+/).length"></span>/50 {% trans "words max" %}
                </p>
            </form>

            <div class="mt-4 pt-4 border-t flex items-center justify-between text-xs text-muted-foreground">
                <span>{% trans "Can't resolve your issue?" %}</span>
                <a href="{% url 'ai:ticket_create' %}" class="text-primary hover:underline">
                    {% trans "Create support ticket" %}
                </a>
            </div>
        {% /card %}
    </div>
</div>
{% endblock %}
