{% extends "layouts/dashboard.html" %}
{% load slippers %}

{% block title %}Export Center - {{ event.title }} - Reckot{% endblock %}

{% block breadcrumbs %}
{% url 'events:dashboard' org_slug=event.organization.slug event_slug=event.slug as event_dashboard_url %}
{% url 'reports:dashboard' org_slug=event.organization.slug event_slug=event.slug as reports_url %}
{% #breadcrumb class="mb-4" %}
    {% #breadcrumb_item href="/" %}Home{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item href="/events/" %}Events{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item href=event_dashboard_url %}{{ event.title|truncatewords:3 }}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item href=reports_url %}Reports{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item %}Export Center{% /breadcrumb_item %}
{% /breadcrumb %}
{% endblock %}

{% block header_title %}
<div>
    <h1 class="text-lg font-semibold">Export Center</h1>
    <p class="text-sm text-muted-foreground">{{ event.title }} - Generate and download reports</p>
</div>
{% endblock %}

{% block header_actions %}
<a href="{% url 'reports:dashboard' event.organization.slug event.slug %}">
    {% #button variant="outline" size="sm" %}
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        Back to Reports
    {% /button %}
</a>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6" x-data="{
    selectedType: '',
    selectedFormat: 'PDF',
    generating: false,
    error: '',
    success: ''
}">
    <div class="card p-6">
        <h2 class="text-lg font-semibold mb-4">Select Report Type</h2>
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            <button type="button" @click="selectedType = 'FINANCIAL'"
                    class="p-4 rounded-lg border-2 text-left transition-all"
                    :class="selectedType === 'FINANCIAL' ? 'border-foreground bg-muted' : 'border-border hover:border-muted-foreground'">
                <div class="flex items-center gap-3 mb-2">
                    <div class="h-10 w-10 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                        <i data-lucide="wallet" class="h-5 w-5 text-emerald-500"></i>
                    </div>
                    <span class="font-medium">Financial Summary</span>
                </div>
                <p class="text-sm text-muted-foreground">Revenue breakdown, payment methods, and ticket sales summary</p>
            </button>

            <button type="button" @click="selectedType = 'RSVP'"
                    class="p-4 rounded-lg border-2 text-left transition-all"
                    :class="selectedType === 'RSVP' ? 'border-foreground bg-muted' : 'border-border hover:border-muted-foreground'">
                <div class="flex items-center gap-3 mb-2">
                    <div class="h-10 w-10 rounded-lg bg-blue-500/10 flex items-center justify-center">
                        <i data-lucide="users" class="h-5 w-5 text-blue-500"></i>
                    </div>
                    <span class="font-medium">Registered Attendees</span>
                </div>
                <p class="text-sm text-muted-foreground">List of all registered attendees with contact details</p>
            </button>

            <button type="button" @click="selectedType = 'TICKET_SALES'"
                    class="p-4 rounded-lg border-2 text-left transition-all"
                    :class="selectedType === 'TICKET_SALES' ? 'border-foreground bg-muted' : 'border-border hover:border-muted-foreground'">
                <div class="flex items-center gap-3 mb-2">
                    <div class="h-10 w-10 rounded-lg bg-purple-500/10 flex items-center justify-center">
                        <i data-lucide="ticket" class="h-5 w-5 text-purple-500"></i>
                    </div>
                    <span class="font-medium">Ticket Sales</span>
                </div>
                <p class="text-sm text-muted-foreground">Detailed ticket sales with buyer information</p>
            </button>

            <button type="button" @click="selectedType = 'PAYMENTS'"
                    class="p-4 rounded-lg border-2 text-left transition-all"
                    :class="selectedType === 'PAYMENTS' ? 'border-foreground bg-muted' : 'border-border hover:border-muted-foreground'">
                <div class="flex items-center gap-3 mb-2">
                    <div class="h-10 w-10 rounded-lg bg-amber-500/10 flex items-center justify-center">
                        <i data-lucide="credit-card" class="h-5 w-5 text-amber-500"></i>
                    </div>
                    <span class="font-medium">Payment Records</span>
                </div>
                <p class="text-sm text-muted-foreground">All payment transactions and their status</p>
            </button>

            <button type="button" @click="selectedType = 'CHECKINS'"
                    class="p-4 rounded-lg border-2 text-left transition-all"
                    :class="selectedType === 'CHECKINS' ? 'border-foreground bg-muted' : 'border-border hover:border-muted-foreground'">
                <div class="flex items-center gap-3 mb-2">
                    <div class="h-10 w-10 rounded-lg bg-cyan-500/10 flex items-center justify-center">
                        <i data-lucide="check-circle" class="h-5 w-5 text-cyan-500"></i>
                    </div>
                    <span class="font-medium">Check-in Report</span>
                </div>
                <p class="text-sm text-muted-foreground">Attendance data with check-in timestamps</p>
            </button>
        </div>
    </div>

    <div class="card p-6" x-show="selectedType" x-cloak x-transition>
        <h2 class="text-lg font-semibold mb-4">Export Format</h2>
        <div class="flex flex-wrap gap-3">
            <button type="button" @click="selectedFormat = 'PDF'"
                    class="px-4 py-2 rounded-lg border-2 font-medium transition-all flex items-center gap-2"
                    :class="selectedFormat === 'PDF' ? 'border-foreground bg-muted' : 'border-border hover:border-muted-foreground'">
                <i data-lucide="file-text" class="w-4 h-4"></i>
                PDF Report
            </button>
            <button type="button" @click="selectedFormat = 'EXCEL'"
                    class="px-4 py-2 rounded-lg border-2 font-medium transition-all flex items-center gap-2"
                    :class="selectedFormat === 'EXCEL' ? 'border-foreground bg-muted' : 'border-border hover:border-muted-foreground'">
                <i data-lucide="table" class="w-4 h-4"></i>
                Excel Spreadsheet
            </button>
            <button type="button" @click="selectedFormat = 'CSV'"
                    class="px-4 py-2 rounded-lg border-2 font-medium transition-all flex items-center gap-2"
                    :class="selectedFormat === 'CSV' ? 'border-foreground bg-muted' : 'border-border hover:border-muted-foreground'">
                <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                CSV File
            </button>
            <button type="button" @click="selectedFormat = 'JSON'"
                    class="px-4 py-2 rounded-lg border-2 font-medium transition-all flex items-center gap-2"
                    :class="selectedFormat === 'JSON' ? 'border-foreground bg-muted' : 'border-border hover:border-muted-foreground'">
                <i data-lucide="braces" class="w-4 h-4"></i>
                JSON Data
            </button>
        </div>

        <div class="mt-6 p-4 rounded-lg bg-muted" x-show="selectedFormat === 'PDF'">
            <div class="flex items-start gap-3">
                <i data-lucide="info" class="w-5 h-5 text-muted-foreground mt-0.5"></i>
                <div>
                    <p class="text-sm font-medium">PDF reports include:</p>
                    <ul class="text-sm text-muted-foreground mt-1 space-y-1">
                        <li>• Cover page with organization logo</li>
                        <li>• Professional formatting and styling</li>
                        <li>• Summary statistics and charts</li>
                        <li>• Page numbers and generation timestamp</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div x-show="error" x-cloak class="rounded-lg bg-red-500/10 border border-red-500/20 p-4 text-sm text-red-500">
        <span x-text="error"></span>
    </div>

    <div x-show="success" x-cloak class="rounded-lg bg-emerald-500/10 border border-emerald-500/20 p-4 text-sm text-emerald-500">
        <span x-text="success"></span>
    </div>

    <form method="post" action="{% url 'reports:export_generate' event.organization.slug event.slug %}"
          @submit="generating = true" x-show="selectedType" x-cloak hx-boost="false">
        {% csrf_token %}
        <input type="hidden" name="report_type" :value="selectedType">
        <input type="hidden" name="format" :value="selectedFormat">

        <div class="flex items-center gap-4">
            {% #button type="submit" variant="default" attrs=':disabled="generating"' %}
                <i x-show="!generating" data-lucide="download" class="w-4 h-4"></i>
                <i x-show="generating" x-cloak data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                <span x-text="generating ? 'Generating...' : 'Generate & Download'"></span>
            {% /button %}
            {% #button type="button" variant="outline" attrs="@click=\"selectedType = ''; selectedFormat = 'PDF'\"" %}
                Reset Selection
            {% /button %}
        </div>
    </form>

    {% if recent_exports %}
    <div class="card p-6">
        <h2 class="text-lg font-semibold mb-4">Recent Exports</h2>
        <div class="space-y-3">
            {% for export in recent_exports %}
            <div class="flex items-center justify-between py-3 border-b border-border last:border-0">
                <div class="flex items-center gap-3">
                    <div class="h-8 w-8 rounded-lg bg-muted flex items-center justify-center">
                        {% if export.format == 'PDF' %}
                        <i data-lucide="file-text" class="h-4 w-4 text-red-500"></i>
                        {% elif export.format == 'EXCEL' %}
                        <i data-lucide="table" class="h-4 w-4 text-green-500"></i>
                        {% else %}
                        <i data-lucide="file-spreadsheet" class="h-4 w-4 text-blue-500"></i>
                        {% endif %}
                    </div>
                    <div>
                        <p class="text-sm font-medium">{{ export.get_report_type_display }}</p>
                        <p class="text-xs text-muted-foreground">{{ export.created_at|date:"M j, Y g:i A" }}</p>
                    </div>
                </div>
                <a href="{% url 'reports:download' export.reference %}" hx-boost="false">
                    {% #button variant="outline" size="sm" %}
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Download
                    {% /button %}
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
