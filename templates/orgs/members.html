{% extends 'layouts/dashboard.html' %}
{% load slippers i18n %}

{% block title %}{% trans "Team Members" %} - {{ organization.name }} - Reckot{% endblock %}

{% block header_title %}
<div class="min-w-0">
    <h1 class="text-lg font-semibold truncate">{% trans "Team Members" %}</h1>
    <p class="text-sm text-muted-foreground hidden md:block">{{ organization.name }}</p>
</div>
{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-2">
    <a href="{% url 'orgs:detail' organization.slug %}">
        {% #button variant="outline" size="sm" %}
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            {% trans "Back" %}
        {% /button %}
    </a>
    <a href="{% url 'orgs:bulk_invite' organization.slug %}">
        {% #button variant="outline" size="sm" %}
            <i data-lucide="users" class="w-4 h-4"></i>
            {% trans "Bulk Import" %}
        {% /button %}
    </a>
    <a href="{% url 'orgs:invite_member' organization.slug %}">
        {% #button variant="default" size="sm" %}
            <i data-lucide="user-plus" class="w-4 h-4"></i>
            {% trans "Invite" %}
        {% /button %}
    </a>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="card">
        <div class="p-4 border-b border-border">
            <h2 class="font-semibold">{% blocktrans with count=memberships.count %}Members ({{ count }}){% endblocktrans %}</h2>
        </div>
        <div class="divide-y divide-border">
            {% for membership in memberships %}
            <div class="p-4 flex items-center justify-between gap-4" x-data="{ showRoleMenu: false }">
                <div class="flex items-center gap-3 min-w-0">
                    <div class="h-10 w-10 rounded-full bg-muted flex items-center justify-center shrink-0">
                        <span class="text-sm font-medium">{{ membership.user.email|slice:":1"|upper }}</span>
                    </div>
                    <div class="min-w-0">
                        <p class="font-medium truncate">
                            {{ membership.user.get_full_name|default:membership.user.email }}
                            {% if membership.user == request.user %}
                            <span class="text-xs text-muted-foreground">({% trans "you" %})</span>
                            {% endif %}
                        </p>
                        <p class="text-sm text-muted-foreground truncate">{{ membership.user.email }}</p>
                    </div>
                </div>

                <div class="flex items-center gap-2 shrink-0">
                    {% if membership.role == 'OWNER' %}
                    {% #badge variant="default" %}{% trans "Owner" %}{% /badge %}
                    {% elif membership.role == 'ADMIN' %}
                    {% #badge variant="secondary" %}{% trans "Admin" %}{% /badge %}
                    {% elif membership.role == 'MANAGER' %}
                    {% #badge %}{% trans "Manager" %}{% /badge %}
                    {% elif membership.role == 'MEMBER' %}
                    {% #badge %}{% trans "Member" %}{% /badge %}
                    {% else %}
                    {% #badge %}{% trans "Viewer" %}{% /badge %}
                    {% endif %}

                    {% if membership.role != 'OWNER' and membership.user != request.user %}
                    <div class="relative">
                        <button @click="showRoleMenu = !showRoleMenu"
                                @click.outside="showRoleMenu = false"
                                class="p-2 hover:bg-muted rounded-lg transition-colors">
                            <i data-lucide="more-vertical" class="w-4 h-4"></i>
                        </button>

                        <div x-show="showRoleMenu"
                             x-transition
                             class="absolute right-0 mt-1 w-48 rounded-lg border border-border bg-card shadow-lg z-10"
                             x-cloak>
                            <div class="p-1">
                                <p class="px-3 py-2 text-xs font-medium text-muted-foreground">{% trans "Change Role" %}</p>
                                {% for role_value, role_label in roles %}
                                {% if role_value != 'OWNER' %}
                                <form method="post" action="{% url 'orgs:update_member_role' organization.slug membership.user.id %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="role" value="{{ role_value }}">
                                    <button type="submit"
                                            class="w-full px-3 py-2 text-sm text-left hover:bg-muted rounded-md flex items-center justify-between"
                                            {% if membership.role == role_value %}disabled{% endif %}>
                                        {{ role_label }}
                                        {% if membership.role == role_value %}
                                        <i data-lucide="check" class="w-4 h-4"></i>
                                        {% endif %}
                                    </button>
                                </form>
                                {% endif %}
                                {% endfor %}
                                <div class="h-px bg-border my-1"></div>
                                <form method="post" action="{% url 'orgs:remove_member' organization.slug membership.user.id %}"
                                      onsubmit="return confirm('{% trans "Remove this member from the organization?" %}')">
                                    {% csrf_token %}
                                    <button type="submit" class="w-full px-3 py-2 text-sm text-left text-red-500 hover:bg-red-500/10 rounded-md">
                                        {% trans "Remove from organization" %}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="p-8 text-center text-muted-foreground">
                {% trans "No members found." %}
            </div>
            {% endfor %}
        </div>
    </div>

    {% if pending_invitations %}
    <div class="card">
        <div class="p-4 border-b border-border">
            <h2 class="font-semibold">{% blocktrans with count=pending_invitations.count %}Pending Invitations ({{ count }}){% endblocktrans %}</h2>
        </div>
        <div class="divide-y divide-border">
            {% for invitation in pending_invitations %}
            <div class="p-4 flex items-center justify-between gap-4">
                <div class="flex items-center gap-3 min-w-0">
                    <div class="h-10 w-10 rounded-full bg-muted flex items-center justify-center shrink-0">
                        <i data-lucide="mail" class="w-5 h-5 text-muted-foreground"></i>
                    </div>
                    <div class="min-w-0">
                        <p class="font-medium truncate">{{ invitation.email }}</p>
                        <p class="text-sm text-muted-foreground">
                            {% blocktrans with role=invitation.get_role_display time=invitation.created_at|timesince %}Invited as {{ role }} - {{ time }} ago{% endblocktrans %}
                        </p>
                    </div>
                </div>

                <div class="flex items-center gap-2 shrink-0">
                    {% #badge variant="warning" %}{% trans "Pending" %}{% /badge %}

                    <form method="post" action="{% url 'orgs:resend_invitation' organization.slug invitation.id %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="p-2 hover:bg-muted rounded-lg transition-colors" title="{% trans "Resend invitation" %}">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </form>

                    <form method="post" action="{% url 'orgs:cancel_invitation' organization.slug invitation.id %}" class="inline"
                          onsubmit="return confirm('{% trans "Cancel this invitation?" %}')">
                        {% csrf_token %}
                        <button type="submit" class="p-2 hover:bg-red-500/10 text-red-500 rounded-lg transition-colors" title="{% trans "Cancel invitation" %}">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="card p-6">
        <h3 class="font-semibold mb-4">{% trans "Role Permissions" %}</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-border">
                        <th class="text-left py-2 pr-4 font-medium">{% trans "Permission" %}</th>
                        <th class="text-center py-2 px-2 font-medium">{% trans "Owner" %}</th>
                        <th class="text-center py-2 px-2 font-medium">{% trans "Admin" %}</th>
                        <th class="text-center py-2 px-2 font-medium">{% trans "Manager" %}</th>
                        <th class="text-center py-2 px-2 font-medium">{% trans "Member" %}</th>
                        <th class="text-center py-2 px-2 font-medium">{% trans "Viewer" %}</th>
                    </tr>
                </thead>
                <tbody class="text-muted-foreground">
                    <tr class="border-b border-border">
                        <td class="py-2 pr-4">{% trans "Manage organization settings" %}</td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="minus" class="w-4 h-4 mx-auto"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="minus" class="w-4 h-4 mx-auto"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="minus" class="w-4 h-4 mx-auto"></i></td>
                    </tr>
                    <tr class="border-b border-border">
                        <td class="py-2 pr-4">{% trans "Invite & remove members" %}</td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="minus" class="w-4 h-4 mx-auto"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="minus" class="w-4 h-4 mx-auto"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="minus" class="w-4 h-4 mx-auto"></i></td>
                    </tr>
                    <tr class="border-b border-border">
                        <td class="py-2 pr-4">{% trans "Create & edit events" %}</td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="minus" class="w-4 h-4 mx-auto"></i></td>
                    </tr>
                    <tr class="border-b border-border">
                        <td class="py-2 pr-4">{% trans "Publish & delete events" %}</td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="minus" class="w-4 h-4 mx-auto"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="minus" class="w-4 h-4 mx-auto"></i></td>
                    </tr>
                    <tr class="border-b border-border">
                        <td class="py-2 pr-4">{% trans "Manage tickets & check-in" %}</td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="minus" class="w-4 h-4 mx-auto"></i></td>
                    </tr>
                    <tr class="border-b border-border">
                        <td class="py-2 pr-4">{% trans "View reports & analytics" %}</td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                    </tr>
                    <tr>
                        <td class="py-2 pr-4">{% trans "Manage payments & refunds" %}</td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="check" class="w-4 h-4 mx-auto text-emerald-500"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="minus" class="w-4 h-4 mx-auto"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="minus" class="w-4 h-4 mx-auto"></i></td>
                        <td class="text-center py-2 px-2"><i data-lucide="minus" class="w-4 h-4 mx-auto"></i></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
