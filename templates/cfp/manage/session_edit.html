{% extends "layouts/dashboard.html" %}
{% load slippers i18n %}

{% block title %}{% trans "Edit Session" %} - {{ session.title }} - Reckot{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block breadcrumbs %}
{% #breadcrumb class="mb-4" %}
    {% #breadcrumb_item href="/" %}{% trans "Home" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item href="/events/" %}{% trans "Events" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item %}{{ event.title|truncatewords:3 }}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item href="{% url 'cfp:schedule_builder' event.organization.slug event.slug %}" %}{% trans "Schedule" %}{% /breadcrumb_item %}
    {% #breadcrumb_separator %}{% /breadcrumb_separator %}
    {% #breadcrumb_item %}{% trans "Edit session" %}{% /breadcrumb_item %}
{% /breadcrumb %}
{% endblock %}

{% block header_title %}
<div class="min-w-0">
    <h1 class="text-lg font-semibold truncate">{% trans "Edit Session" %}</h1>
    <p class="text-sm text-muted-foreground hidden md:block">{{ event.title }}</p>
</div>
{% endblock %}

{% block header_actions %}
<a href="{% url 'cfp:schedule_builder' event.organization.slug event.slug %}">
    {% #button variant="ghost" size="sm" %}
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        <span class="hidden md:inline">{% trans "Back to schedule" %}</span>
    {% /button %}
</a>
{% endblock %}

{% block content %}
<div class="max-w-3xl space-y-6">
    {% if session.proposal %}
    {% #card %}
        <div class="flex items-center gap-3 mb-3">
            <div class="h-9 w-9 rounded-lg bg-purple-500/10 flex items-center justify-center shrink-0">
                <i data-lucide="file-text" class="w-4 h-4 text-purple-500"></i>
            </div>
            <div>
                <h3 class="text-sm font-medium text-muted-foreground">{% trans "Linked proposal" %}</h3>
                <a href="{% url 'cfp:proposal_detail' event.organization.slug event.slug session.proposal.pk %}" class="text-sm font-semibold hover:text-primary transition-colors">{{ session.proposal.title }}</a>
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            {% if session.proposal.status == "ACCEPTED" %}
            {% #badge variant="success" %}{% trans "Accepted" %}{% /badge %}
            {% elif session.proposal.status == "CONFIRMED" %}
            {% #badge variant="success" %}{% trans "Confirmed" %}{% /badge %}
            {% else %}
            {% #badge variant="outline" %}{{ session.proposal.get_status_display }}{% /badge %}
            {% endif %}
            {% if session.proposal.track %}
            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold" style="background-color: {{ session.proposal.track.color }}20; color: {{ session.proposal.track.color }};">{{ session.proposal.track.name }}</span>
            {% endif %}
            {% if session.proposal.session_format %}
            <span class="text-xs text-muted-foreground">{{ session.proposal.session_format.name }}</span>
            {% endif %}
        </div>
    {% /card %}
    {% endif %}

    {% #card %}
        <div class="flex items-start gap-4 mb-6">
            {% if session.speaker.get_profile_image_url %}
            <img src="{{ session.speaker.get_profile_image_url }}" alt="{{ session.speaker.get_full_name }}" class="h-12 w-12 rounded-full object-cover shrink-0">
            {% else %}
            <div class="h-12 w-12 rounded-full bg-muted flex items-center justify-center shrink-0">
                <span class="text-base font-semibold">{{ session.speaker.email|slice:":1"|upper }}</span>
            </div>
            {% endif %}
            <div class="min-w-0">
                <h3 class="text-sm font-medium text-muted-foreground">{% trans "Speaker" %}</h3>
                <p class="text-base font-semibold">{{ session.speaker.get_full_name|default:session.speaker.email }}</p>
                <p class="text-sm text-muted-foreground">{{ session.speaker.email }}</p>
            </div>
        </div>
    {% /card %}

    {% #card %}
        <h2 class="text-lg font-semibold mb-6">{% trans "Session details" %}</h2>
        <form method="post" class="space-y-6">
            {% csrf_token %}

            {% #form_field label=_("Title") name="title" required=True %}
                {% #input type="text" name="title" id="title" value=form.title.value required=True %}{% /input %}
                {% if form.title.errors %}
                <p class="text-sm text-destructive mt-1">{{ form.title.errors.0 }}</p>
                {% endif %}
            {% /form_field %}

            {% #form_field label=_("Description") name="description" %}
                {% #textarea name="description" id="description" rows="4" %}{{ form.description.value|default:"" }}{% /textarea %}
                {% if form.description.errors %}
                <p class="text-sm text-destructive mt-1">{{ form.description.errors.0 }}</p>
                {% endif %}
            {% /form_field %}

            <div class="grid gap-4 sm:grid-cols-2">
                {% #form_field label=_("Track") name="track" %}
                    <div class="custom-select-wrapper" data-controller="dropdown" data-dropdown-value-value="{{ form.track.value|default:'' }}" data-action="click@window->dropdown#clickOutside">
                        <input type="hidden" name="track" value="{{ form.track.value|default:'' }}" data-dropdown-target="hiddenInput">
                        <button type="button" data-dropdown-target="trigger" data-action="click->dropdown#toggle" class="custom-select-trigger">
                            <span class="custom-select-value">{% for track in event.tracks.all %}{% if form.track.value|stringformat:"d" == track.pk|stringformat:"d" %}{{ track.name }}{% endif %}{% endfor %}{% if not form.track.value %}{% trans "No track" %}{% endif %}</span>
                            <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4"></i>
                        </button>
                        <div data-dropdown-target="dropdown" class="custom-select-dropdown hidden">
                            <div class="custom-select-options">
                                <button type="button" data-dropdown-target="option" data-value="" data-label="{% trans 'No track' %}" data-action="click->dropdown#selectOption" class="custom-select-option{% if not form.track.value %} custom-select-option-selected{% endif %}">
                                    <span>{% trans "No track" %}</span>
                                    <i data-lucide="check" class="custom-select-check w-4 h-4 {% if form.track.value %}hidden{% endif %}"></i>
                                </button>
                                {% for track in event.tracks.all %}
                                <button type="button" data-dropdown-target="option" data-value="{{ track.pk }}" data-label="{{ track.name }}" data-action="click->dropdown#selectOption" class="custom-select-option{% if form.track.value|stringformat:'d' == track.pk|stringformat:'d' %} custom-select-option-selected{% endif %}">
                                    <span>{{ track.name }}</span>
                                    <i data-lucide="check" class="custom-select-check w-4 h-4 {% if form.track.value|stringformat:'d' != track.pk|stringformat:'d' %}hidden{% endif %}"></i>
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% if form.track.errors %}
                    <p class="text-sm text-destructive mt-1">{{ form.track.errors.0 }}</p>
                    {% endif %}
                {% /form_field %}

                {% #form_field label=_("Room") name="room" %}
                    {% #input type="text" name="room" id="room" value=form.room.value placeholder=_("e.g. Main hall, Room A") %}{% /input %}
                    {% if form.room.errors %}
                    <p class="text-sm text-destructive mt-1">{{ form.room.errors.0 }}</p>
                    {% endif %}
                {% /form_field %}
            </div>

            <div class="grid gap-4 sm:grid-cols-2">
                {% #form_field label=_("Starts at") name="starts_at" %}
                    <div class="relative">
                        <div class="absolute left-3.5 top-1/2 -translate-y-1/2 pointer-events-none text-muted-foreground z-10">
                            <i data-lucide="calendar-clock" class="w-4 h-4"></i>
                        </div>
                        <input type="text" name="starts_at" id="starts_at"
                               {% if form.starts_at.value %}value="{{ form.starts_at.value }}"{% endif %}
                               placeholder="{% trans "Select date and time" %}"
                               class="input w-full pl-12 cursor-pointer"
                               data-controller="datepicker"
                               data-datepicker-enable-time-value="true"
                               readonly>
                    </div>
                    {% if form.starts_at.errors %}
                    <p class="text-sm text-destructive mt-1">{{ form.starts_at.errors.0 }}</p>
                    {% endif %}
                {% /form_field %}

                {% #form_field label=_("Ends at") name="ends_at" %}
                    <div class="relative">
                        <div class="absolute left-3.5 top-1/2 -translate-y-1/2 pointer-events-none text-muted-foreground z-10">
                            <i data-lucide="calendar-clock" class="w-4 h-4"></i>
                        </div>
                        <input type="text" name="ends_at" id="ends_at"
                               {% if form.ends_at.value %}value="{{ form.ends_at.value }}"{% endif %}
                               placeholder="{% trans "Select date and time" %}"
                               class="input w-full pl-12 cursor-pointer"
                               data-controller="datepicker"
                               data-datepicker-enable-time-value="true"
                               readonly>
                    </div>
                    {% if form.ends_at.errors %}
                    <p class="text-sm text-destructive mt-1">{{ form.ends_at.errors.0 }}</p>
                    {% endif %}
                {% /form_field %}
            </div>

            {% #form_field label=_("Status") name="status" required=True %}
                <div class="custom-select-wrapper" data-controller="dropdown" data-dropdown-value-value="{{ form.status.value|default:'DRAFT' }}" data-action="click@window->dropdown#clickOutside">
                    <input type="hidden" name="status" value="{{ form.status.value|default:'DRAFT' }}" data-dropdown-target="hiddenInput" required>
                    <button type="button" data-dropdown-target="trigger" data-action="click->dropdown#toggle" class="custom-select-trigger">
                        <span class="custom-select-value">{% if form.status.value == "SCHEDULED" %}{% trans "Scheduled" %}{% elif form.status.value == "CANCELLED" %}{% trans "Cancelled" %}{% else %}{% trans "Draft" %}{% endif %}</span>
                        <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4"></i>
                    </button>
                    <div data-dropdown-target="dropdown" class="custom-select-dropdown hidden">
                        <div class="custom-select-options">
                            <button type="button" data-dropdown-target="option" data-value="DRAFT" data-label="{% trans 'Draft' %}" data-action="click->dropdown#selectOption" class="custom-select-option{% if form.status.value == 'DRAFT' or not form.status.value %} custom-select-option-selected{% endif %}">
                                <span>{% trans "Draft" %}</span>
                                <i data-lucide="check" class="custom-select-check w-4 h-4 {% if form.status.value != 'DRAFT' and form.status.value %}hidden{% endif %}"></i>
                            </button>
                            <button type="button" data-dropdown-target="option" data-value="SCHEDULED" data-label="{% trans 'Scheduled' %}" data-action="click->dropdown#selectOption" class="custom-select-option{% if form.status.value == 'SCHEDULED' %} custom-select-option-selected{% endif %}">
                                <span>{% trans "Scheduled" %}</span>
                                <i data-lucide="check" class="custom-select-check w-4 h-4 {% if form.status.value != 'SCHEDULED' %}hidden{% endif %}"></i>
                            </button>
                            <button type="button" data-dropdown-target="option" data-value="CANCELLED" data-label="{% trans 'Cancelled' %}" data-action="click->dropdown#selectOption" class="custom-select-option{% if form.status.value == 'CANCELLED' %} custom-select-option-selected{% endif %}">
                                <span>{% trans "Cancelled" %}</span>
                                <i data-lucide="check" class="custom-select-check w-4 h-4 {% if form.status.value != 'CANCELLED' %}hidden{% endif %}"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% if form.status.errors %}
                <p class="text-sm text-destructive mt-1">{{ form.status.errors.0 }}</p>
                {% endif %}
            {% /form_field %}

            <div class="flex items-center justify-between pt-4 border-t border-border">
                <a href="{% url 'cfp:schedule_builder' event.organization.slug event.slug %}">
                    {% #button variant="outline" %}
                        {% trans "Cancel" %}
                    {% /button %}
                </a>
                {% #button type="submit" variant="default" %}
                    <i data-lucide="save" class="w-4 h-4"></i>
                    {% trans "Save session" %}
                {% /button %}
            </div>
        </form>
    {% /card %}
</div>
{% endblock %}

{% block extra_scripts %}
{% include "partials/datepicker_init.html" %}
{% endblock %}
