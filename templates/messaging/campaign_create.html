{% extends "layouts/dashboard.html" %}
{% load slippers i18n %}

{% block title %}{% trans "New Campaign" %} - {{ event.title }} - Reckot{% endblock %}

{% block header_title %}
<div class="min-w-0">
    <h1 class="text-lg font-semibold truncate">{% trans "New Campaign" %}</h1>
    <p class="text-sm text-muted-foreground hidden md:block">{% trans "Send a message to" %} {{ event.title }} {% trans "attendees" %}</p>
</div>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <form method="post" class="space-y-6" x-data="{
        messageType: 'EMAIL',
        recipientFilter: 'ALL',
        showPreview: false,
        previewContent: ''
    }">
        {% csrf_token %}

        <div class="card p-6 space-y-5">
            <h2 class="font-semibold flex items-center gap-2">
                <i data-lucide="settings-2" class="w-4 h-4"></i>
                {% trans "Campaign Settings" %}
            </h2>

            <div>
                <label for="name" class="block text-sm font-medium mb-2">{% trans "Campaign Name" %}</label>
                <input type="text" name="name" id="name" required placeholder="{% trans "e.g., Event Reminder" %}"
                       class="input">
                <p class="text-xs text-muted-foreground mt-1">{% trans "Internal name to identify this campaign" %}</p>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Message Type" %}</label>
                <div class="flex p-1 bg-muted rounded-lg">
                    <button type="button" @click="messageType = 'EMAIL'"
                            class="flex-1 flex items-center justify-center gap-2 py-2 px-3 text-sm font-medium rounded-md transition-all"
                            :class="messageType === 'EMAIL' ? 'bg-background text-foreground shadow-sm' : 'text-muted-foreground'">
                        <i data-lucide="mail" class="w-4 h-4"></i>
                        {% trans "Email" %}
                    </button>
                    <button type="button" @click="messageType = 'SMS'"
                            class="flex-1 flex items-center justify-center gap-2 py-2 px-3 text-sm font-medium rounded-md transition-all"
                            :class="messageType === 'SMS' ? 'bg-background text-foreground shadow-sm' : 'text-muted-foreground'">
                        <i data-lucide="message-square" class="w-4 h-4"></i>
                        {% trans "SMS" %}
                    </button>
                </div>
                <input type="hidden" name="message_type" :value="messageType">
            </div>
        </div>

        <div class="card p-6 space-y-5">
            <h2 class="font-semibold flex items-center gap-2">
                <i data-lucide="users" class="w-4 h-4"></i>
                {% trans "Recipients" %}
            </h2>

            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Who should receive this message?" %}</label>
                <select name="recipient_filter" class="input" x-model="recipientFilter">
                    <option value="ALL">{% trans "All Attendees" %}</option>
                    <option value="TICKET_TYPE">{% trans "Specific Ticket Types" %}</option>
                    <option value="CHECKED_IN">{% trans "Checked In Only" %}</option>
                    <option value="NOT_CHECKED_IN">{% trans "Not Checked In" %}</option>
                </select>
            </div>

            <div x-show="recipientFilter === 'TICKET_TYPE'" x-cloak class="space-y-3">
                <label class="block text-sm font-medium">{% trans "Select Ticket Types" %}</label>
                {% for tt in ticket_types %}
                <label class="flex items-center gap-3 p-3 rounded-lg border border-border hover:bg-muted/50 cursor-pointer">
                    <input type="checkbox" name="ticket_types" value="{{ tt.id }}" class="h-4 w-4 rounded border-border">
                    <span class="font-medium text-sm">{{ tt.name }}</span>
                    <span class="text-xs text-muted-foreground ml-auto">{{ tt.price|floatformat:0 }} XAF</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="card p-6 space-y-5">
            <h2 class="font-semibold flex items-center gap-2">
                <i data-lucide="pen-line" class="w-4 h-4"></i>
                {% trans "Message Content" %}
            </h2>

            {% if templates %}
            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Use Template (optional)" %}</label>
                <select class="input" @change="if($event.target.value) {
                    const tpl = JSON.parse($event.target.selectedOptions[0].dataset.template || '{}');
                    document.getElementById('subject').value = tpl.subject || '';
                    document.getElementById('body').value = tpl.body || '';
                }">
                    <option value="">{% trans "Choose a template..." %}</option>
                    {% for tpl in templates %}
                    <option value="{{ tpl.id }}" data-template='{"subject":"{{ tpl.subject|escapejs }}","body":"{{ tpl.body|escapejs }}"}'>
                        {{ tpl.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div x-show="messageType === 'EMAIL'">
                <label for="subject" class="block text-sm font-medium mb-2">{% trans "Subject" %}</label>
                <input type="text" name="subject" id="subject" placeholder="{% trans "Your message subject" %}"
                       class="input">
            </div>

            <div>
                <label for="body" class="block text-sm font-medium mb-2">{% trans "Message" %}</label>
                <textarea name="body" id="body" rows="8" required
                          placeholder="{% trans "Write your message here..." %}"
                          class="input resize-none font-mono text-sm"></textarea>
                <div class="mt-2 flex items-center justify-between">
                    <p class="text-xs text-muted-foreground">
                        {% trans "Available variables:" %} <code class="px-1 py-0.5 rounded bg-muted">{{ "{{" }}name{{ "}}" }}</code>,
                        <code class="px-1 py-0.5 rounded bg-muted">{{ "{{" }}ticket_type{{ "}}" }}</code>,
                        <code class="px-1 py-0.5 rounded bg-muted">{{ "{{" }}event_name{{ "}}" }}</code>
                    </p>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-between gap-4">
            <a href="{% url 'messaging:campaign_list' org_slug=organization.slug %}">
                {% #button variant="outline" %}
                    {% trans "Cancel" %}
                {% /button %}
            </a>
            <div class="flex items-center gap-3">
                {% #button variant="outline" type="submit" attrs='name="send_now" value=""' %}
                    <i data-lucide="save" class="w-4 h-4"></i>
                    {% trans "Save Draft" %}
                {% /button %}
                {% #button variant="default" type="submit" attrs='name="send_now" value="1"' %}
                    <i data-lucide="send" class="w-4 h-4"></i>
                    {% trans "Send Now" %}
                {% /button %}
            </div>
        </div>
    </form>
</div>
{% endblock %}
