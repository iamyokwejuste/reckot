{# Custom Select Component #}
{# Usage: {% #select name="role" options=roles value="MEMBER" label="Member" placeholder="Select" %} #}
{# options: list of tuples [(value, label), ...] like Django's choices #}

<div class="custom-select-wrapper"
     x-data="{
        open: false,
        value: '{{ value|default:''|escapejs }}',
        label: '{{ label|default:''|escapejs }}',
        search: '',
        placeholder: '{{ placeholder|default:'Select an option'|escapejs }}',

        toggle() { this.open = !this.open },
        close() { this.open = false; this.search = ''; },

        selectOption(val, lbl) {
            this.value = val;
            this.label = lbl;
            this.open = false;
            this.search = '';
            if (this.$refs.hiddenInput) {
                this.$refs.hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
     }"
     @keydown.escape.window="if (open) close()">

    <input type="hidden"
           name="{{ name }}"
           x-ref="hiddenInput"
           :value="value"
           {% if required %}required{% endif %}>

    <button type="button"
            @click="toggle()"
            class="custom-select-trigger"
            :class="{ 'custom-select-trigger-active': open }">
        <span class="custom-select-value"
              :class="{ 'custom-select-placeholder': !label }"
              x-text="label || placeholder"></span>
        <i data-lucide="chevron-down" class="custom-select-chevron w-4 h-4" :class="{ 'rotate-180': open }"></i>
    </button>

    <div x-show="open"
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="opacity-0 -translate-y-1"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 -translate-y-1"
         @click.outside="close()"
         class="custom-select-dropdown"
         x-cloak>

        {% if searchable %}
        <div class="custom-select-search">
            <i data-lucide="search" class="custom-select-search-icon w-3.5 h-3.5"></i>
            <input type="text"
                   x-model="search"
                   placeholder="Search..."
                   class="custom-select-search-input"
                   @click.stop>
        </div>
        {% endif %}

        <div class="custom-select-options">
            {% for opt_value, opt_label in options %}
            <button type="button"
                    @click="selectOption('{{ opt_value|escapejs }}', '{{ opt_label|escapejs }}')"
                    x-show="!search || '{{ opt_label|lower|escapejs }}'.includes(search.toLowerCase())"
                    class="custom-select-option"
                    :class="{ 'custom-select-option-selected': value === '{{ opt_value|escapejs }}' }">
                <span>{{ opt_label }}</span>
                <i x-show="value === '{{ opt_value|escapejs }}'" data-lucide="check" class="custom-select-check w-4 h-4"></i>
            </button>
            {% empty %}
            <div class="custom-select-empty">No options available</div>
            {% endfor %}
        </div>
    </div>
</div>
