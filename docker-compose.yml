x-core-env: &core-env
  SECRET_KEY: ${SECRET_KEY}
  DEBUG: ${DEBUG:-False}
  DB_ENGINE: ${DB_ENGINE:-django.db.backends.postgresql}
  DB_NAME: ${DB_NAME:-reckot}
  DB_USER: ${DB_USER:-reckot}
  DB_PASSWORD: ${DB_PASSWORD}
  DB_HOST: ${DB_HOST}
  DB_PORT: ${DB_PORT:-5432}

x-db-env: &db-env
  AI_PUBLIC_READONLY_PASSWORD: ${AI_PUBLIC_READONLY_PASSWORD:-readonly_public_pass}
  AI_AUTH_READONLY_PASSWORD: ${AI_AUTH_READONLY_PASSWORD:-readonly_auth_pass}
  AI_ORG_READONLY_PASSWORD: ${AI_ORG_READONLY_PASSWORD:-readonly_org_pass}

x-redis-env: &redis-env
  REDIS_URL: ${REDIS_URL}
  CELERY_BROKER_URL: ${CELERY_BROKER_URL}
  CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}
  REDIS_SSL_CERT_REQS: ${REDIS_SSL_CERT_REQS:-CERT_NONE}

x-storage-env: &storage-env
  AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
  AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
  AWS_STORAGE_BUCKET_NAME: ${AWS_STORAGE_BUCKET_NAME:-}
  AWS_S3_ENDPOINT_URL: ${AWS_S3_ENDPOINT_URL:-}
  AWS_S3_REGION_NAME: ${AWS_S3_REGION_NAME:-}
  AWS_S3_USE_SSL: ${AWS_S3_USE_SSL:-True}
  AWS_S3_ADDRESSING_STYLE: ${AWS_S3_ADDRESSING_STYLE:-path}

x-email-env: &email-env
  EMAIL_BACKEND: ${EMAIL_BACKEND:-django.core.mail.backends.smtp.EmailBackend}
  EMAIL_HOST: ${EMAIL_HOST:-smtp.gmail.com}
  EMAIL_PORT: ${EMAIL_PORT:-587}
  EMAIL_USE_TLS: ${EMAIL_USE_TLS:-True}
  EMAIL_HOST_USER: ${EMAIL_HOST_USER:-}
  EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD:-}
  DEFAULT_FROM_EMAIL: ${DEFAULT_FROM_EMAIL:-}

x-payment-env: &payment-env
  PAYMENT_PRIMARY_GATEWAY: ${PAYMENT_PRIMARY_GATEWAY:-CAMPAY}
  PAYMENT_FALLBACK_GATEWAYS: ${PAYMENT_FALLBACK_GATEWAYS:-}
  PAYMENT_CALLBACK_URL: ${PAYMENT_CALLBACK_URL:-}
  DEFAULT_CURRENCY: ${DEFAULT_CURRENCY:-XAF}
  RECKOT_PLATFORM_FEE_PERCENTAGE: ${RECKOT_PLATFORM_FEE_PERCENTAGE:-7}
  CAMPAY_APP_USERNAME: ${CAMPAY_APP_USERNAME:-}
  CAMPAY_APP_PASSWORD: ${CAMPAY_APP_PASSWORD:-}
  CAMPAY_PERMANENT_TOKEN: ${CAMPAY_PERMANENT_TOKEN:-}
  CAMPAY_WEBHOOK_KEY: ${CAMPAY_WEBHOOK_KEY:-}
  CAMPAY_IS_PRODUCTION: ${CAMPAY_IS_PRODUCTION:-False}
  PAWAPAY_API_TOKEN: ${PAWAPAY_API_TOKEN:-}
  PAWAPAY_IS_PRODUCTION: ${PAWAPAY_IS_PRODUCTION:-False}
  FLUTTERWAVE_SECRET_KEY: ${FLUTTERWAVE_SECRET_KEY:-}
  FLUTTERWAVE_PUBLIC_KEY: ${FLUTTERWAVE_PUBLIC_KEY:-}
  FLUTTERWAVE_ENCRYPTION_KEY: ${FLUTTERWAVE_ENCRYPTION_KEY:-}

x-third-party-env: &third-party-env
  TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
  TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
  TWILIO_PHONE_NUMBER: ${TWILIO_PHONE_NUMBER:-}
  TWILIO_MESSAGING_SERVICE_SID: ${TWILIO_MESSAGING_SERVICE_SID:-}
  TWILIO_VERIFY_SERVICE_SID: ${TWILIO_VERIFY_SERVICE_SID:-}
  GEMINI_API_KEY: ${GEMINI_API_KEY:-}
  GEMINI_MODEL: ${GEMINI_MODEL:-gemini-1.5-flash}
  GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
  GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}

x-app-build: &app-build
  build:
    context: .
    dockerfile: docker/Dockerfile
  restart: unless-stopped

services:
  web:
    <<: *app-build
    stop_grace_period: 240s
    expose:
      - "8000"
    environment:
      <<: [*core-env, *db-env, *redis-env, *storage-env, *email-env, *payment-env, *third-party-env]
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-*}
      CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS:-}
      SITE_ID: ${SITE_ID:-1}
      ACCOUNT_EMAIL_VERIFICATION: ${ACCOUNT_EMAIL_VERIFICATION:-none}
      RUN_MIGRATIONS: "false"
      COLLECT_STATIC: "false"
      INIT_READONLY_USERS: ${INIT_READONLY_USERS:-false}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:$${PORT:-8000}/health/ || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 40s

  admin:
    <<: *app-build
    stop_grace_period: 240s
    expose:
      - "8001"
    environment:
      <<: [*core-env, *db-env, *redis-env, *storage-env, *email-env, *payment-env, *third-party-env]
      ALLOWED_HOSTS: ${ADMIN_ALLOWED_HOSTS:-*}
      CSRF_TRUSTED_ORIGINS: ${ADMIN_CSRF_TRUSTED_ORIGINS:-}
      SITE_ID: ${SITE_ID:-1}
      PORT: "8001"
      RUN_MIGRATIONS: "false"
      COLLECT_STATIC: "false"
      ADMIN_ONLY_MODE: "true"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:8001/health/ || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 40s

  celery_worker:
    <<: *app-build
    stop_grace_period: 300s
    command: celery -A reckot worker --loglevel=info --concurrency=4 -Q default,emails,payments,exports
    environment:
      <<: [*core-env, *db-env, *redis-env, *storage-env, *email-env, *payment-env, *third-party-env]
      RUN_MIGRATIONS: "false"

  celery_beat:
    <<: *app-build
    stop_grace_period: 60s
    command: celery -A reckot beat --loglevel=info --schedule=/tmp/celerybeat-schedule
    environment:
      <<: [*core-env, *db-env, *redis-env, *storage-env, *email-env, *payment-env, *third-party-env]
      RUN_MIGRATIONS: "false"
    volumes:
      - celery_beat_data:/tmp

volumes:
  celery_beat_data:
